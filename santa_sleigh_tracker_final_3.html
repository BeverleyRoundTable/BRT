<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Santa Sleigh Tracker</title>
  <link href="https://fonts.googleapis.com/css?family=Inter:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; padding: 0; font-family: 'Inter', sans-serif; background: #001; color: white; }
    body { height: 100vh; overflow: hidden; }
    #map { height: 100vh; width: 100vw; }

    .status-popup {
      position: absolute;
      top: 24px; left: 50%; transform: translateX(-50%);
      background: rgba(24,24,24,0.93);
      color: #fff;
      padding: 16px 18px 12px 18px;
      font-size: 1.25em;
      font-weight: 700;
      border-radius: 18px;
      box-shadow: 0 4px 32px #0006;
      z-index: 2000;
      text-align: center;
      min-width: 300px;
      max-width: 95vw;
      letter-spacing: 0.01em;
      line-height: 1.25;
    }

    .info-popup {
      position: fixed;
      left: 50%; transform: translateX(-50%);
      bottom: 16px;
      background: rgba(20,20,20,0.92);
      color: #fff;
      padding: 10px 12px;
      border-radius: 12px;
      box-shadow: 0 4px 28px #0006;
      z-index: 2000;
      display: inline-flex;
      gap: 12px; align-items: center; flex-wrap: wrap;
      font-size: 0.85em; font-weight: 700;
    }
    .info-popup .controls {
      display: inline-flex; gap: 12px; align-items: center; flex-wrap: nowrap; white-space: nowrap;
    }
    .muted { opacity: .9; font-weight: 600; display: none; }
    .btn { background:#0b1220; color:#fff; border:1px solid #ffffff26; border-radius: 10px; padding:6px 10px; font-size:.85em; font-weight:800; cursor:pointer }
    .btn:disabled{opacity:.7; cursor:not-allowed}

    #snow { position: fixed; inset: 0; z-index: 1000; pointer-events: none; }

    @media (max-width: 600px) {
      .status-popup { font-size: 1em; padding: 12px 10px 10px 10px; min-width: 160px; }
      .info-popup { font-size: 0.8em; bottom: 10px; gap: 8px; }
    }
  </style>
</head>
<body>
  <div class="status-popup" id="status-box">🎄 Santa is currently in Lapland preparing for Christmas!</div>

  <div class="info-popup">
    <span class="muted" id="lastUpdated">Last update: —</span>
    <span class="muted" id="age">Age: —</span>
    <span class="controls">
      <button class="btn" id="followBtn" title="Keep the map centred on Santa">Follow Santa: ON</button>
      <button class="btn" id="recenterBtn" title="Re-centre on Santa">Re-centre</button>
    </span>
  </div>

  <canvas id="snow"></canvas>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const firebaseURL = "https://santa-sleigh-tracker-4dccd-default-rtdb.europe-west1.firebasedatabase.app/location/current.json";
    const REFRESH_MS = 10_000;
    const STALE_MS   = 5 * 60_000;
    const FETCH_TIMEOUT_MS = 7_000;
    const fallbackCoords = { lat: 66.5436, lng: 25.8473 };

    const map = L.map("map").setView([fallbackCoords.lat, fallbackCoords.lng], 13);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);

    const sleighIcon = L.icon({
      iconUrl: "https://ibb.co/h19tvqNy",
      iconSize: [64, 64],
      iconAnchor: [32, 32],
      popupAnchor: [0, -32]
    });

    const marker = L.marker([fallbackCoords.lat, fallbackCoords.lng], { icon: sleighIcon })
      .addTo(map)
      .bindPopup("Santa is here!");

    const trail = L.polyline([], { weight: 3, opacity: 0.9 }).addTo(map);

    const statusBox = document.getElementById("status-box");
    const lastUpdatedEl = document.getElementById('lastUpdated');
    const ageEl = document.getElementById('age');
    const followBtn = document.getElementById('followBtn');
    const recenterBtn = document.getElementById('recenterBtn');

    const fmt = new Intl.DateTimeFormat('en-GB', {
      hour: '2-digit', minute: '2-digit', second: '2-digit',
      day: '2-digit', month: 'short', timeZone: 'Europe/London'
    });

    function setLive(){
      marker.getPopup().setContent("🎁 Santa's Current Location");
      statusBox.textContent = '🎅 Santa is out on his sleigh delivering joy!';
    }

    function setLapland(message){
      marker.getPopup().setContent(message || "🎄 GPS inactive – fallback to Lapland");
      statusBox.textContent = '🎄 Santa is currently in Lapland preparing for Christmas!';
    }

    let followSanta = true;
    followBtn.addEventListener('click', () => {
      followSanta = !followSanta;
      followBtn.textContent = `Follow Santa: ${followSanta ? 'ON' : 'OFF'}`;
      if (followSanta) map.panTo(marker.getLatLng());
    });

    map.on('dragstart zoomstart', () => {
      if (followSanta) {
        followSanta = false;
        followBtn.textContent = 'Follow Santa: OFF';
      }
    });

    recenterBtn.addEventListener('click', () => {
      map.panTo(marker.getLatLng());
      followSanta = true;
      followBtn.textContent = 'Follow Santa: ON';
    });

    function animateMarker(from, to, duration = 1000){
      const start = performance.now();
      function step(now){
        const t = Math.min(1, (now - start) / duration);
        const lat = from.lat + (to.lat - from.lat) * t;
        const lng = from.lng + (to.lng - from.lng) * t;
        marker.setLatLng([lat, lng]);
        if (followSanta) map.panTo([lat, lng], { animate: false });
        if (t < 1) requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }

    let lastPoint = L.latLng(fallbackCoords.lat, fallbackCoords.lng);
    let backoff = REFRESH_MS;

    async function updateLocation() {
      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), FETCH_TIMEOUT_MS);

      try {
        const response = await fetch(firebaseURL, { cache: 'no-store', signal: controller.signal });
        clearTimeout(timeout);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();

        const valid = data && typeof data.lat === 'number' && typeof data.lng === 'number' && typeof data.ts === 'string';
        if (!valid) throw new Error('Bad payload');

        const gpsTime = new Date(data.ts).getTime();
        const ageMs = Date.now() - gpsTime;

        if (ageMs < STALE_MS) {
          lastUpdatedEl.style.display = 'inline';
          lastUpdatedEl.textContent = `Last update: ${fmt.format(new Date(gpsTime))}`;
          ageEl.style.display = 'inline';
          ageEl.textContent = `Age: ${Math.floor(ageMs / 1000)}s`;
        } else {
          lastUpdatedEl.style.display = 'none';
          ageEl.style.display = 'none';
        }

        if (ageMs < STALE_MS) {
          const newLatLng = L.latLng(data.lat, data.lng);
          trail.addLatLng(newLatLng);
          animateMarker(lastPoint, newLatLng);
          lastPoint = newLatLng;
          setLive();
          backoff = REFRESH_MS;
          return;
        }

        goFallback('🎄 GPS inactive – fallback to Lapland');
      } catch (e) {
        clearTimeout(timeout);
        console.error("Error fetching or parsing location:", e);
        goFallback('🎄 GPS fetch failed – fallback to Lapland');
        backoff = Math.min(backoff * 1.5, 60_000);
      } finally {
        scheduleNext();
      }
    }

    function goFallback(msg){
      const next = L.latLng(fallbackCoords.lat, fallbackCoords.lng);
      animateMarker(marker.getLatLng(), next, 600);
      lastUpdatedEl.style.display = 'none';
      ageEl.style.display = 'none';
      setLapland(msg);
    }

    let timer;
    function scheduleNext(){
      clearTimeout(timer);
      timer = setTimeout(updateLocation, backoff);
    }

    // Initial boot
    setLapland();
    updateLocation();

    // Snow overlay
    const snow = document.getElementById('snow');
    const ctx = snow.getContext('2d');
    function resize(){ snow.width = window.innerWidth; snow.height = window.innerHeight; }
    window.addEventListener('resize', resize); resize();
    let flakes = Array.from({length: 120}, () => ({
      x: Math.random()*snow.width,
      y: Math.random()*snow.height,
      r: Math.random()*2 + 0.8,
      s: Math.random()*0.6 + 0.3,
      a: Math.random()*Math.PI*2
    }));
    (function drawSnow(){
      ctx.clearRect(0,0,snow.width,snow.height);
      for(const f of flakes){
        f.y += f.s; f.x += Math.sin(f.a+=0.01)*0.3;
        if(f.y>snow.height){ f.y = -5; f.x = Math.random()*snow.width; }
        ctx.globalAlpha = 0.9; ctx.beginPath(); ctx.arc(f.x,f.y,f.r,0,Math.PI*2); ctx.fillStyle = '#fff'; ctx.fill();
      }
      requestAnimationFrame(drawSnow);
    })();
  </script>
</body>
</html>
