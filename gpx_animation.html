<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Santa Sleigh GPX Animator</title>

<link rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    background: #000;
  }

  #map {
    width: 100%;
    height: 100%;
  }

  #sprite {
    position: absolute;
    width: var(--sprite-size, 128px);
    height: var(--sprite-size, 128px);
    background-image: var(--sprite-url);
    background-repeat: no-repeat;
    background-size: calc(var(--total-frames) * 100%) 100%;
    image-rendering: pixelated;
    pointer-events: none;
  }
</style>
</head>

<body>
<div id="map"></div>
<div id="sprite"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/togeojson/0.16.0/togeojson.min.js"></script>

<script>
// ------------------------------------------------------------
// URL PARAM HELPERS
// ------------------------------------------------------------
const params = new URLSearchParams(window.location.search);
const apiUrl = params.get("api") || "MISSING_API";
const routeParam = params.get("route");

// ------------------------------------------------------------
let settings = {};
let route = null;

// ------------------------------------------------------------
// LOAD SETTINGS JSON FROM GOOGLE SHEET
// ------------------------------------------------------------
async function loadSettings() {
  const res = await fetch(apiUrl);
  const json = await res.json();

  settings = json.settings;

  // find route by ?route=NAME
  if (routeParam) {
    route = json.routes.find(r => r.routeName === routeParam);
  }

  // fallback to first route
  if (!route) route = json.routes[0];

  return json;
}

// ------------------------------------------------------------
// MAP INIT
// ------------------------------------------------------------
let map = L.map("map", {
  zoomControl: false,
  attributionControl: false
});

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 20
}).addTo(map);

// ------------------------------------------------------------
// ANIMATION ENGINE
// ------------------------------------------------------------
let sprite = document.getElementById("sprite");
let gpxCoords = [];
let frame = 0;

function animateSprite() {
  const frameCount = Number(settings.travelboost_sprite_frames) || 5;
  sprite.style.backgroundPositionX = `-${(frame % frameCount) * (100 / frameCount)}%`;
  frame++;
}

// ------------------------------------------------------------
// MOVE SPRITE OVER MAP
// ------------------------------------------------------------
let idx = 0;
function moveSprite() {
  if (!gpxCoords.length) return;

  idx++;
  if (idx >= gpxCoords.length) idx = gpxCoords.length - 1;

  const latlng = gpxCoords[idx];
  const pos = map.latLngToContainerPoint(latlng);

  sprite.style.left = pos.x + "px";
  sprite.style.top = pos.y + "px";

  requestAnimationFrame(moveSprite);
}

// ------------------------------------------------------------
// LOAD GPX
// ------------------------------------------------------------
async function loadGPX(url) {
  const xml = await (await fetch(url)).text();
  const dom = new DOMParser().parseFromString(xml, "text/xml");
  const geo = toGeoJSON.gpx(dom);

  const coords = geo.features[0].geometry.coordinates.map(c => ({
    lat: c[1], lng: c[0]
  }));

  gpxCoords = coords;

  const bounds = L.latLngBounds(coords);
  map.fitBounds(bounds.pad(0.2));

  L.polyline(coords, {
    color: settings.primary_color || "#ffd700",
    weight: 6,
    opacity: 0.9
  }).addTo(map);
}

// ------------------------------------------------------------
// STARTUP
// ------------------------------------------------------------
(async function start() {
  const data = await loadSettings();

  // Configure sprite
  document.documentElement.style.setProperty("--sprite-url", `url(${settings.travelboost_sprite})`);
  document.documentElement.style.setProperty("--total-frames", settings.travelboost_sprite_frames || "5");
  document.documentElement.style.setProperty("--sprite-size", (settings.travelboost_sprite_size || 128) + "px");

  // Load GPX
  await loadGPX(route.gpxUrl);

  // Start animations
  setInterval(animateSprite, 1000 / (settings.travelboost_sprite_fps || 14));
  moveSprite();
})();
</script>

</body>
</html>
