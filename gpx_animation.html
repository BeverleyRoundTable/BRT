<script>
/* =====================================================
   PARAMS
   ===================================================== */
const PARAMS    = new URLSearchParams(location.search);
const IS_RENDER = PARAMS.has("render");
const API       = PARAMS.get("api");
const ROUTE     = PARAMS.get("route");

if (!API)   throw new Error("Missing ?api=");
if (!ROUTE) throw new Error("Missing ?route=");

let canvas = null;
let ctx = null;

function initCanvas() {
  canvas = document.getElementById("anim");
  if (!canvas) return false;
  ctx = canvas.getContext("2d");
  return true;
}

let map=null, VIEW_W=0, VIEW_H=0;

/* =====================================================
   RESIZE
   ===================================================== */
function resize(){
  if(!map) return;
  const c = map.getCanvas();
  const dpr = IS_RENDER ? 1 : (devicePixelRatio||1);
  VIEW_W = c.clientWidth;
  VIEW_H = c.clientHeight;
  canvas.width  = VIEW_W * dpr;
  canvas.height = VIEW_H * dpr;
  canvas.style.width  = VIEW_W+"px";
  canvas.style.height = VIEW_H+"px";
  ctx.setTransform(dpr,0,0,dpr,0,0);
}

/* =====================================================
   MAP STYLE
   ===================================================== */
const MAP_STYLE = "https://demotiles.maplibre.org/style.json";

/* =====================================================
   LABEL BOOST
   ===================================================== */
function boostLabels(map){
  const style = map.getStyle();
  if(!style?.layers) return;
  for(const l of style.layers){
    if(l.type!=="symbol") continue;
    if(!l.layout?.["text-field"]) continue;

    const isRoad =
      (l.id||"").toLowerCase().includes("road") ||
      (l["source-layer"]||"").toLowerCase().includes("transport");

    map.setLayoutProperty(l.id,"text-size",isRoad?22:18);
    map.setPaintProperty(l.id,"text-halo-color","rgba(255,255,255,0.92)");
    map.setPaintProperty(l.id,"text-halo-width",2.5);
    map.setPaintProperty(l.id,"text-halo-blur",0);
  }
}

/* =====================================================
   GEO MATH
   ===================================================== */
const dist=(a,b)=>{
  const R=6371000;
  const dLat=(b.lat-a.lat)*Math.PI/180;
  const dLng=(b.lng-a.lng)*Math.PI/180;
  const s=Math.sin(dLat/2)**2+
    Math.cos(a.lat*Math.PI/180)*Math.cos(b.lat*Math.PI/180)*
    Math.sin(dLng/2)**2;
  return 2*R*Math.asin(Math.sqrt(s));
};

const bearing=(a,b)=>{
  const dLng=(b.lng-a.lng)*Math.PI/180;
  const y=Math.sin(dLng)*Math.cos(b.lat*Math.PI/180);
  const x=Math.cos(a.lat*Math.PI/180)*Math.sin(b.lat*Math.PI/180)-
          Math.sin(a.lat*Math.PI/180)*Math.cos(b.lat*Math.PI/180)*Math.cos(dLng);
  return (Math.atan2(y,x)*180/Math.PI+360)%360;
};

const normalize=b=>(b%360+360)%360;
const lerpAng=(a,b,t)=>a+(((b-a+540)%360)-180)*t;

/* =====================================================
   SPRITE ROWS
   ===================================================== */
function bearingToRow(b){
  b=normalize(b);
  if(b>=337.5||b<22.5) return 0;
  if(b<67.5||b>=292.5) return 1;
  if(b<112.5||b>=247.5) return 2;
  if(b<157.5||b>=202.5) return 3;
  return 4;
}

const ROW_CENTER=[0,45,90,225,180];
const HYST=18;
const angDist=(a,b)=>Math.abs(((a-b+540)%360)-180);

function stableRow(prev,b){
  b=normalize(b);
  if(angDist(b,ROW_CENTER[prev])<HYST) return prev;
  let best=prev,bd=999;
  for(let i=0;i<ROW_CENTER.length;i++){
    const d=angDist(b,ROW_CENTER[i]);
    if(d<bd){bd=d;best=i;}
  }
  return best;
}

/* =====================================================
   LOAD DATA
   ===================================================== */
(async()=>{
  const master=await fetch(API,{cache:"no-store"}).then(r=>r.json());
  const s=master.settings||{};
  const route=(master.routes||[]).find(r=>String(r.routeName||"").toLowerCase()===ROUTE.toLowerCase());
  if(!route) throw Error("Route not found");

  const pts=await fetch(route.gpxUrl).then(r=>r.text()).then(x=>
    [...new DOMParser().parseFromString(x,"text/xml").getElementsByTagName("trkpt")]
      .map(p=>({lat:+p.getAttribute("lat"),lng:+p.getAttribute("lon")}))
  );

  const loadImg = src => new Promise(res=>{
    if(!src) return res(null);
    const i=new Image();
    i.crossOrigin="anonymous";
    i.onload=()=>res(i);
    i.onerror=()=>res(null);
    i.src=src;
  });

  const loadImg = src => new Promise(res=>{
  if(!src) return res(null);
  const i=new Image();
  i.crossOrigin="anonymous";
  i.onload=()=>res(i);
  i.onerror=()=>res(null);
  i.src=src;
});

const sprite  = await loadImg(s.travelboast_sprite);
const logo    = await loadImg(s.logo_overlay_url);
const sponsor = await loadImg(routeObj.sponsorUrl || s.sponsorUrl);

run(pts, sprite, logo, sponsor, s);

/* =====================================================
   MAIN LOOP
   ===================================================== */
function run(pts,sprite,logo,sponsor,s){
  let mapIdle=false;
  let panStartFrame=null,panFrom=null,panTo=null;
  let hideSanta=false,finished=false,panStarted=false,finishTime=0;

  map=new maplibregl.Map({
    container:"map",
    style:MAP_STYLE,
    center:[pts[0].lng,pts[0].lat],
    zoom:+s.default_map_zoom||16,
    pitch:IS_RENDER?48:52,
    fadeDuration:0
  });

  map.on("load",()=>{
  if (!initCanvas()) {
    console.error("Canvas not ready");
    return;
  }

  resize();
  map.on("resize",resize);
  map.once("idle",()=>mapIdle=true);
  boostLabels(map);

  map.addSource("route",{type:"geojson",data:{
    type:"Feature",
    geometry:{type:"LineString",coordinates:[]}
  }});

  map.addLayer({
    id:"route",
    type:"line",
    source:"route",
    paint:{
      "line-color":s.primary_color||"#d31c1c",
      "line-width":6
    }
  });

  if(!started){
    started=true;
    requestAnimationFrame(()=>requestAnimationFrame(step));
  }
});

  const FRAMES=+s.travelboast_sprite_frames||5;
  const BASE=+s.travelboast_sprite_size||72;
  const FRAME_W=sprite?sprite.width/FRAMES:0;
  const FRAME_H=sprite?sprite.height/5:0;
  const TRAVEL=+s.travelboast_speed||45;
  const PAN=IS_RENDER?10:8;
  const FPS=24;

  const cum=[0];
  for(let i=1;i<pts.length;i++) cum[i]=cum[i-1]+dist(pts[i-1],pts[i]);
  const total=cum.at(-1);

  let frame=0,sim=0,last=performance.now();
  let b=bearing(pts[0],pts[1]||pts[0]);
  let row=bearingToRow(b);

  function drawOverlay(img,pos){
    if(!img) return;
    const size=90;
    const pad=20;
    let x=pad,y=pad;

    if(pos.includes("right")) x=VIEW_W-size-pad;
    if(pos.includes("bottom")) y=VIEW_H-size-pad;

    ctx.drawImage(img,x,y,size,size);
  }

  function opposite(pos){
    return pos
      .replace("left","_").replace("right","left").replace("_","right")
      .replace("top","_").replace("bottom","top").replace("_","bottom");
  }

  const LOGO_POS = (s.logo_position||"bottom-right").toLowerCase();
  const SPONSOR_POS = opposite(LOGO_POS);

  function step(){
    if(IS_RENDER) sim=(window.__RENDER_FRAME__||0)/FPS;
    else{
      const n=performance.now();
      sim+=Math.min((n-last)/1000,1/30);
      last=n;
    }

    if(finished){
      if(IS_RENDER && panStartFrame!==null){
        const f=window.__RENDER_FRAME__-panStartFrame;
        const t=Math.min(1,f/(PAN*FPS));
        map.jumpTo({
          center:[
            panFrom.lng+(panTo.lng-panFrom.lng)*t,
            panFrom.lat+(panTo.lat-panFrom.lat)*t
          ],
          zoom:(18*(1-t)+14*t),
          pitch:(48*(1-t)),
          bearing:0,
          padding:{top:150,bottom:150,left:150,right:150}
        });
      }
      ctx.clearRect(0,0,VIEW_W,VIEW_H);
      drawOverlay(logo,LOGO_POS);
      drawOverlay(sponsor,SPONSOR_POS);
      if(IS_RENDER && sim-finishTime>=PAN){
        window.__GPX_DONE__=true; return;
      }
      requestAnimationFrame(step); return;
    }

    const t=Math.min(1,sim/TRAVEL);
    const m=t*total;
    let i=cum.findIndex(v=>v>=m); i=Math.max(1,i);
    const tt=(m-cum[i-1])/(cum[i]-cum[i-1]||1);
    const a=pts[i-1],c=pts[i];
    const pos={lat:a.lat+(c.lat-a.lat)*tt,lng:a.lng+(c.lng-a.lng)*tt};

    b=lerpAng(b,bearing(a,c),0.18);
    row=stableRow(row,b);

    map.getSource("route").setData({
      type:"Feature",
      geometry:{type:"LineString",coordinates:[
        ...pts.slice(0,i).map(p=>[p.lng,p.lat]),
        [pos.lng,pos.lat]
      ]}
    });

    map.jumpTo({center:[pos.lng,pos.lat],zoom:18,pitch:48,bearing:0});

    ctx.clearRect(0,0,VIEW_W,VIEW_H);

    const p=map.project([pos.lng,pos.lat]);
    const size=BASE;

    if(sprite && !hideSanta){
      let flip=false;
      if(row===1 && b>=292.5) flip=true;
      if(row===2 && b>=247.5) flip=true;
      if(row===3 && b<157.5) flip=true;

      ctx.save();
      ctx.translate(p.x,p.y);
      if(flip) ctx.scale(-1,1);
      ctx.drawImage(sprite,(frame%FRAMES)*FRAME_W,row*FRAME_H,FRAME_W,FRAME_H,-size/2,-size*0.85,size,size);
      ctx.restore();

      if(!window.__GPX_READY__ && (IS_RENDER||mapIdle)) window.__GPX_READY__=true;
    }

    drawOverlay(logo,LOGO_POS);
    drawOverlay(sponsor,SPONSOR_POS);

    frame++;

    if(t>=1 && !panStarted){
      hideSanta=true;
      panStarted=true;
      finishTime=sim;
      panStartFrame=window.__RENDER_FRAME__||0;
      panFrom=map.getCenter();
      panTo=new maplibregl.LngLatBounds(pts.map(p=>[p.lng,p.lat])).getCenter();
      finished=true;
    }

    requestAnimationFrame(step);
  }
}
</script>
</body>
</html>
