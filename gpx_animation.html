<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Santa Sleigh GPX Animation</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
  body, html {
    margin: 0;
    padding: 0;
    background: #0b0b0c;
    color: #fff;
    height: 100%;
  }

  #map {
    width: 100%;
    height: 100%;
  }

  .travelboost-flame {
    filter: drop-shadow(0 0 6px var(--accent));
  }
</style>
</head>
<body>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// -------------------------------------------------------
// Read URL parameters
// -------------------------------------------------------
const params = new URLSearchParams(window.location.search);
const API = params.get("api");
const ROUTE = params.get("route");

if (!API || !ROUTE) {
  document.body.innerHTML = "<h2 style='padding:20px;'>Missing api or route parameter.</h2>";
  throw new Error("Missing parameters");
}

// -------------------------------------------------------
// Fetch settings + routes from Google Sheets
// -------------------------------------------------------
async function fetchData() {
  const url = API;
  const response = await fetch(url);
  const data = await response.json();
  return data;
}

(async () => {
  const data = await fetchData();
  const settings = data.settings;
  const routes = data.routes;

  const route = routes.find(r => r.routeName === ROUTE);
  if (!route) {
    document.body.innerHTML = `<h2 style='padding:20px;'>Route not found: ${ROUTE}</h2>`;
    return;
  }

  const gpxUrl = route.gpxUrl || route.gpxurl || route.gpx || route.GPX || "";
  if (!gpxUrl) {
    document.body.innerHTML = `<h2 style='padding:20px;'>No GPX URL for route: ${ROUTE}</h2>`;
    return;
  }

  // -------------------------------------------------------
  // Setup Leaflet Map
  // -------------------------------------------------------
  const map = L.map("map", { zoomControl: false });

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
  }).addTo(map);

  // -------------------------------------------------------
  // Load and parse GPX
  // -------------------------------------------------------
  const gpxText = await fetch(gpxUrl).then(r => r.text());

  const parser = new DOMParser();
  const xml = parser.parseFromString(gpxText, "text/xml");

  const pts = [...xml.getElementsByTagName("trkpt")].map(pt => [
    parseFloat(pt.getAttribute("lat")),
    parseFloat(pt.getAttribute("lon"))
  ]);

  const poly = L.polyline(pts, {
    color: settings.travelboost_accent_color || "#d31c1c",
    weight: 5,
    opacity: 0.9
  }).addTo(map);

  map.fitBounds(poly.getBounds());

  // -------------------------------------------------------
  // Sleigh Animation Marker
  // -------------------------------------------------------
  const sleighImg = settings.travelboost_sprite || settings.sleigh_icon_live;
  const speed = Number(settings.travelboost_speed || 1);

  const sleighIcon = L.icon({
    iconUrl: sleighImg,
    iconSize: [48, 48],
    className: "travelboost-flame"
  });

  let index = 0;
  const marker = L.marker(pts[0], { icon: sleighIcon }).addTo(map);

  function animate() {
    index += speed;
    if (index >= pts.length) index = 0;
    marker.setLatLng(pts[Math.floor(index)]);
    requestAnimationFrame(animate);
  }

  animate();

})();
</script>

</body>
</html>
