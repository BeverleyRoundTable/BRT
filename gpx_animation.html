<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Santa Sleigh TravelBoost Animator</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
    html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow: hidden;
        background: #000;
        font-family: system-ui, sans-serif;
    }

    #map {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        z-index: 1;
    }

    #animCanvas {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        z-index: 10;
        pointer-events: none;
    }

    #ui-labels {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        text-align: center;
        color: white;
        z-index: 20;
        font-size: 1rem;
        text-shadow: 0 0 6px #000;
        pointer-events: none;
    }
</style>

</head>
<body>

<div id="map"></div>
<canvas id="animCanvas"></canvas>

<div id="ui-labels">
    <div id="routeName">Loading…</div>
    <div style="font-size:0.8rem;opacity:0.7;">GPX Route + TravelBoost Animation</div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* -------------------------------------------------------
   URL PARAMS
------------------------------------------------------- */
const P = new URLSearchParams(window.location.search);
const API = P.get("api");
let ROUTE = P.get("route");

if (!API) {
    document.body.innerHTML = "<h2 style='padding:20px;color:white;'>Missing ?api URL</h2>";
    throw new Error("Missing API");
}

/* -------------------------------------------------------
   GLOBALS
------------------------------------------------------- */
const canvas = document.getElementById("animCanvas");
const ctx = canvas.getContext("2d");
let W = 0, H = 0;

function resizeCanvas() {
    W = canvas.width = window.innerWidth * devicePixelRatio;
    H = canvas.height = window.innerHeight * devicePixelRatio;
    ctx.setTransform(devicePixelRatio, 0, 0, devicePixelRatio, 0, 0);
}
resizeCanvas();
window.addEventListener("resize", resizeCanvas);

/* -------------------------------------------------------
   FETCH SETTINGS + ROUTES
------------------------------------------------------- */
async function loadMaster() {
    const res = await fetch(API, { cache: "no-store" });
    if (!res.ok) throw new Error("API error");
    return res.json();
}

/* -------------------------------------------------------
   GPX PARSER
------------------------------------------------------- */
async function loadGPX(url) {
    const text = await fetch(url).then(r => r.text());
    const xml = new DOMParser().parseFromString(text, "text/xml");
    const pts = [...xml.getElementsByTagName("trkpt")];

    return pts.map(pt => ({
        lat: parseFloat(pt.getAttribute("lat")),
        lon: parseFloat(pt.getAttribute("lon"))
    }));
}

/* -------------------------------------------------------
   PROJECT GPX INTO PIXEL SPACE
------------------------------------------------------- */
function projectPath(latLngs, padding = 60) {
    let minLat = Infinity, maxLat = -Infinity;
    let minLon = Infinity, maxLon = -Infinity;

    for (const p of latLngs) {
        minLat = Math.min(minLat, p.lat);
        maxLat = Math.max(maxLat, p.lat);
        minLon = Math.min(minLon, p.lon);
        maxLon = Math.max(maxLon, p.lon);
    }

    const viewW = W / devicePixelRatio;
    const viewH = H / devicePixelRatio;

    const spanLat = maxLat - minLat || 1;
    const spanLon = maxLon - minLon || 1;

    const scaleX = (viewW - padding * 2) / spanLon;
    const scaleY = (viewH - padding * 2) / spanLat;
    const scale = Math.min(scaleX, scaleY);

    const offsetX = (viewW - scale * spanLon) / 2;
    const offsetY = (viewH - scale * spanLat) / 2;

    return latLngs.map(p => ({
        x: offsetX + (p.lon - minLon) * scale,
        y: offsetY + (maxLat - p.lat) * scale
    }));
}

/* -------------------------------------------------------
   ANIMATOR
------------------------------------------------------- */
function animatePath(path, settings, sprite) {
    const total = path.length;
    let f = 0;
    let frame = 0;
    let frameTimer = 0;

    const fps = settings.travelboost_sprite_fps || 14;
    const speed = settings.travelboost_speed || 1.4;
    const frames = settings.travelboost_sprite_frames || 5;
    const size = settings.travelboost_sprite_size || 128;

    function loop(ts) {
        ctx.clearRect(0, 0, W, H);

        // Draw glow route
        ctx.save();
        ctx.lineWidth = 6;
        ctx.strokeStyle = settings.travelboost_accent_color || settings.primary_color || "#ffd700";
        ctx.shadowColor = ctx.strokeStyle;
        ctx.shadowBlur = 20;
        ctx.beginPath();
        for (let i = 0; i < path.length; i++) {
            if (i === 0) ctx.moveTo(path[i].x, path[i].y);
            else ctx.lineTo(path[i].x, path[i].y);
        }
        ctx.stroke();
        ctx.restore();

        // Position along path
        f += speed;
        if (f >= total - 1) f = 0;

        const i = Math.floor(f);
        const frac = f - i;

        const a = path[i];
        const b = path[i + 1];
        const px = a.x + (b.x - a.x) * frac;
        const py = a.y + (b.y - a.y) * frac;

        // Animate sprite frames
        frameTimer += 1 / 60;
        if (frameTimer >= 1 / fps) {
            frameTimer = 0;
            frame = (frame + 1) % frames;
        }

        const fw = sprite.width / frames;
        const fh = sprite.height;

        ctx.drawImage(
            sprite,
            fw * frame, 0, fw, fh,
            px - size / 2, py - size / 1.3,
            size, (fh / fw) * size
        );

        requestAnimationFrame(loop);
    }

    requestAnimationFrame(loop);
}

/* -------------------------------------------------------
   MAIN
------------------------------------------------------- */
(async function start() {
    const master = await loadMaster();
    const settings = master.settings;
    let routes = master.routes;

    if (!ROUTE) ROUTE = (settings.sleigh_name || "").trim();

    let route =
        routes.find(r => r.routeName === ROUTE) ||
        routes.find(r => r.routeName.toLowerCase() === ROUTE?.toLowerCase());

    if (!route) {
        document.body.innerHTML = `<h2 style='color:white;padding:20px'>Route not found: ${ROUTE}</h2>`;
        return;
    }

    document.getElementById("routeName").textContent =
        `${route.routeName} – ${route.date || ""}`;

    const gpxPoints = await loadGPX(route.gpxUrl);

    /* ---- LEAFLET MAP ---- */
    const map = L.map("map", { zoomControl: false });
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
    L.polyline(gpxPoints, { color: settings.travelboost_accent_color || "#ffd700", weight: 4 }).addTo(map);
    map.fitBounds(gpxPoints.map(p => [p.lat, p.lon]), { padding: [40, 40] });

    /* ---- PROJECT TO CANVAS ---- */
    const path2D = projectPath(gpxPoints);

    /* ---- LOAD SPRITE ---- */
    const sprite = new Image();
    sprite.crossOrigin = "anonymous";
    sprite.src = settings.travelboost_sprite;

    sprite.onload = () => {
        animatePath(path2D, settings, sprite);
    };
})();
</script>

</body>
</html>
