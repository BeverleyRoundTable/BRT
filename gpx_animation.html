<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Santa Sleigh GPX Animation</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

<style>
  html, body {
    margin: 0; padding: 0; height: 100%; overflow: hidden;
    background: #000;
  }
  #map { position: absolute; inset: 0; z-index: 1; }
  #anim { position: absolute; inset: 0; z-index: 10; pointer-events: none; }
  #label {
    position: absolute; bottom:12px; left:50%; transform:translateX(-50%);
    z-index:20; color:white; font-family:system-ui;
    text-shadow:0 0 8px black; font-size:1rem;
  }
</style>
</head>
<body>

<div id="map"></div>
<canvas id="anim"></canvas>
<div id="label">Loading…</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ------------------------------------------------------------
   URL PARAMS
------------------------------------------------------------ */
const P = new URLSearchParams(location.search);
const API   = P.get("api");
const ROUTE = P.get("route");

if (!API) {
  document.body.innerHTML = "<h2 style='color:white;padding:20px'>Missing api= parameter</h2>";
  throw new Error("Missing API");
}

/* ------------------------------------------------------------
   CANVAS INIT
------------------------------------------------------------ */
const canvas = document.getElementById("anim");
const ctx = canvas.getContext("2d");

let W = 0, H = 0;

function resizeCanvas(){
  W = canvas.width  = window.innerWidth  * devicePixelRatio;
  H = canvas.height = window.innerHeight * devicePixelRatio;
  ctx.setTransform(devicePixelRatio, 0, 0, devicePixelRatio, 0, 0);
}

resizeCanvas();
window.addEventListener("resize", resizeCanvas);

/* ------------------------------------------------------------
   HELPERS
------------------------------------------------------------ */
async function fetchJSON(url){
  const r = await fetch(url, {cache:"no-store"});
  if (!r.ok) throw new Error("API fetch " + r.status);
  return r.json();
}

async function loadGPX(url){
  const text = await fetch(url, {cache:"no-store"}).then(r => r.text());
  const xml  = new DOMParser().parseFromString(text, "text/xml");
  const pts  = [...xml.getElementsByTagName("trkpt")];
  return pts.map(p => ({
    lat: parseFloat(p.getAttribute("lat")),
    lon: parseFloat(p.getAttribute("lon"))
  }));
}

/* ------------------------------------------------------------
   MAIN
------------------------------------------------------------ */
(async function main(){

  /* FETCH MASTER JSON */
  const master = await fetchJSON(API);
  const settings = master.settings;
  const routes   = master.routes;

  /* MATCH ROUTE */
  const route = routes.find(r =>
       (r.routeName || "").toLowerCase() === ROUTE.toLowerCase()
  );

  if (!route){
    document.body.innerHTML =
      "<h2 style='color:white;padding:20px'>Route not found: "+ROUTE+"</h2>";
    return;
  }

  document.getElementById("label").textContent =
    `${route.routeName} – ${route.date || ""}`;

  /* --------------------------------------------------------
     LEAFLET MAP
  -------------------------------------------------------- */
  const map = L.map("map", { zoomControl:false });

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom:19
  }).addTo(map);

  /* --------------------------------------------------------
     LOAD GPX + DRAW BASELINE (FAINT)
  -------------------------------------------------------- */
  const gpx = await loadGPX(route.gpxUrl);

  map.fitBounds(gpx.map(p => [p.lat, p.lon]), { padding:[40,40] });

  /* faint base grey route */
  L.polyline(gpx, { color:"#555", weight:3, opacity:0.25 }).addTo(map);

  /* --------------------------------------------------------
     PROJECT GPX → PIXELS EACH FRAME
     (We do NOT pre-project because map pans/zooms)
  -------------------------------------------------------- */

  function projectToXY(lat, lon){
    const point = map.latLngToContainerPoint([lat, lon]);
    return { x: point.x, y: point.y };
  }

  /* --------------------------------------------------------
     LOAD SPRITE
  -------------------------------------------------------- */
  const spriteURL = settings.travelboost_sprite;
  const frames    = Number(settings.travelboost_sprite_frames || 5);
  const fps       = Number(settings.travelboost_sprite_fps    || 14);
  const size      = Number(settings.travelboost_sprite_size   || 128);
  const speed     = Number(settings.travelboost_speed         || 1.2);

  const accent    = settings.travelboost_accent_color || "#ffd700";

  const sprite = new Image();
  sprite.crossOrigin = "anonymous";
  sprite.src = spriteURL;

  sprite.onload = () => startAnimation();

  /* --------------------------------------------------------
     ANIMATION LOOP
  -------------------------------------------------------- */
  function startAnimation(){

    let posF = 0;           // floating index along GPX
    let frameIdx = 0;
    let frameTimer = 0;

    function animate(){
      ctx.clearRect(0,0,W,H);

      /* ---- progress along GPX ---- */
      posF += speed;
      if (posF >= gpx.length - 1) posF = 0;   // loop

      const i  = Math.floor(posF);
      const t  = posF - i;

      const A = gpx[i];
      const B = gpx[i+1];

      /* interpolate lat/lon */
      const lat = A.lat + (B.lat - A.lat)*t;
      const lon = A.lon + (B.lon - A.lon)*t;

      /* project to screen */
      const pA = projectToXY(A.lat, A.lon);
      const pB = projectToXY(lat, lon);

      /* glowing trailing line */
      ctx.save();
      ctx.lineWidth = 6;
      ctx.strokeStyle = accent;
      ctx.shadowColor = accent;
      ctx.shadowBlur  = 22;
      ctx.beginPath();

      for (let j = 0; j <= i; j++){
        const p = projectToXY(gpx[j].lat, gpx[j].lon);
        if (j === 0) ctx.moveTo(p.x, p.y);
        else ctx.lineTo(p.x, p.y);
      }
      ctx.lineTo(pB.x, pB.y);
      ctx.stroke();
      ctx.restore();

      /* determine rotation */
      const dx = pB.x - pA.x;
      const dy = pB.y - pA.y;
      const angle = Math.atan2(dy, dx);

      /* sprite frame update */
      frameTimer += 1/60;
      if (frameTimer >= 1/fps){
        frameIdx = (frameIdx + 1) % frames;
        frameTimer = 0;
      }

      /* draw rotated sprite aligned to GPX point */
      const fw = sprite.width / frames;
      const fh = sprite.height;

      /* PERFECT ANCHORING (sleigh rails on line) */
      const anchorX = size * 0.50;  // horizontal centre
      const anchorY = size * 0.62;  // calibrated anchor

      ctx.save();
      ctx.translate(pB.x, pB.y);
      ctx.rotate(angle);

      ctx.drawImage(
        sprite,
        fw * frameIdx, 0, fw, fh,   // frame source
        -anchorX, -anchorY,         // corrected anchor
        size, (fh/fw)*size          // draw size
      );

      ctx.restore();

      requestAnimationFrame(animate);
    }

    animate();
  }

})();
</script>

</body>
</html>
