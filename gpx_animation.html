<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Santa Sleigh GPX Animator</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
  html, body {
    margin: 0; padding: 0; height: 100%; overflow: hidden; background: #000;
  }
  #map { position: absolute; inset: 0; z-index: 1; }
  #anim { position: absolute; inset: 0; z-index: 10; pointer-events: none; }
  #label {
    position: absolute;
    bottom: 12px; left: 50%;
    transform: translateX(-50%);
    z-index: 20;
    color: white;
    font-family: system-ui, sans-serif;
    font-size: 1rem;
    text-shadow: 0 0 8px black;
  }
</style>
</head>
<body>

<div id="map"></div>
<canvas id="anim"></canvas>
<div id="label">Loading…</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ---------------------------------------------------
   URL PARAMS
--------------------------------------------------- */
const P = new URLSearchParams(location.search);
const API = P.get("api");
const ROUTE = P.get("route");

if (!API) {
  document.body.innerHTML = "<h2 style='color:white;padding:20px'>Missing api= parameter</h2>";
  throw new Error("Missing API");
}

/* ---------------------------------------------------
   CANVAS SETUP
--------------------------------------------------- */
const canvas = document.getElementById("anim");
const ctx = canvas.getContext("2d");
let W = 0, H = 0;

function resizeCanvas() {
  W = canvas.width = window.innerWidth * devicePixelRatio;
  H = canvas.height = window.innerHeight * devicePixelRatio;
  ctx.setTransform(devicePixelRatio, 0, 0, devicePixelRatio, 0, 0);
}
resizeCanvas();
window.addEventListener("resize", resizeCanvas);

/* ---------------------------------------------------
   HELPERS
--------------------------------------------------- */
async function fetchJSON(url) {
  const r = await fetch(url, {cache:"no-store"});
  if (!r.ok) throw new Error("API fetch error "+r.status);
  return r.json();
}

async function loadGPX(url) {
  const xml = await (await fetch(url)).text();
  const dom = new DOMParser().parseFromString(xml, "text/xml");
  const pts = [...dom.getElementsByTagName("trkpt")];
  return pts.map(p => ({
    lat: parseFloat(p.getAttribute("lat")),
    lon: parseFloat(p.getAttribute("lon"))
  }));
}

/* ---------------------------------------------------
   PROJECTION USING LEAFLET
--------------------------------------------------- */
function projectPathToMap(latLngPoints, map) {
  return latLngPoints.map(p => {
    const pt = map.latLngToContainerPoint([p.lat, p.lon]);
    return { x: pt.x, y: pt.y };
  });
}

/* ---------------------------------------------------
   MAIN ANIMATION LOOP
--------------------------------------------------- */
function animate(path2d, sprite, settings) {
  const fps = Number(settings.travelboost_sprite_fps) || 14;
  const frames = Number(settings.travelboost_sprite_frames) || 5;
  const size = Number(settings.travelboost_sprite_size) || 128;
  const speed = Number(settings.travelboost_speed) || 1.4;
  const accent = settings.travelboost_accent_color || "#ffd700";

  let posF = 0;
  let frameIdx = 0;
  let frameTimer = 0;

  function loop() {
    ctx.clearRect(0, 0, W, H);

    if (path2d.length < 2) return requestAnimationFrame(loop);

    // Progress along route
    posF += speed;
    if (posF >= path2d.length - 1) posF = path2d.length - 1;

    const i = Math.floor(posF);
    const t = posF - i;
    const a = path2d[i];
    const b = path2d[i + 1];
    const px = a.x + (b.x - a.x) * t;
    const py = a.y + (b.y - a.y) * t;

    // Draw glowing progressive trail
    ctx.save();
    ctx.lineWidth = 6;
    ctx.strokeStyle = accent;
    ctx.shadowColor = accent;
    ctx.shadowBlur = 20;
    ctx.beginPath();
    for (let j = 0; j <= i; j++) {
      if (j === 0) ctx.moveTo(path2d[j].x, path2d[j].y);
      else ctx.lineTo(path2d[j].x, path2d[j].y);
    }
    ctx.lineTo(px, py);
    ctx.stroke();
    ctx.restore();

    // Animate sprite frames
    frameTimer += 1/60;
    if (frameTimer >= 1/fps) {
      frameTimer = 0;
      frameIdx = (frameIdx + 1) % frames;
    }

    const fw = sprite.width / frames;
    const fh = sprite.height;

    ctx.drawImage(
      sprite,
      fw * frameIdx, 0, fw, fh,
      px - size/2, py - size*0.9,
      size, (fh/fw) * size
    );

    requestAnimationFrame(loop);
  }

  loop();
}

/* ---------------------------------------------------
   MAIN
--------------------------------------------------- */
(async function main() {
  const master = await fetchJSON(API);
  const settings = master.settings;
  const routes = master.routes;

  const route =
    routes.find(r => r.routeName === ROUTE) ||
    routes.find(r => (r.routeName || "").toLowerCase() === ROUTE.toLowerCase());

  if (!route) {
    document.body.innerHTML =
      "<h2 style='color:white;padding:20px'>Route not found: " + ROUTE + "</h2>";
    return;
  }

  document.getElementById("label").textContent =
    `${route.routeName} – ${route.date || ""}`;

  /* ----------------------------
     LEAFLET MAP INITIALISATION
  ----------------------------- */
  const map = L.map("map", { zoomControl: false });
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19
  }).addTo(map);

  /* ----------------------------
     LOAD GPX + DRAW BASE ROUTE
  ----------------------------- */
  const gpx = await loadGPX(route.gpxUrl);
  const latLngs = gpx.map(p => [p.lat, p.lon]);

  L.polyline(latLngs, { color: "#888", weight: 4, opacity: 0.3 }).addTo(map);

  map.fitBounds(latLngs, { padding: [50,50] });

  /* ----------------------------
     PROJECT PATH TO CANVAS
  ----------------------------- */
  let path2d = projectPathToMap(gpx, map);

  // Reproject when map moves or zooms
  map.on("move zoom", () => {
    path2d = projectPathToMap(gpx, map);
  });

  /* ----------------------------
     LOAD SPRITE AND START ANIM
  ----------------------------- */
  const sprite = new Image();
  sprite.crossOrigin = "anonymous";
  sprite.src = settings.travelboost_sprite;

  sprite.onload = () => animate(path2d, sprite, settings);
})();
</script>

</body>
</html>
