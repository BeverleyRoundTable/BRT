<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Santa Sleigh Tracker</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/gpx.min.js"></script>

<style>
html,body{
  margin:0;padding:0;height:100%;
  background:#001;color:#fff;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
  overflow:hidden;
}
#map{width:100vw;height:100dvh;min-height:100vh;}

.status-popup{
  position:absolute;top:24px;left:50%;
  transform:translateX(-50%);
  background:rgba(24,24,24,.93);
  padding:18px 20px;
  font-size:1.3em;font-weight:800;
  border-radius:18px;
  min-width:260px;max-width:90%;
  box-shadow:0 4px 32px #0006;
  z-index:4000;text-align:center;
}
.status-popup.searching{animation:glow 1.3s ease-in-out infinite;}
@keyframes glow{
  0%{box-shadow:0 0 0 rgba(255,215,0,0);}
  50%{box-shadow:0 0 20px rgba(255,215,0,.6);}
  100%{box-shadow:0 0 0 rgba(255,215,0,0);}
}

.donate-box{
  position:fixed;bottom:110px;left:50%;
  transform:translateX(-50%);
  width:70%;max-width:420px;
  z-index:2000;
}
.donate-btn{
  background:var(--primaryColor,#d31c1c);
  color:#fff;padding:16px 0;
  display:block;text-align:center;
  border-radius:16px;
  font-weight:900;text-decoration:none;
  box-shadow:0 4px 16px rgba(0,0,0,.4);
}

.info-popup{
  position:fixed;left:50%;transform:translateX(-50%);
  bottom:16px;
  background:rgba(20,20,20,.92);
  padding:12px 14px;
  border-radius:12px;
  display:flex;gap:14px;
  font-size:.85em;font-weight:800;
  z-index:2000;
}
.muted{display:none}
.btn{
  background:#0b1220;color:#fff;
  border:1px solid #ffffff26;
  border-radius:10px;padding:8px 12px;
  cursor:pointer;font-weight:800;
}

#loadingCover{
  position:fixed;inset:0;
  background:#000;
  display:flex;align-items:center;justify-content:center;
  z-index:6000;transition:opacity .6s ease;
}
#loadingCover.hidden{opacity:0;pointer-events:none}
#loadingSpinner{
  width:56px;height:56px;border-radius:50%;
  border:4px solid rgba(255,255,255,.25);
  border-top-color:#ffd700;
  animation:spin .9s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>

<body>

<div id="loadingCover"><div id="loadingSpinner"></div></div>

<div class="status-popup searching" id="statusBox">
  üîç Searching for Santa‚Ä¶
</div>

<div class="donate-box">
  <a id="donateLink" class="donate-btn" target="_blank">
    üéÅ DONATE & SUPPORT US
  </a>
</div>

<div class="info-popup">
  <span id="lastUpdated" class="muted">‚Äî</span>
  <span id="speed" class="muted">‚Äî</span>
  <button class="btn" id="followBtn">Follow: ON</button>
  <button class="btn" id="recenterBtn">Re-centre</button>
</div>

<div id="map"></div>

<script>
const apiUrl = new URLSearchParams(location.search).get("api");
if(!apiUrl) alert("Missing ?api=YOUR_SCRIPT_URL");

const REFRESH = 8000;
const STALE_MS = 5*60000;

/* ---------- ICON FALLBACKS ---------- */
const FALLBACK_ICONS = {
  live: "https://i.ibb.co/Qj3vDbSR/Santa-Marker-11.png",
  start: "https://i.ibb.co/PzDYmwzZ/Santa-Marker-4.png",
  end: "https://i.ibb.co/39WF0kBd/Santa-Marker-5.png"
};
const safeIcon = (v,f)=> (v && String(v).trim()) ? v : f;

let map, marker;
let follow = true;
let firstFix = true;
let lastFix = null;

/* ------------------------------------------------------------ */
async function loadJSON(url){
  const r = await fetch(url,{cache:"no-store"});
  if(!r.ok) throw new Error(r.status);
  return r.json();
}
function valid(lat,lng){
  return typeof lat==="number" && typeof lng==="number" &&
         !isNaN(lat)&&!isNaN(lng);
}

/* ---------------- GPX HELPERS ---------------- */
function normaliseDate(d){
  const dt = new Date(d);
  return isNaN(dt) ? null : dt.toISOString().slice(0,10);
}
function normaliseGpxUrl(url){
  if(!url) return "";
  if(url.includes("github.com") && url.includes("/blob/")){
    return url.replace("github.com","raw.githubusercontent.com").replace("/blob/","/");
  }
  return url;
}
function pickRouteForGpx(routes, mode){
  const today = new Date().toISOString().slice(0,10);
  const todays = routes.find(r => normaliseDate(r.date)===today && r.gpxUrl);
  if(mode==="today") return todays || null;
  if(todays) return todays;
  const future = routes
    .map(r => ({r, d: normaliseDate(r.date)}))
    .filter(x => x.d && x.d>=today && x.r.gpxUrl)
    .sort((a,b)=>a.d.localeCompare(b.d));
  return future.length ? future[0].r : null;
}

/* ------------------------------------------------------------ */
async function init(){
  const data = await loadJSON(apiUrl);
  const s = data.settings || {};
  const tracker = data.tracker || {};
  const routes = data.routes || [];

  document.documentElement.style.setProperty("--primaryColor",s.primary_color||"#d31c1c");

  const donate = tracker.donate_url || s.donate_url;
  if(donate) donateLink.href=donate;
  else document.querySelector(".donate-box").style.display="none";

  const fallback={lat:66.5436,lng:25.8473};
  map=L.map("map").setView([fallback.lat,fallback.lng],Number(s.default_map_zoom)||13);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

  /* ---------- GPX OVERLAY ---------- */
  if(tracker.enable_gpx_overlay===true || tracker.enable_gpx_overlay==="true"){
    const mode = tracker.gpx_mode || "next";
    const route = pickRouteForGpx(routes, mode);

    if(route && route.gpxUrl){
      new L.GPX(normaliseGpxUrl(route.gpxUrl),{
        async:true,
        polyline_options:{
          color:s.primary_color||"#d31c1c",
          weight:5,opacity:.9
        },
        marker_options:{
          startIcon:L.icon({
            iconUrl:safeIcon(s.sleigh_icon_start,FALLBACK_ICONS.start),
            iconSize:[42,42],iconAnchor:[21,38]
          }),
          endIcon:L.icon({
            iconUrl:safeIcon(s.sleigh_icon_end,FALLBACK_ICONS.end),
            iconSize:[42,42],iconAnchor:[21,38]
          }),
          wptIconUrls:{ "":"" }
        }
      }).addTo(map);
    }
  }

  /* ---------- LIVE MARKER ---------- */
  marker=L.marker([fallback.lat,fallback.lng],{
    icon:L.icon({
      iconUrl:safeIcon(s.sleigh_icon_live,FALLBACK_ICONS.live),
      iconSize:[64,64],iconAnchor:[32,32]
    })
  }).addTo(map);

  followBtn.onclick=()=>{follow=!follow;followBtn.textContent="Follow: "+(follow?"ON":"OFF")};
  recenterBtn.onclick=()=>{follow=true;map.panTo(marker.getLatLng())};

  hideLoading();
  tick();
}

/* ------------------------------------------------------------ */
function hideLoading(){
  document.getElementById("loadingCover").classList.add("hidden");
}

/* ------------------------------------------------------------ */
async function tick(){
  try{
    const p = await loadJSON(apiUrl+"?function=proxyFirebase");
    if(!p||!valid(p.lat,p.lng)) throw "bad";

    const ts=new Date(p.ts).getTime();
    if(Date.now()-ts>STALE_MS) throw "stale";

    statusBox.textContent="üéÖ Santa is out spreading joy!";
    const newLatLng=L.latLng(p.lat,p.lng);
    marker.setLatLng(newLatLng);

    let speedText="‚Äî";
    if(lastFix && ts>lastFix.ts){
      const d=lastFix.latLng.distanceTo(newLatLng);
      const dt=(ts-lastFix.ts)/1000;
      if(dt>0){
        const mph=(d/dt)*2.23694;
        if(mph<150) speedText=`${mph.toFixed(1)} mph`;
      }
    }
    lastFix={latLng:newLatLng,ts};

    if(firstFix){map.setView(newLatLng,16);firstFix=false}
    else if(follow) map.panTo(newLatLng);

    lastUpdated.textContent="Updated "+new Date(p.ts).toLocaleTimeString("en-GB");
    speed.textContent=speedText;
    lastUpdated.style.display=speed.style.display="inline";

  }catch{
    statusBox.textContent="üéÑ Santa is in Lapland preparing for Christmas!";
  }
  setTimeout(tick,REFRESH);
}

init();
</script>
</body>
</html>
