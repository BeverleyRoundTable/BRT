<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Santa Sleigh Tracker</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html,body{
  margin:0;padding:0;height:100%;
  background:#001;color:#fff;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
  overflow:hidden;
}
#map{width:100vw;height:100dvh;min-height:100vh;}

.status-popup{
  position:absolute;top:24px;left:50%;
  transform:translateX(-50%);
  background:rgba(24,24,24,0.93);
  padding:16px 18px;
  font-size:1.2em;font-weight:700;
  border-radius:18px;
  min-width:250px;
  text-align:center;
  z-index:4000;
}
.status-popup.searching{
  animation:glow 1.3s ease-in-out infinite;
}
@keyframes glow{
  0%{box-shadow:0 0 0 rgba(255,215,0,0);}
  50%{box-shadow:0 0 20px rgba(255,215,0,0.5);}
  100%{box-shadow:0 0 0 rgba(255,215,0,0);}
}
</style>
</head>

<body>

<div id="map"></div>
<div class="status-popup searching" id="statusBox">
  üîç Searching for Santa‚Ä¶
</div>

<script>
/* ------------------------------------------------------------
   GLOBALS
------------------------------------------------------------ */
let map, marker;
let firstLiveFix = true;
let follow = true;

/* ------------------------------------------------------------
   API
------------------------------------------------------------ */
const urlParams = new URLSearchParams(window.location.search);
const apiUrl = urlParams.get("api") || urlParams.get("sleigh_api");
if (!apiUrl) alert("‚ùå No API provided. Use ?api=YOUR_SCRIPT_URL");

const firebaseProxyUrl = apiUrl + "?function=proxyFirebase";

async function loadJSON(url){
  const r = await fetch(url,{cache:"no-store"});
  if (!r.ok) throw new Error("HTTP "+r.status);
  return r.json();
}

function isValidLatLng(lat,lng){
  return typeof lat==="number" && typeof lng==="number" &&
         !isNaN(lat)&&!isNaN(lng) &&
         lat>=-90&&lat<=90 && lng>=-180&&lng<=180;
}

/* ------------------------------------------------------------
   INIT
------------------------------------------------------------ */
async function init(){
  const data = await loadJSON(apiUrl);
  const settings = data.settings || {};

  const fallback = { lat:66.5436, lng:25.8473 };

  let zoom = Number(settings.default_map_zoom);
  if (!zoom || zoom < 1 || zoom > 20) zoom = 13;

  map = L.map("map").setView([fallback.lat,fallback.lng], zoom);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

  marker = L.marker([fallback.lat,fallback.lng]).addTo(map);
}

/* ------------------------------------------------------------
   FIREBASE POLLING (PROXY MODE)
------------------------------------------------------------ */
const REFRESH = 8000;
const STALE_MS = 5 * 60000;

async function tick(){
  try{
    const p = await loadJSON(firebaseProxyUrl);

    if (!p || !isValidLatLng(p.lat,p.lng))
      throw new Error("Invalid GPS payload");

    const ts = new Date(p.ts).getTime();
    if (isNaN(ts)) throw new Error("Bad timestamp");

    const age = Date.now() - ts;
    if (age > STALE_MS) throw new Error("Stale GPS");

    const status = document.getElementById("statusBox");
    status.classList.remove("searching");
    status.textContent = "üéÖ Santa is out on his sleigh spreading joy!";

    const pos = L.latLng(p.lat,p.lng);
    marker.setLatLng(pos);

    if (firstLiveFix){
      firstLiveFix = false;
      map.setView(pos, 16);
    } else if (follow){
      map.panTo(pos);
    }

  } catch (e){
    const status = document.getElementById("statusBox");
    status.classList.remove("searching");
    status.textContent =
      "üéÑ Santa is currently in Lapland preparing for Christmas!";
  }

  setTimeout(tick, REFRESH);
}

/* ------------------------------------------------------------
   BOOTSTRAP
------------------------------------------------------------ */
(async ()=>{
  try{
    await init();
  } finally {
    tick();
  }
})();
</script>

</body>
</html>
