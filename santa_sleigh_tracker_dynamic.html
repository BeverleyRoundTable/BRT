<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Santa Sleigh Tracker</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/gpx.min.js"></script>

<style>
html,body{
  margin:0;padding:0;height:100%;
  background:#001;color:#fff;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
  overflow:hidden;
}
#map{width:100vw;height:100dvh;min-height:100vh;}

/* ---------- STATUS ---------- */
.status-popup{
  position:absolute;top:24px;left:50%;
  transform:translateX(-50%);
  background:rgba(24,24,24,.93);
  padding:18px 20px;
  font-size:1.3em;font-weight:800;
  border-radius:18px;
  min-width:260px;max-width:90%;
  box-shadow:0 4px 32px #0006;
  z-index:4000;text-align:center;
  backdrop-filter: blur(6px);
}
.status-popup.searching{
  animation:glow 1.3s ease-in-out infinite;
}
@keyframes glow{
  0%{box-shadow:0 0 0 rgba(255,215,0,0);}
  50%{box-shadow:0 0 20px rgba(255,215,0,.6);}
  100%{box-shadow:0 0 0 rgba(255,215,0,0);}
}

/* ---------- DONATE ---------- */
.donate-box{
  position:fixed;bottom:110px;left:50%;
  transform:translateX(-50%);
  width:70%;max-width:420px;
  z-index:2000;
}
.donate-btn{
  background:var(--primaryColor,#d31c1c);
  color:#fff;padding:16px 0;
  display:block;text-align:center;
  border-radius:16px;
  font-weight:900;text-decoration:none;
  box-shadow:0 4px 16px rgba(0,0,0,.4);
}

/* ---------- INFO ---------- */
.info-popup{
  position:fixed;left:50%;transform:translateX(-50%);
  bottom:16px;
  background:rgba(20,20,20,.92);
  padding:12px 14px;
  border-radius:12px;
  display:flex;gap:14px;
  font-size:.85em;font-weight:800;
  z-index:2000;
}
.muted{display:none}
.btn{
  background:#0b1220;color:#fff;
  border:1px solid #ffffff26;
  border-radius:10px;padding:8px 12px;
  cursor:pointer;font-weight:800;
}

/* ---------- LOGO ---------- */
#logoOverlay{
  position:fixed;
  z-index:5000;
  pointer-events:none;
  display:none;
}

/* ---------- EMBED / SMALL HEIGHT FIX ---------- */
@media (max-height: 620px){
  .status-popup{
    top:12px;
    font-size:1.05em;
    padding:12px 14px;
  }
  .donate-box{
    bottom:72px;
    width:78%;
  }
  .donate-btn{
    padding:12px 0;
    font-size:.95em;
  }
  .info-popup{
    bottom:10px;
    padding:8px 10px;
    font-size:.78em;
  }
  #logoOverlay{
    bottom:78px !important;
    right:12px !important;
    width:48px !important;
  }
}
</style>
</head>

<body>

<div class="status-popup searching" id="statusBox">
  üîç Searching for Santa‚Ä¶
</div>

<div class="donate-box" id="donateBox">
  <a id="donateLink" class="donate-btn" target="_blank">
    üéÅ DONATE & SUPPORT US
  </a>
</div>

<div class="info-popup">
  <span id="lastUpdated" class="muted">‚Äî</span>
  <span id="speed" class="muted">‚Äî</span>
  <button class="btn" id="followBtn">Follow: ON</button>
  <button class="btn" id="recenterBtn">Re-centre</button>
</div>

<div id="map"></div>
<img id="logoOverlay" />

<script>
const apiUrl=new URLSearchParams(location.search).get("api");
if(!apiUrl) alert("Missing ?api=YOUR_SCRIPT_URL");

const REFRESH=8000;
const STALE_MS=5*60*1000;
const LAPLAND={lat:66.5436,lng:25.8473};

let map,marker,follow=true,firstFix=true,lastFix=null,active=true;

/* ---------- HELPERS ---------- */
const safe=(v,f)=>v&&String(v).trim()?v:f;
const valid=(a,b)=>typeof a==="number"&&typeof b==="number"&&!isNaN(a)&&!isNaN(b);
const load=async u=>(await fetch(u,{cache:"no-store"})).json();
const norm=d=>{const x=new Date(d);return isNaN(x)?null:x.toISOString().slice(0,10)};

/* ---------- INIT ---------- */
(async()=>{
  const data=await load(apiUrl);
  const s=data.settings||{}, routes=data.routes||[];

  document.documentElement.style.setProperty("--primaryColor",s.primary_color||"#d31c1c");

  /* Donate */
  if(s.donate_url){
    donateLink.href=s.donate_url;
  }else{
    donateBox.style.display="none";
  }

  /* Map */
  map=L.map("map",{zoomControl:true}).setView([LAPLAND.lat,LAPLAND.lng],s.default_map_zoom||13);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

  /* Logo */
  if(s.logo_overlay_enabled){
    const logo=document.getElementById("logoOverlay");
    logo.src=safe(s.logo_overlay_url,"https://i.ibb.co/4Ztkn1Zf/RTGBI-Roundel.png");
    logo.style.display="block";
    logo.style.width=(s.logo_overlay_size||64)+"px";
    logo.style.bottom="20px";
    logo.style.right="20px";
  }

  /* Live marker */
  marker=L.marker([LAPLAND.lat,LAPLAND.lng],{
    icon:L.icon({
      iconUrl:safe(s.sleigh_icon_live,"https://i.ibb.co/Qj3vDbSR/Santa-Marker-11.png"),
      iconSize:[64,64],iconAnchor:[32,32]
    })
  }).addTo(map);

  followBtn.onclick=()=>{follow=!follow;followBtn.textContent=`Follow: ${follow?"ON":"OFF"}`};
  recenterBtn.onclick=()=>{follow=true;map.panTo(marker.getLatLng())};

  tick();
})();

/* ---------- LOOP ---------- */
async function tick(){
  try{
    const raw=await load(apiUrl+"?function=proxyFirebase");
    const k=Object.keys(raw||{})[0];
    const p=raw?.[k];
    if(!p||!valid(p.lat,p.lng)) throw 0;

    const ts=new Date(p.ts).getTime();
    if(Date.now()-ts>STALE_MS) throw 0;

    const ll=L.latLng(p.lat,p.lng);
    marker.setLatLng(ll);

    if(firstFix){
      map.setView(ll,16,{animate:true});
      firstFix=false;
    }else if(follow){
      map.panTo(ll,{animate:true});
    }

    let mph="‚Äî";
    if(lastFix){
      const d=lastFix.ll.distanceTo(ll),dt=(ts-lastFix.ts)/1000;
      if(dt>0){
        const m=(d/dt)*2.23694;
        if(m<150) mph=`${m.toFixed(1)} mph`;
      }
    }
    lastFix={ll,ts};

    lastUpdated.textContent="Updated "+new Date(p.ts).toLocaleTimeString("en-GB");
    speed.textContent=mph;
    lastUpdated.style.display=speed.style.display="inline";

    statusBox.textContent="üéÖ Santa is out spreading joy!";
    active=true;

  }catch{
    if(active){
      map.flyTo([LAPLAND.lat,LAPLAND.lng],6,{duration:2});
      marker.setLatLng([LAPLAND.lat,LAPLAND.lng]);
    }
    active=false;
    statusBox.textContent="üéÑ Santa is in Lapland preparing for Christmas!";
  }
  setTimeout(tick,REFRESH);
}
</script>
</body>
</html>
