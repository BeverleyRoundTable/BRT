<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Santa Sleigh Tracker</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/gpx.min.js"></script>

<style>
html,body{
  margin:0;
  padding:0;
  height:100%;
  background:#001;
  color:#fff;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
  overflow:hidden;
}

/* ---------- VIEWPORT SAFE ZONE ---------- */
:root{
  /* Desktop default */
  --ui-bottom-safe: 72px;

  /* ‚úÖ FIX: Donate ABOVE Follow */
  --donate-bottom: calc(var(--ui-bottom-safe) + 92px);
  --info-bottom: var(--ui-bottom-safe);
}

/* Mobile browsers with notches */
@supports(padding: env(safe-area-inset-bottom)){
  :root{
    --ui-bottom-safe: calc(88px + env(safe-area-inset-bottom));

    /* ‚úÖ FIX mirrored for mobile */
    --donate-bottom: calc(var(--ui-bottom-safe) + 92px);
    --info-bottom: var(--ui-bottom-safe);
  }
}

#map{
  position:absolute;
  inset:0;
}

/* ---------- STATUS ---------- */
.status-popup{
  position:absolute;
  top:20px;
  left:50%;
  transform:translateX(-50%);
  background:rgba(24,24,24,.95);
  padding:14px 20px;
  font-size:1.05em;
  font-weight:800;
  border-radius:16px;
  max-width:90%;
  box-shadow:0 4px 24px #0006;
  z-index:4000;
  text-align:center;
}

/* ---------- DONATE ---------- */
.donate-box{
  position:fixed;
  bottom: var(--donate-bottom);
  left:50%;
  transform:translateX(-50%);
  width:70%;
  max-width:420px;
  z-index:2000;
}
.donate-btn{
  background:#d31c1c;
  color:#fff;
  padding:14px 0;
  display:block;
  text-align:center;
  border-radius:16px;
  font-weight:900;
  text-decoration:none;
  box-shadow:0 4px 16px rgba(0,0,0,.4);
}

/* ---------- INFO BAR ---------- */
.info-popup{
  position:fixed;
  bottom: var(--info-bottom);
  left:50%;
  transform:translateX(-50%);

  background:rgba(20,20,20,.94);
  padding:10px 14px;
  border-radius:14px;
  display:flex;
  align-items:center;
  gap:12px;
  font-size:.85em;
  font-weight:800;
  z-index:2000;
  max-width:calc(100vw - 32px);
  box-sizing:border-box;
}

/* ---------- STATUS DOT ---------- */
.status-dot{
  width:12px;
  aspect-ratio:1 / 1;
  border-radius:50%;
  flex-shrink:0;
  display:none;
}
.dot-moving{
  background:#2cff4e;
  animation:pulse 1.4s infinite;
}
.dot-stopped{
  background:#ff3b3b;
}
@keyframes pulse{
  0%{ box-shadow:0 0 0 0 rgba(44,255,78,.6); }
  70%{ box-shadow:0 0 0 10px rgba(44,255,78,0); }
  100%{ box-shadow:0 0 0 0 rgba(44,255,78,0); }
}

.btn{
  background:#0b1220;
  color:#fff;
  border:1px solid #ffffff26;
  border-radius:10px;
  padding:7px 12px;
  cursor:pointer;
  font-weight:800;
}

/* ---------- LOGO OVERLAY ---------- */
.logo-overlay{
  position:relative;
  width:48px;
  max-width:18vw;
  pointer-events:none;
  opacity:.9;
  filter:drop-shadow(0 2px 6px rgba(0,0,0,.5));
}

/* ---------- LOADING ---------- */
#loadingCover{
  position:fixed;
  inset:0;
  background:#000;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:6000;
}
#loadingSpinner{
  width:52px;
  height:52px;
  border-radius:50%;
  border:4px solid rgba(255,255,255,.25);
  border-top-color:#ffd700;
  animation:spin .9s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}

/* ---------- MOBILE / EMBED TIGHTENING ---------- */
@media (max-height: 700px){
  :root{
    --ui-bottom-safe: calc(64px + env(safe-area-inset-bottom));
  }

  .donate-box{
    width:85%;
    max-width:360px;
  }

  .info-popup{
    font-size:.8em;
    padding:8px 12px;
  }

  .status-popup{
    font-size:.95em;
    padding:12px 16px;
  }
}
</style>
</head>

<body>

<div id="loadingCover"><div id="loadingSpinner"></div></div>

<div class="status-popup" id="statusBox">
  üîç Searching for Santa‚Ä¶
</div>

<div class="donate-box" id="donateBox">
  <a id="donateLink" class="donate-btn" target="_blank">
    üéÅ DONATE & SUPPORT US
  </a>
</div>

<div class="info-popup">
  <div id="statusDot" class="status-dot"></div>
  <button class="btn" id="followBtn">Follow: ON</button>
  <button class="btn" id="recenterBtn">Re-centre</button>
  <button class="btn" id="notifyBtn">üîî Notify Me</button>
</div>

<div id="map"></div>

<script>
/* ===================================================
   API HANDLING ‚Äî HIDDEN + REFRESH SAFE
=================================================== */

const params = new URLSearchParams(location.search);
let apiUrl = params.get("api");

if (!apiUrl) apiUrl = sessionStorage.getItem("SANTA_API");
if (!apiUrl) { alert("Missing ?api=YOUR_SCRIPT_URL"); throw new Error("API missing"); }

sessionStorage.setItem("SANTA_API", apiUrl);
if (location.search.includes("api=")) history.replaceState(null, "", location.pathname);

/* ===================================================
   TRACKER CONFIG (UNCHANGED)
=================================================== */

const REFRESH = 3000;
const STALE_MS = 5 * 60 * 1000;
const LAPLAND = [66.5436,25.8473];

const FALLBACK = {
  live: "https://i.ibb.co/Qj3vDbSR/Santa-Marker-11.png",
  start: "https://i.ibb.co/PzDYmwzZ/Santa-Marker-4.png",
  end: "https://i.ibb.co/39WF0kBd/Santa-Marker-5.png"
};

let map, marker, follow=true, firstFix=true, lastFix=null;
let awaitingPin = false;
let notifyMarker = null;
let firebaseBaseUrl = null;
  let pinPreview = null;
  let browserNotified = sessionStorage.getItem("SANTA_BROWSER_NOTIFIED") === "1";

  function isSameSpot(a, b, tolerance = 0.00005) {
  return (
    Math.abs(a.lat - b.lat) < tolerance &&
    Math.abs(a.lng - b.lng) < tolerance
  );
}

/* ---------- HELPERS ---------- */
const valid=(lat,lng)=>typeof lat==="number"&&!isNaN(lat)&&typeof lng==="number"&&!isNaN(lng);

async function loadJSON(url){
  const r = await fetch(url,{cache:"no-store"});
  if(!r.ok) throw 0;
  return r.json();
}
  
 function showNotifyMarker(lat, lng, confirmed = false) {
  if (notifyMarker) {
    map.removeLayer(notifyMarker);
  }

  notifyMarker = L.marker([lat, lng], {
    icon: confirmed ? CONFIRMED_ICON : PREVIEW_ICON
  })
    .addTo(map)
    .bindPopup(
      confirmed
        ? "üîî Notification set here"
        : "üìç Preview location ‚Äî tap again to confirm"
    );

  notifyMarker.openPopup();
}

  const PREVIEW_ICON = L.icon({
  iconUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-grey.png",
  iconSize: [25, 41],
  iconAnchor: [12, 41],
  popupAnchor: [1, -34]
});

const CONFIRMED_ICON = L.icon({
  iconUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-red.png",
  iconSize: [25, 41],
  iconAnchor: [12, 41],
  popupAnchor: [1, -34]
});
  
function fireBrowserNotification(title, body) {
  if (!("Notification" in window)) return;
  if (Notification.permission !== "granted") return;

  try {
    new Notification(title, {
      body,
      icon: "https://i.ibb.co/PzDYmwzZ/Santa-Marker-4.png",
      badge: "https://i.ibb.co/PzDYmwzZ/Santa-Marker-4.png",
      requireInteraction: true
    });
  } catch (e) {
    console.warn("Notification failed", e);
  }
}
  
function haversineMeters(a, b) {
  const R = 6371000;
  const dLat = (b.lat - a.lat) * Math.PI / 180;
  const dLng = (b.lng - a.lng) * Math.PI / 180;

  const s =
    Math.sin(dLat / 2) ** 2 +
    Math.cos(a.lat * Math.PI / 180) *
    Math.cos(b.lat * Math.PI / 180) *
    Math.sin(dLng / 2) ** 2;

  return 2 * R * Math.asin(Math.sqrt(s));
}

/* ---------- INIT ---------- */
async function init(){
  const data = await loadJSON(apiUrl);
  const s = data.settings || {};

  // üîë Capture Firebase base URL from API
  firebaseBaseUrl = data.tracker?.firebase_url || null;
  
  // üîî Hide Notify button if no GPX route is available
  const today = new Date().toISOString().slice(0, 10);

const todayRoute = (data.routes || []).find(r =>
  r.date === today && r.gpxUrl
);

if (!todayRoute) {
  notifyBtn.style.display = "none";
}

  if(s.donate_url) donateLink.href=s.donate_url;
  else donateBox.style.display="none";

  map = L.map("map").setView(LAPLAND,5);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

  map.on("click", e => {
  if (!awaitingPin) return;

  const { lat, lng } = e.latlng;

  // No preview yet ‚Üí place preview
  if (!pinPreview) {
    pinPreview = { lat, lng };
    showNotifyMarker(lat, lng, false);

    statusBox.textContent =
      "‚úÖ Pin placed ‚Äî tap again to confirm or tap elsewhere to move it";

    return;
  }

  // Preview exists ‚Üí check if same spot
 if (isSameSpot(pinPreview, { lat, lng })) {
  awaitingPin = false;

  showNotifyMarker(pinPreview.lat, pinPreview.lng, true);

  subscribeUser(pinPreview.lat, pinPreview.lng);
  pinPreview = null;

  statusBox.textContent = "üîî Notification confirmed ‚Äî we‚Äôll alert you when Santa is close!";
  return;
}

  // Different spot ‚Üí MOVE preview
  pinPreview = { lat, lng };
  showNotifyMarker(lat, lng, false);

  statusBox.textContent =
    "üìç Pin moved ‚Äî tap again to confirm";
});
  
  if (s.logo_overlay_url) {

  // Map Sheet values ‚Üí Leaflet positions
  const LOGO_POSITIONS = {
    "top-left": "topleft",
    "top-right": "topright",
    "bottom-left": "bottomleft",
    "bottom-right": "bottomright",
    "center": "topright" // fallback (Leaflet has no true center)
  };

  const logoPosition =
    LOGO_POSITIONS[s.logo_overlay_position] || "bottomright";

  const LogoControl = L.control({ position: logoPosition });

  LogoControl.onAdd = function(){
    const img = L.DomUtil.create("img");
    img.src = s.logo_overlay_url;
    img.className = "logo-overlay";
    return img;
  };

  LogoControl.addTo(map);
}

  marker = L.marker(LAPLAND,{
    icon:L.icon({
      iconUrl:s.sleigh_icon_live||FALLBACK.live,
      iconSize:[64,64],
      iconAnchor:[32,60]
    })
  }).addTo(map);

  followBtn.onclick=()=>{follow=!follow;followBtn.textContent="Follow: "+(follow?"ON":"OFF")};
  recenterBtn.onclick=()=>{follow=true;map.panTo(marker.getLatLng())};

  loadingCover.style.display="none";

  tick();
}

/* ---------- POLL ---------- */
  async function tick(){
  const dot=statusDot;
  try{
    const p=await loadJSON(apiUrl+"?function=proxyFirebase");
    if(!valid(p.lat,p.lng)) throw 0;
    const ts=new Date(p.ts).getTime();
    if(Date.now()-ts>STALE_MS) throw 0;

    const ll=L.latLng(p.lat,p.lng);
    marker.setLatLng(ll);
    
    // üîî Browser notification backup (page-open only)
if (
  notifyMarker &&          // user subscribed
  !browserNotified         // only once
) {
  const santa = { lat: p.lat, lng: p.lng };
  const user = notifyMarker.getLatLng();

  const meters = haversineMeters(santa, user);

  // ~250m ‚âà ~5 minutes at sleigh pace
  if (meters < 250) {
  browserNotified = true;
  sessionStorage.setItem("SANTA_BROWSER_NOTIFIED", "1");

  fireBrowserNotification(
    "üéÖ Santa is nearly here!",
    "He‚Äôs about 5 minutes away ‚Äî get ready! üéÑ"
  );
}
}
    
    if(firstFix){map.setView(ll,16);firstFix=false}
    else if(follow) map.panTo(ll,{animate:true,duration:1.2});

    dot.style.display="block";
    dot.className="status-dot dot-moving";
    statusBox.textContent="üéÖ Santa is out spreading joy!";
  }catch{
    marker.setLatLng(LAPLAND);
    if(follow) map.setView(LAPLAND,5,{animate:true,duration:2});
    dot.style.display="none";
    statusBox.textContent="üéÑ Santa is in Lapland preparing for Christmas!";
    firstFix=true;
  }
  setTimeout(tick,REFRESH);
}

init();

/* ===================================================
   NOTIFICATION SIGN-UP (STEP 1)
=================================================== */

notifyBtn.onclick = () => {
  follow = false;
  followBtn.textContent = "Follow: OFF";

  browserNotified = false;
  sessionStorage.removeItem("SANTA_BROWSER_NOTIFIED");

  if ("Notification" in window && Notification.permission === "default") {
    Notification.requestPermission();
  }

  awaitingPin = true;
  pinPreview = null;

  statusBox.textContent =
    "üìç Tap once to place your pin, tap again to confirm";

  alert("üìç Tap once to place your pin, tap again to confirm");
};

function subscribeUser(lat, lng) {
  if (!firebaseBaseUrl) {
    alert("Notifications are not available for this tracker");
    return;
  }

  const email = prompt(
    "üìß Enter your email to be notified when Santa is close (recommended so you don‚Äôt miss him):"
  );

  showNotifyMarker(lat, lng, true);

  fetch(`${firebaseBaseUrl}/subscribers.json`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      api: apiUrl,
      lat,
      lng,
      email: email || null,   // ‚úÖ optional
      threshold_minutes: 5,
      notified: false,
      created: new Date().toISOString()
    })
  })
  .then(() => {
    if (email) {
      alert("üéÖ You're signed up! We‚Äôll email you when Santa is close.");
    } else {
      alert(
        "üéÖ You're signed up!\n\n" +
        "‚ö†Ô∏è Keep this page open to receive the notification.\n" +
        "For guaranteed alerts next time, add your email."
      );
    }
  })
  .catch(() => {
    alert("Could not subscribe for notifications");
  });
}

</script>
</body>
</html>
