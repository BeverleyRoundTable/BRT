<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Santa Sleigh Tracker</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/gpx.min.js"></script>
  <script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>

  <style>
    html, body { margin:0;padding:0;height:100%;background:#001;color:#fff;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;overflow:hidden }
    html { -webkit-text-size-adjust:100%;text-size-adjust:100% }
    :root { --ui-bottom-safe:72px;--donate-bottom:calc(var(--ui-bottom-safe) + 92px);--info-bottom:var(--ui-bottom-safe) }
    @supports(padding:env(safe-area-inset-bottom)){ :root{--ui-bottom-safe:calc(88px + env(safe-area-inset-bottom));--donate-bottom:calc(var(--ui-bottom-safe) + 92px);--info-bottom:var(--ui-bottom-safe)} }
    #map { position:absolute;inset:0;z-index:100 }
    body.dim-ui #map { filter:brightness(0.85);transition:filter 600ms ease }
    body.night-mode #map { filter:brightness(0.75) saturate(0.9) hue-rotate(-8deg) }
    #snow { position:fixed;inset:0;pointer-events:none;z-index:1500;opacity:0;transition:opacity 800ms ease }
    body.snowing #snow { opacity:1;filter:drop-shadow(0 0 4px white) }
    body::after { content:'';position:fixed;inset:0;background:radial-gradient(circle,transparent 40%,rgba(0,0,0,0.6) 100%);pointer-events:none;opacity:0;transition:opacity 1.5s ease;z-index:1400 }
    body.snowing::after { opacity:1 }
    .status-popup { position:absolute;top:20px;left:50%;transform:translateX(-50%);background:rgba(24,24,24,.95);padding:14px 20px;font-size:1.05em;font-weight:800;border-radius:16px;max-width:90%;box-shadow:0 4px 24px #0006;z-index:4000;text-align:center;transition:opacity 600ms ease }
    body.night-mode .status-popup { background:rgba(12,16,28,0.95) }
    .info-popup { position:fixed;bottom:var(--info-bottom);left:50%;transform:translateX(-50%);background:rgba(20,20,20,.94);padding:10px 14px;border-radius:14px;display:flex;align-items:center;gap:12px;font-size:.85em;font-weight:800;z-index:2000;max-width:calc(100vw - 32px);box-sizing:border-box;transition:opacity 600ms ease }
    .btn { background:#0b1220;color:#fff;border:1px solid #ffffff26;border-radius:10px;padding:7px 12px;cursor:pointer;font-weight:800;transition:opacity 0.3s }
    .btn.locked { opacity:0.4;pointer-events:none;filter:grayscale(1) }
    .donate-box { position:fixed;bottom:var(--donate-bottom);left:50%;transform:translateX(-50%);width:70%;max-width:420px;z-index:2000;transition:opacity 600ms ease }
    .donate-btn { background:#d31c1c;color:#fff;padding:14px 0;display:block;text-align:center;border-radius:16px;font-weight:900;text-decoration:none;box-shadow:0 4px 16px rgba(0,0,0,.4);border:2px solid #d31c1c;transition:background 0.5s ease;position:relative;z-index:1 }
    body.dim-ui .donate-box, body.dim-ui .info-popup, body.dim-ui .status-popup { opacity:0.45;filter:saturate(0.85) }
    body.dim-ui .donate-box:hover, body.dim-ui .info-popup:hover, body.dim-ui .status-popup:hover { opacity:0.75 }
    .status-dot { width:12px;aspect-ratio:1/1;border-radius:50%;flex-shrink:0;display:none }
    .dot-moving { background:#2cff4e;animation:pulse 1.4s infinite }
    .dot-stopped { background:#ffb020 }
    @keyframes pulse { 0%{box-shadow:0 0 0 0 rgba(44,255,78,.6)}70%{box-shadow:0 0 0 10px rgba(44,255,78,0)}100%{box-shadow:0 0 0 0 rgba(44,255,78,0)} }
    .logo-overlay { position:relative;width:48px;max-width:18vw;pointer-events:none;opacity:.9;filter:drop-shadow(0 2px 6px rgba(0,0,0,.5)) }
    #loadingCover { position:fixed;inset:0;background:#000;display:flex;align-items:center;justify-content:center;z-index:6000 }
    #loadingSpinner { width:52px;height:52px;border-radius:50%;border:4px solid rgba(255,255,255,.25);border-top-color:#ffd700;animation:spin .9s linear infinite }
    @keyframes spin { to{transform:rotate(360deg)} }
    .modal-overlay { display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:5000;align-items:center;justify-content:center;backdrop-filter:blur(4px);padding:20px }
    .modal-box { background:#1a1a1a;padding:24px;border-radius:20px;width:100%;max-width:340px;text-align:center;border:1px solid rgba(255,255,255,0.1);box-shadow:0 10px 40px rgba(0,0,0,0.6);animation:slideUp 0.3s cubic-bezier(0.16,1,0.3,1) }
    @keyframes slideUp { from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1} }
    .modal-title { font-size:1.2em;font-weight:800;margin:0 0 8px 0;color:#ffd700 }
    .modal-desc { font-size:0.9em;color:#ccc;margin-bottom:20px;line-height:1.4 }
    .modal-input { width:100%;padding:14px;margin-bottom:20px;background:#2a2a2a;border:2px solid #444;border-radius:12px;color:white;font-size:16px;box-sizing:border-box;text-align:center }
    .modal-input:focus { outline:none;border-color:#ffd700 }
    .modal-btns { display:flex;gap:12px }
    .btn-full { flex:1;padding:12px;border-radius:12px;font-weight:800;font-size:0.95em;cursor:pointer;border:none;transition:transform 0.1s }
    .btn-full:active { transform:scale(0.96) }
    .btn-cancel { background:#333;color:#aaa }
    .btn-confirm { background:#d31c1c;color:white;box-shadow:0 4px 12px rgba(211,28,28,0.3) }
    .toast-box { display:none;position:fixed;left:50%;bottom:calc(var(--donate-bottom) + 80px);transform:translateX(-50%);background:rgba(44,255,78,0.95);color:#000;padding:14px 20px;font-weight:800;border-radius:22px;box-shadow:0 4px 20px rgba(0,0,0,0.5);z-index:6000;pointer-events:none;max-width:min(90vw,420px);text-align:center;line-height:1.3 }
    .toast-visible { display:block }
    @media(max-width:480px){ .toast-box{font-size:0.9em;padding:12px 16px;bottom:calc(var(--donate-bottom) + 64px)} }
    body.kiosk { --kiosk-bottom:56px;cursor:none }
    body.kiosk .kiosk-sponsor { bottom:var(--kiosk-bottom) }
    body.kiosk .kiosk-banner { bottom:calc(var(--kiosk-bottom) + 64px) }
    body.kiosk .toast-box, body.kiosk .status-popup, body.kiosk #statusDot, body.kiosk .leaflet-control-zoom, body.kiosk .info-popup { display:none !important }
    body.kiosk .leaflet-container { -webkit-tap-highlight-color:transparent }
    body.kiosk .leaflet-container *, body.kiosk .leaflet-interactive:focus, body.kiosk .leaflet-interactive { outline:none !important;pointer-events:none }
    .kiosk-banner { position:fixed;bottom:calc(var(--kiosk-bottom) + 64px);left:50%;transform:translateX(-50%) translateY(-6px);background:rgba(20,20,20,0.96);color:#fff;padding:16px 36px;border-radius:999px;font-size:1.25em;font-weight:900;letter-spacing:0.4px;box-shadow:0 8px 28px rgba(0,0,0,0.55);z-index:4500;pointer-events:none;opacity:0;transition:opacity 0.6s ease,transform 0.6s ease;text-align:center;display:none }
    body.kiosk .kiosk-banner { display:block }
    .kiosk-banner.visible { opacity:1;transform:translateX(-50%) translateY(0) }
    .kiosk-banner.live { animation:kioskPulse 2.8s ease-in-out infinite }
    .kiosk-subtitle { font-size:0.75em;opacity:0.85;margin-top:4px;text-align:center }
    @keyframes kioskPulse { 0%,100%{box-shadow:0 8px 28px rgba(0,0,0,0.55)}50%{box-shadow:0 8px 34px rgba(255,215,0,0.6)} }
    .kiosk-sponsor { position:fixed;bottom:var(--kiosk-bottom);left:50%;transform:translateX(-50%) translateY(6px);background:rgba(20,20,20,0.95);padding:10px 18px;border-radius:14px;display:flex;align-items:center;gap:12px;z-index:4400;box-shadow:0 6px 22px rgba(0,0,0,0.55);opacity:0;filter:saturate(0.9);pointer-events:none;transition:opacity 0.6s ease,transform 0.6s ease }
    .kiosk-sponsor.visible { opacity:1;transform:translateX(-50%) translateY(0);pointer-events:none }
    .kiosk-sponsor span { font-size:0.75em;font-weight:700;opacity:0.85;white-space:nowrap }
    .kiosk-sponsor img { max-height:34px;max-width:160px;object-fit:contain }
    @media(max-height:700px){ :root{--ui-bottom-safe:calc(64px + env(safe-area-inset-bottom))}.donate-box{width:85%;max-width:360px}.info-popup{font-size:.8em;padding:8px 12px}.status-popup{font-size:.95em;padding:12px 16px} }
  </style>
</head>

<body>
  <div id="loadingCover"><div id="loadingSpinner"></div></div>
  <div class="status-popup" id="statusBox">üîç Searching for Santa‚Ä¶</div>
  <div class="donate-box" id="donateBox"><a id="donateLink" class="donate-btn" target="_blank">üéÅ DONATE & SUPPORT US</a></div>
  <div class="info-popup">
    <div id="statusDot" class="status-dot"></div>
    <button class="btn" id="followBtn">Follow: ON</button>
    <button class="btn" id="recenterBtn">Re-centre</button>
    <button class="btn" id="notifyBtn">üîî Notify Me</button>
    <div id="toast" class="toast-box"></div>
  </div>
  <div id="emailModal" class="modal-overlay">
    <div class="modal-box">
      <div class="modal-title">üîî Get Notified</div>
      <div class="modal-desc">Want to know when Santa is nearby? Enter your email below (optional).</div>
      <input type="email" id="subEmail" class="modal-input" placeholder="santa@example.com">
      <div class="modal-btns">
        <button class="btn-full btn-cancel" id="modalCancelBtn">Cancel</button>
        <button class="btn-full btn-confirm" id="modalConfirmBtn">Notify Me</button>
      </div>
    </div>
  </div>
  <div id="kioskBanner" class="kiosk-banner"></div>
  <div id="kioskSponsor" class="kiosk-sponsor"></div>
  <div id="map"></div>
  <canvas id="snow"></canvas>

  <script>
    document.addEventListener("DOMContentLoaded", () => {

      const AppConfig = {
        API: {
          REFRESH_MS: 6000,
          STALE_MS: 5 * 60 * 1000,
          MOTION_WINDOW_MS: 60 * 1000,
          MOVE_THRESHOLD_METERS: 8,
          MIN_FIXES_FOR_ETA: 3,
          MIN_ETA_WINDOW_MS: 15 * 1000,
        },
        NOTIFICATIONS: {
          NEAR_DISTANCE_METERS: 250,
          PASSED_DISTANCE_OFFSET: 150
        },
        GPX: { 
          AHEAD: 80, 
          BACK: 5, 
          EARLY_EXIT_METERS: 25 
        },
        SNOW: {
          ETA_MINUTES_MAX: 15,
          LEVELS: { LIGHT: 1, HEAVY: 2, BLIZZARD: 3 },
          MOBILE_BASE_COUNT: 30,
          DESKTOP_BASE_COUNT: 60,
          MULTIPLIERS: [0, 1, 2.5, 5]
        },
        BATTERY: {
          LOW: 0.4,
          CRITICAL: 0.2,
          FRAME_SKIP: { LOW: 2, CRITICAL: 3 }
        },
        LOCATIONS: {
          LAPLAND: [66.5436, 25.8473]
        },
        ICONS: {
          PREVIEW: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-grey.png",
          CONFIRMED: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",
          FALLBACK_LIVE: "https://i.ibb.co/Qj3vDbSR/Santa-Marker-11.png",
          FALLBACK_START: "https://i.ibb.co/PzDYmwzZ/Santa-Marker-4.png",
          FALLBACK_END: "https://i.ibb.co/39WF0kBd/Santa-Marker-5.png",
          BROWSER_ICON: "https://i.ibb.co/6cZwpb07/Santa-Marker.png"
        }
      };

      const AppState = {
        map: null,
        marker: null,
        notifyMarker: null,
        gpxRoute: null,
        lastFix: null,
        recentFixes: [],
        routeFixes: [],
        flags: {
          follow: true,
          firstFix: true,
          isKiosk: false,
          gpxLoaded: false,
          snowActive: false,
          pageVisible: !document.hidden,
          awaitingPin: false,
          browserNotified: sessionStorage.getItem("SANTA_BROWSER_NOTIFIED") === "1",
          hasPassedSticky: sessionStorage.getItem("SANTA_HAS_PASSED") === "1"
        },
        vars: {
          apiUrl: null,
          sleighName: "Santa Sleigh",
          staleSince: null,
          lastSnapIndex: 0,
          snowflakes: [],
          animRaf: null,
          pendingSubscription: null,
          notifyLatLng: null,
          lastVisualPos: null,
          escapeListener: null
        },
        dom: {
          loading: document.getElementById("loadingCover"),
          statusBox: document.getElementById("statusBox"),
          followBtn: document.getElementById("followBtn"),
          recenterBtn: document.getElementById("recenterBtn"),
          notifyBtn: document.getElementById("notifyBtn"),
          statusDot: document.getElementById("statusDot"),
          donateLink: document.getElementById("donateLink"),
          donateBox: document.getElementById("donateBox"),
          kioskBanner: document.getElementById("kioskBanner"),
          sponsorBox: document.getElementById("kioskSponsor"),
          toast: document.getElementById("toast"),
          snowCanvas: document.getElementById("snow")
        }
      };

      const Utils = {
        validPos: (lat, lng) => typeof lat === "number" && !isNaN(lat) && typeof lng === "number" && !isNaN(lng),
        lerp: (a, b, t) => a + (b - a) * t,
        easeOutCubic: (t) => 1 - Math.pow(1 - t, 3),
        isValidImageUrl(url) {
          if (!url || typeof url !== 'string') return false;
          try { const parsed = new URL(url); return ['http:', 'https:', 'data:'].includes(parsed.protocol); }
          catch { return false; }
        },
        async loadJSON(url) {
          const r = await fetch(url, { cache: "no-store" });
          if (!r.ok) throw new Error(`Fetch failed: ${r.status}`);
          return r.json();
        },
        haversineMeters(a, b) {
          const R = 6371000;
          const dLat = (b.lat - a.lat) * Math.PI / 180;
          const dLng = (b.lng - a.lng) * Math.PI / 180;
          const s = Math.sin(dLat / 2) ** 2 + Math.cos(a.lat * Math.PI / 180) * Math.cos(b.lat * Math.PI / 180) * Math.sin(dLng / 2) ** 2;
          return 2 * R * Math.asin(Math.sqrt(s));
        },
        isAfterSunset(lat, lng) {
          const now = new Date();
          const sunset = SunCalc.getTimes(now, lat, lng).sunset;
          return now > sunset;
        },
        calculateSpeed(fixes) {
          if (fixes.length < AppConfig.API.MIN_FIXES_FOR_ETA) return null;
          const first = fixes[0];
          const last = fixes[fixes.length - 1];
          const elapsed = last.ts - first.ts;
          if (elapsed < AppConfig.API.MIN_ETA_WINDOW_MS) return null;
          const dist = last.cumulative - first.cumulative;
          const speed = dist / (elapsed / 1000);
          return Math.min(Math.max(speed, 0.3), 31);
        },
        calculateRouteSpeed(routeFixes) {
          if (routeFixes.length < AppConfig.API.MIN_FIXES_FOR_ETA) return null;
          const first = routeFixes[0];
          const last = routeFixes[routeFixes.length - 1];
          const elapsed = last.ts - first.ts;
          if (elapsed < AppConfig.API.MIN_ETA_WINDOW_MS) return null;
          const dist = last.routeDist - first.routeDist;
          if (dist <= 0) return null;
          const speed = dist / (elapsed / 1000);
          return Math.min(Math.max(speed, 0.1), 31);
        },
        toggleFollowControls(enable) {
          const { followBtn, recenterBtn } = AppState.dom;
          if (enable) { followBtn.classList.remove("locked"); recenterBtn.classList.remove("locked"); }
          else { followBtn.classList.add("locked"); recenterBtn.classList.add("locked"); }
        }
      };

      let batteryState = { supported: false, charging: true, level: 1 };
      if ("getBattery" in navigator) {
        navigator.getBattery().then(battery => {
          batteryState.supported = true;
          const update = () => { batteryState.charging = battery.charging; batteryState.level = battery.level; };
          update();
          battery.addEventListener("chargingchange", update);
          battery.addEventListener("levelchange", update);
        });
      }

      let wakeLock = null;
      async function requestWakeLock() {
        try { if ("wakeLock" in navigator) { wakeLock = await navigator.wakeLock.request("screen"); wakeLock.addEventListener("release", () => setTimeout(requestWakeLock, 2000)); } } catch(e) {}
      }

      function animateMarkerTo(targetLat, targetLng) {
        if (!AppState.marker) return;
        const startLL = AppState.marker.getLatLng();
        const start = { lat: startLL.lat, lng: startLL.lng };
        const end = { lat: targetLat, lng: targetLng };
        const startTime = performance.now();
        const duration = 900;
        if (AppState.vars.animRaf) cancelAnimationFrame(AppState.vars.animRaf);
        function step(now) {
          const t = Math.min(1, (now - startTime) / duration);
          const e = Utils.easeOutCubic(t);
          const lat = Utils.lerp(start.lat, end.lat, e);
          const lng = Utils.lerp(start.lng, end.lng, e);
          const ll = L.latLng(lat, lng);
          AppState.marker.setLatLng(ll);
          AppState.vars.lastVisualPos = { lat: ll.lat, lng: ll.lng };
          if ((AppState.flags.follow || AppState.flags.isKiosk) && !AppState.flags.firstFix) {
            AppState.map.panTo(ll, { animate: true, duration: 0.6 });
          }
          if (t < 1) { AppState.vars.animRaf = requestAnimationFrame(step); }
          else { AppState.vars.animRaf = null; }
        }
        AppState.vars.animRaf = requestAnimationFrame(step);
      }

      function pushFix(lat, lng, ts) {
        const fixes = AppState.recentFixes;
        const last = fixes[fixes.length - 1];
        const dist = last ? Utils.haversineMeters(last, { lat, lng }) : 0;
        fixes.push({ lat, lng, ts, cumulative: (last?.cumulative || 0) + dist });
        const cutoff = ts - AppConfig.API.MOTION_WINDOW_MS;
        while (fixes.length && fixes[0].ts < cutoff) fixes.shift();
      }

      function pushRouteFix(routeDist, ts) {
        const fixes = AppState.routeFixes;
        fixes.push({ routeDist, ts });
        const cutoff = ts - AppConfig.API.MOTION_WINDOW_MS;
        while (fixes.length && fixes[0].ts < cutoff) fixes.shift();
      }

      function isSleighMoving() {
        if (AppState.recentFixes.length < 2) return false;
        const first = AppState.recentFixes[0];
        const last = AppState.recentFixes[AppState.recentFixes.length - 1];
        return (last.cumulative - first.cumulative) >= AppConfig.API.MOVE_THRESHOLD_METERS;
      }

      async function loadGpxRoute(url) {
        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 5000);
          const res = await fetch(url, { cache: "no-store", signal: controller.signal });
          clearTimeout(timeoutId);
          if (!res.ok) throw new Error("GPX fetch failed");
          const text = await res.text();
          const xml = new DOMParser().parseFromString(text, "text/xml");
          const pts = [...xml.getElementsByTagName("trkpt")];
          if (pts.length < 2) throw new Error("GPX too short");
          let dist = 0; let route = [];
          for (let i = 0; i < pts.length; i++) {
            const lat = parseFloat(pts[i].getAttribute("lat"));
            const lng = parseFloat(pts[i].getAttribute("lon"));
            if (i > 0) dist += Utils.haversineMeters(route[i - 1], { lat, lng });
            route.push({ lat, lng, dist });
          }
          AppState.gpxRoute = route;
          AppState.flags.gpxLoaded = true;
          AppState.vars.lastSnapIndex = 0;
        } catch (e) {
          AppState.flags.gpxLoaded = false;
          AppState.dom.notifyBtn.style.display = "none";
        }
      }

      function snapToGpxIndex(pos, searchOpts) {
        if (!AppState.gpxRoute) return null;
        const { AHEAD, BACK, EARLY_EXIT_METERS } = searchOpts || AppConfig.GPX;
        const isGlobalSearch = !searchOpts;
        const start = isGlobalSearch ? 0 : Math.max(0, AppState.vars.lastSnapIndex - BACK);
        const end = isGlobalSearch ? AppState.gpxRoute.length - 1 : Math.min(AppState.gpxRoute.length - 1, AppState.vars.lastSnapIndex + AHEAD);
        let bestIndex = isGlobalSearch ? 0 : AppState.vars.lastSnapIndex;
        let bestDist = Infinity;
        for (let i = start; i <= end; i++) {
          const d = Utils.haversineMeters(pos, AppState.gpxRoute[i]);
          if (d < bestDist) { bestDist = d; bestIndex = i; }
          if (!isGlobalSearch && i > AppState.vars.lastSnapIndex && d > bestDist + EARLY_EXIT_METERS) break;
        }
        if (!isGlobalSearch) AppState.vars.lastSnapIndex = bestIndex;
        return { point: AppState.gpxRoute[bestIndex], distance: bestDist };
      }

      function setDimUI(dim) { document.body.classList.toggle("dim-ui", !!dim); }

      function showToast(message) {
        if (AppState.flags.isKiosk) return;
        const t = AppState.dom.toast;
        t.textContent = message;
        t.classList.add("toast-visible");
        setTimeout(() => t.classList.remove("toast-visible"), 4000);
      }

      const SnowSystem = {
        resize() { AppState.dom.snowCanvas.width = window.innerWidth; AppState.dom.snowCanvas.height = window.innerHeight; },
        create(level) {
          const isMobile = window.innerWidth < 600;
          const baseCount = isMobile ? AppConfig.SNOW.MOBILE_BASE_COUNT : AppConfig.SNOW.DESKTOP_BASE_COUNT;
          const count = Math.floor(baseCount * AppConfig.SNOW.MULTIPLIERS[level]);
          AppState.vars.snowflakes = Array.from({ length: count }, () => ({
            x: Math.random() * AppState.dom.snowCanvas.width,
            y: Math.random() * AppState.dom.snowCanvas.height,
            radius: Math.random() * 3 + 1,
            speed: ((Math.random() * 1 + 0.5) + (Math.random() * 1.5)) * (level === 3 ? 1.3 : 1),
            swayOffset: Math.random() * Math.PI * 2,
            swaySpeed: Math.random() * 0.02 + 0.005
          }));
        },
        draw() {
          if (!AppState.flags.snowActive || !AppState.flags.pageVisible) return;
          let frameSkip = 0;
          if (batteryState.supported && !batteryState.charging) {
            if (batteryState.level <= AppConfig.BATTERY.CRITICAL) frameSkip = AppConfig.BATTERY.FRAME_SKIP.CRITICAL;
            else if (batteryState.level <= AppConfig.BATTERY.LOW) frameSkip = AppConfig.BATTERY.FRAME_SKIP.LOW;
          }
          SnowSystem._frame = (SnowSystem._frame || 0) + 1;
          if (frameSkip && SnowSystem._frame % (frameSkip + 1) !== 0) { requestAnimationFrame(SnowSystem.draw); return; }
          const ctx = AppState.dom.snowCanvas.getContext("2d");
          ctx.clearRect(0, 0, AppState.dom.snowCanvas.width, AppState.dom.snowCanvas.height);
          ctx.fillStyle = "rgba(255, 255, 255, 0.95)";
          ctx.beginPath();
          for (const f of AppState.vars.snowflakes) {
            f.y += f.speed; f.swayOffset += f.swaySpeed; f.x += Math.sin(f.swayOffset) * 0.5;
            if (f.y > AppState.dom.snowCanvas.height) { f.y = -10; f.x = Math.random() * AppState.dom.snowCanvas.width; }
            if (f.x > AppState.dom.snowCanvas.width) f.x = 0;
            if (f.x < 0) f.x = AppState.dom.snowCanvas.width;
            ctx.moveTo(f.x, f.y); ctx.arc(f.x, f.y, f.radius, 0, Math.PI * 2);
          }
          ctx.fill();
          requestAnimationFrame(SnowSystem.draw);
        },
        setLevel(on, level) {
          if (!on) {
            if (AppState.flags.snowActive) {
              AppState.flags.snowActive = false;
              document.body.classList.remove("snowing");
              const ctx = AppState.dom.snowCanvas.getContext("2d");
              ctx.clearRect(0, 0, AppState.dom.snowCanvas.width, AppState.dom.snowCanvas.height);
            }
            return;
          }
          if (AppState.currentSnowLevel !== level) { AppState.currentSnowLevel = level; SnowSystem.create(level); }
          if (!AppState.flags.snowActive) { AppState.flags.snowActive = true; document.body.classList.add("snowing"); SnowSystem.draw(); }
        }
      };

      function showNotifyMarker(lat, lng, confirmed) {
        if (AppState.notifyMarker) AppState.map.removeLayer(AppState.notifyMarker);
        const iconUrl = confirmed ? AppConfig.ICONS.CONFIRMED : AppConfig.ICONS.PREVIEW;
        AppState.notifyMarker = L.marker([lat, lng], {
          icon: L.icon({ iconUrl, iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png", shadowSize: [41, 41] }),
          interactive: true
        }).addTo(AppState.map);
        if (!confirmed) {
          AppState.notifyMarker.bindPopup("üìç Tap this pin again to confirm").openPopup();
          AppState.notifyMarker.once("click", () => {
            AppState.flags.awaitingPin = false;
            showNotifyMarker(lat, lng, true);
            sessionStorage.setItem("SANTA_NOTIFY_POINT", JSON.stringify({ lat, lng }));
            AppState.vars.pendingSubscription = { lat, lng };
            AppState.vars.notifyLatLng = { lat, lng };
            document.getElementById("emailModal").style.display = "flex";
            document.getElementById("subEmail").focus();
          });
        }
      }

      function fireBrowserNotification(title, body) {
        if (!("Notification" in window)) return;
        if (Notification.permission !== "granted") return;
        try { new Notification(title, { body, icon: AppConfig.ICONS.BROWSER_ICON, requireInteraction: true }); } catch (e) {}
      }

      async function updateTracker() {
        try {
          const data = await Utils.loadJSON(AppState.vars.apiUrl + "?function=proxyFirebase");
          if (!Utils.validPos(data.lat, data.lng)) throw new Error("Invalid Coords");

          const ts = new Date(data.ts).getTime();
          const age = Date.now() - ts;
          const isFresh = age <= AppConfig.API.STALE_MS;

          if (AppState.flags.isKiosk) {
            AppState.dom.kioskBanner.classList.toggle("live", isFresh);
            const statusEl = document.getElementById("kioskStatus");
            if (statusEl) statusEl.textContent = isFresh ? "üéÖ LIVE TRACKING" : "üéÑ PREPARING IN LAPLAND";
            if (AppState.dom.sponsorBox) {
              AppState.dom.sponsorBox.classList.toggle("visible", isFresh && !!AppState.vars.todayRoute?.sponsorUrl);
            }
          }

          const isNight = isFresh && Utils.isAfterSunset(data.lat, data.lng);
          document.body.classList.toggle("night-mode", isNight);

          if (!isFresh) {
            if (!AppState.vars.staleSince) AppState.vars.staleSince = ts;
            if (Date.now() - AppState.vars.staleSince > AppConfig.API.STALE_MS) {
              AppState.marker.setLatLng(AppConfig.LOCATIONS.LAPLAND);
              if (AppState.flags.follow) AppState.map.setView(AppConfig.LOCATIONS.LAPLAND, 5, { animate: true, duration: 2 });
              AppState.dom.statusBox.textContent = "üéÑ Santa is in Lapland preparing for Christmas!";
              AppState.dom.statusDot.style.display = "none";
              setDimUI(false);
              AppState.flags.firstFix = true;
              setTimeout(updateTracker, AppConfig.API.REFRESH_MS);
              return;
            }
            if (AppState.lastFix) {
              animateMarkerTo(AppState.lastFix.lat, AppState.lastFix.lng);
              AppState.dom.statusBox.textContent = "üéÖ Santa is nearby‚Ä¶";
              return;
            }
          } else {
            AppState.vars.staleSince = null;
            AppState.lastFix = { lat: data.lat, lng: data.lng };
          }

          let visualPos = { lat: data.lat, lng: data.lng };

          if (AppState.flags.gpxLoaded) {
            const snap = snapToGpxIndex(visualPos, AppConfig.GPX);
            if (snap && snap.distance < 50) { visualPos = snap.point; }
            else { visualPos = { lat: data.lat, lng: data.lng }; }
          }

          animateMarkerTo(visualPos.lat, visualPos.lng);
          pushFix(data.lat, data.lng, Date.now());

          // --------------------------------------------------------
          // STICKY PASS & SNOW CONTROL
          // --------------------------------------------------------
          let etaSeconds = null;

          if (AppState.flags.hasPassedSticky) {
             // Already passed ‚Äî keep status locked
          }
          else if (AppState.vars.notifyLatLng && AppState.flags.gpxLoaded && isFresh) {
            const santaSnap = snapToGpxIndex({ lat: data.lat, lng: data.lng }, AppConfig.GPX);

            if (santaSnap) {
              const userPos = AppState.vars.notifyLatLng;
              const savedSnapIdx = AppState.vars.lastSnapIndex;
              const userSnap = snapToGpxIndex(userPos, null);
              AppState.vars.lastSnapIndex = savedSnapIdx;

              // Track Santa's route progress for speed calculation
              pushRouteFix(santaSnap.point.dist, Date.now());

              if (userSnap) {
                if (santaSnap.point.dist > userSnap.point.dist + AppConfig.NOTIFICATIONS.PASSED_DISTANCE_OFFSET) {
                  sessionStorage.setItem("SANTA_HAS_PASSED", "1");
                } else {
                  const remaining = Math.max(0, userSnap.point.dist - santaSnap.point.dist);
                  // Use route-based speed (same units as remaining) for accurate ETA
                  const routeSpeed = Utils.calculateRouteSpeed(AppState.routeFixes);
                  const rawSpeed = Utils.calculateSpeed(AppState.recentFixes);
                  // Prefer route speed; fall back to raw GPS speed; last resort: walking pace ~1.4 m/s
                  const effectiveSpeed = (routeSpeed && routeSpeed > 0.3) ? routeSpeed
                                       : (rawSpeed && rawSpeed > 0.5) ? rawSpeed
                                       : 1.4;
                  etaSeconds = remaining / effectiveSpeed;
                }
              }
            }
          }

          const etaMinutes = isFinite(etaSeconds) ? etaSeconds / 60 : Infinity;

          // Snow Logic
          let snowLevel = 0;
          let triggerSnow = false;

          if (AppState.vars.notifyLatLng && !AppState.flags.hasPassedSticky && etaSeconds !== null && isFresh) {
             if (etaMinutes < 15) {
                triggerSnow = true;
                if (etaMinutes < 3) snowLevel = 3;
                else if (etaMinutes < 8) snowLevel = 2;
                else snowLevel = 1;
             }
          }

          if (AppState.flags.hasPassedSticky) { triggerSnow = false; snowLevel = 0; }

          const { maxLevel } = function(){
             if (batteryState.supported && !batteryState.charging) {
               if(batteryState.level <= AppConfig.BATTERY.CRITICAL) return { maxLevel: 1 };
               if(batteryState.level <= AppConfig.BATTERY.LOW) return { maxLevel: 2 };
             }
             return { maxLevel: 3 };
          }();

          SnowSystem.setLevel(triggerSnow, Math.min(snowLevel, maxLevel));

          // Status Text & Dimming
          const moving = isSleighMoving();
          AppState.dom.statusDot.style.display = "block";
          AppState.dom.statusDot.className = moving ? "status-dot dot-moving" : "status-dot dot-stopped";

          if (AppState.flags.hasPassedSticky) {
            AppState.dom.statusBox.textContent = "üéÑ Santa has just been here!";
            setDimUI(false);
          } else if (etaSeconds !== null && !moving) {
            AppState.dom.statusBox.textContent = "üéÑ Santa has stopped nearby!";
            setDimUI(false);
          } else if (etaSeconds !== null) {
            const mins = etaSeconds / 60;
            let etaText;
            if (mins < 2) etaText = "üéÖ Santa is nearly here!";
            else if (mins < 4) etaText = "üéÖ Santa is ~3 mins away!";
            else if (mins < 7) etaText = "üéÖ Santa is ~5 mins away!";
            else if (mins < 12) etaText = "üéÖ Santa is ~10 mins away!";
            else etaText = "üéÖ Santa is ~15 mins away!";
            AppState.dom.statusBox.textContent = etaText;
            setDimUI(mins > 45);
          } else if (moving) {
            AppState.dom.statusBox.textContent = "üéÖ Santa is out spreading joy!";
            setDimUI(false);
          } else {
            AppState.dom.statusBox.textContent = "üéÑ Santa has stopped to spread cheer!";
            setDimUI(false);
          }

          // Browser Notification
          if (AppState.vars.notifyLatLng && !AppState.flags.browserNotified && !AppState.flags.hasPassedSticky) {
             const straightDist = Utils.haversineMeters({ lat: data.lat, lng: data.lng }, AppState.vars.notifyLatLng);
             const isSmartEta = (etaSeconds !== null && etaSeconds < 180);
             const isCloseFallback = straightDist < AppConfig.NOTIFICATIONS.NEAR_DISTANCE_METERS && (etaSeconds === null || etaSeconds < 600);
             if (isSmartEta || isCloseFallback) {
                AppState.flags.browserNotified = true;
                sessionStorage.setItem("SANTA_BROWSER_NOTIFIED", "1");
                fireBrowserNotification("üéÖ Santa is nearly here!", "He's approaching your location! üéÑ");
             }
          }

          if (AppState.flags.firstFix) {
             const zoom = AppState.flags.isKiosk ? 15 : 16;
             AppState.map.setView(visualPos, zoom);
             AppState.flags.firstFix = false;
          }

        } catch (e) {
          if (AppState.lastFix) {
            animateMarkerTo(AppState.lastFix.lat, AppState.lastFix.lng);
            AppState.dom.statusBox.textContent = "üéÖ Santa is nearby‚Ä¶";
            AppState.dom.statusDot.style.display = "none";
            setDimUI(false);
          }
        }
        setTimeout(updateTracker, AppConfig.API.REFRESH_MS);
      }

      async function init() {
        const params = new URLSearchParams(location.search);
        AppState.flags.isKiosk = params.get("kiosk") === "1" || sessionStorage.getItem("SANTA_KIOSK") === "1";
        if (params.get("kiosk") === "1") sessionStorage.setItem("SANTA_KIOSK", "1");

        AppState.vars.apiUrl = params.get("api") || localStorage.getItem("SANTA_API") || sessionStorage.getItem("SANTA_API");
        if (!AppState.vars.apiUrl) { alert("Missing ?api=URL"); return; }
        localStorage.setItem("SANTA_API", AppState.vars.apiUrl);
        sessionStorage.setItem("SANTA_API", AppState.vars.apiUrl);

        if (!AppState.flags.isKiosk && location.search.includes("api=")) {
          history.replaceState(null, "", location.pathname);
        }

        requestWakeLock();
        setInterval(() => { if (document.visibilityState === "visible") requestWakeLock(); }, 60000);

        const apiData = await Utils.loadJSON(AppState.vars.apiUrl);
        const settings = apiData.settings || {};
        AppState.vars.sleighName = settings.sleigh_display_name || "Santa Sleigh";

        const today = new Date().toISOString().slice(0, 10);
        const route = (apiData.routes || []).find(r => r.date === today && r.gpxUrl) || null;
        AppState.vars.todayRoute = route;

        const don = apiData.donations || {};
        if (settings.donate_url) {
          const btn = AppState.dom.donateLink;
          btn.href = settings.donate_url;
          AppState.dom.donateBox.style.display = "block";
          btn.style.background = "";
          if (don.target && don.target > 0) {
            const pct = Math.min(100, Math.max(0, Math.round((don.total / don.target) * 100)));
            btn.style.background = `linear-gradient(90deg, #d31c1c ${pct}%, rgba(211, 28, 28, 0.3) ${pct}%)`;
          }
        } else {
          AppState.dom.donateBox.style.display = "none";
        }

        fetch(`${AppState.vars.apiUrl}?function=logView&ua=${encodeURIComponent(navigator.userAgent)}&source=web&route=${encodeURIComponent(AppState.vars.todayRoute ? AppState.vars.todayRoute.date : 'unknown')}`, { keepalive: true });

        if (AppState.flags.isKiosk && AppState.dom.kioskBanner) {
          const statusDiv = document.createElement('div');
          statusDiv.id = 'kioskStatus';
          statusDiv.textContent = 'üéÑ PREPARING IN LAPLAND';
          const subtitleDiv = document.createElement('div');
          subtitleDiv.className = 'kiosk-subtitle';
          subtitleDiv.textContent = AppState.vars.sleighName;
          AppState.dom.kioskBanner.innerHTML = '';
          AppState.dom.kioskBanner.appendChild(statusDiv);
          AppState.dom.kioskBanner.appendChild(subtitleDiv);
          AppState.dom.kioskBanner.classList.add("visible");
        }

        if (!route) {
          AppState.dom.notifyBtn.style.display = "none";
        } else {
          await loadGpxRoute(route.gpxUrl);
        }

        AppState.map = L.map("map", { zoomControl: !AppState.flags.isKiosk })
          .setView(AppConfig.LOCATIONS.LAPLAND, AppState.flags.isKiosk ? 6 : 5);

        AppState.map.on("zoomend", () => {
  if (!AppState.routeMainLayer || !AppState.routeGlowLayer) return;

  const z = AppState.map.getZoom();

  const mainWeight = z >= 17 ? 5 : z >= 15 ? 4 : 3;
  const glowWeight = mainWeight + 3;

  AppState.routeMainLayer.setStyle({ weight: mainWeight });
  AppState.routeGlowLayer.setStyle({ weight: glowWeight });
});

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(AppState.map);

        if (AppState.flags.isKiosk) {
           const m = AppState.map;
           m.dragging.disable(); m.scrollWheelZoom.disable(); m.doubleClickZoom.disable();
           m.boxZoom.disable(); m.keyboard.disable(); m.touchZoom.disable();
           AppState.dom.followBtn.style.display = "none";
           AppState.dom.recenterBtn.style.display = "none";
           AppState.dom.notifyBtn.style.display = "none";
           AppState.dom.donateBox.style.display = "none";
        }

        // ‚îÄ‚îÄ GPX ROUTE LAYERS ‚îÄ‚îÄ
if (route && AppState.flags.gpxLoaded) {

  // üü° Gold glow (bottom)
  AppState.routeGlowLayer = new L.GPX(route.gpxUrl, {
    async: true,
    polyline_options: {
      color: "#ffd700",
      weight: 7,
      opacity: 0.45
    },
    marker_options: {
      startIconUrl: null,
      endIconUrl: null,
      shadowUrl: null
    }
  }).addTo(AppState.map);

  // üî¥ Red route (top)
  AppState.routeMainLayer = new L.GPX(route.gpxUrl, {
    async: true,
    polyline_options: {
      color: "#d31c1c",
      weight: 4,
      opacity: 0.95
    },
    marker_options: {
      startIcon: L.icon({
        iconUrl: settings.sleigh_icon_start || AppConfig.ICONS.FALLBACK_START,
        iconSize: [48, 48],
        iconAnchor: [24, 48],
        shadowUrl: null
      }),
      endIcon: L.icon({
        iconUrl: settings.sleigh_icon_end || AppConfig.ICONS.FALLBACK_END,
        iconSize: [48, 48],
        iconAnchor: [24, 48],
        shadowUrl: null
      }),
      shadowUrl: null
    }
  }).addTo(AppState.map);

  AppState.routeMainLayer.on("loaded", () => {
  AppState.map.fire("zoomend");
});

}

        if (AppState.flags.isKiosk && route?.sponsorUrl && Utils.isValidImageUrl(route.sponsorUrl)) {
          const span = document.createElement('span');
          span.textContent = 'Proudly sponsored by';
          const img = document.createElement('img');
          img.src = route.sponsorUrl;
          img.alt = 'Sponsor';
          AppState.dom.sponsorBox.innerHTML = '';
          AppState.dom.sponsorBox.appendChild(span);
          AppState.dom.sponsorBox.appendChild(img);
        }

        if (!AppState.flags.isKiosk) {
           const savedPin = sessionStorage.getItem("SANTA_NOTIFY_POINT");
           if (savedPin) {
             try {
               const p = JSON.parse(savedPin);
               AppState.flags.browserNotified = false;
               sessionStorage.removeItem("SANTA_BROWSER_NOTIFIED");
               AppState.vars.notifyLatLng = { lat: p.lat, lng: p.lng };
               showNotifyMarker(p.lat, p.lng, true);
             } catch(e) {}
           }
        }

        AppState.map.on("click", e => {
           if (!AppState.flags.awaitingPin) return;
           const { lat, lng } = e.latlng;
           showNotifyMarker(lat, lng, false);
           AppState.dom.statusBox.textContent = "üìç Pin moved ‚Äî tap again to confirm";
        });

        if (settings.logo_overlay_url && Utils.isValidImageUrl(settings.logo_overlay_url)) {
          const posMap = { "top-left": "topleft", "top-right": "topright", "bottom-left": "bottomleft", "bottom-right": "bottomright", "center": "topright" };
          const LogoControl = L.control({ position: posMap[settings.logo_overlay_position] || "bottomright" });
          LogoControl.onAdd = () => { const img = L.DomUtil.create("img"); img.src = settings.logo_overlay_url; img.className = "logo-overlay"; return img; };
          LogoControl.addTo(AppState.map);
        }

        AppState.marker = L.marker(AppConfig.LOCATIONS.LAPLAND, {
          icon: L.icon({ iconUrl: settings.sleigh_icon_live || AppConfig.ICONS.FALLBACK_LIVE, iconSize: [64, 64], iconAnchor: [32, 60] })
        }).addTo(AppState.map);

        AppState.dom.followBtn.onclick = () => {
           AppState.flags.follow = !AppState.flags.follow;
           AppState.dom.followBtn.textContent = "Follow: " + (AppState.flags.follow ? "ON" : "OFF");
        };

        AppState.dom.recenterBtn.onclick = () => {
           AppState.flags.follow = true;
           AppState.dom.followBtn.textContent = "Follow: ON";
           AppState.map.panTo(AppState.marker.getLatLng());
        };

        AppState.dom.notifyBtn.onclick = () => {
          AppState.flags.follow = false;
          AppState.dom.followBtn.textContent = "Follow: OFF";
          AppState.flags.browserNotified = false;
          AppState.flags.hasPassedSticky = false;
          AppState.routeFixes = [];
          sessionStorage.removeItem("SANTA_BROWSER_NOTIFIED");
          sessionStorage.removeItem("SANTA_EMAIL_SUBSCRIBED");
          sessionStorage.removeItem("SANTA_NOTIFY_POINT");
          sessionStorage.removeItem("SANTA_HAS_PASSED");
          AppState.flags.awaitingPin = true;
          if (AppState.notifyMarker) { AppState.map.removeLayer(AppState.notifyMarker); }
          AppState.notifyMarker = null;
          AppState.vars.notifyLatLng = null;
          AppState.dom.statusBox.textContent = "üìç Tap the map to place your pin...";
          if (AppState.vars.escapeListener) { document.removeEventListener("keydown", AppState.vars.escapeListener); }
          AppState.vars.escapeListener = (e) => {
            if (e.key === "Escape" && AppState.flags.awaitingPin) {
              AppState.flags.awaitingPin = false;
              if (AppState.notifyMarker) AppState.map.removeLayer(AppState.notifyMarker);
              AppState.dom.statusBox.textContent = "";
              Utils.toggleFollowControls(true);
              document.removeEventListener("keydown", AppState.vars.escapeListener);
              AppState.vars.escapeListener = null;
            }
          };
          document.addEventListener("keydown", AppState.vars.escapeListener);
        };

        document.getElementById("modalCancelBtn").addEventListener("click", () => {
           document.getElementById("emailModal").style.display = "none";
           AppState.dom.statusBox.textContent = "Tap the pin to try again";
           if (AppState.vars.escapeListener) { document.removeEventListener("keydown", AppState.vars.escapeListener); AppState.vars.escapeListener = null; }
        });

        document.getElementById("modalConfirmBtn").addEventListener("click", () => {
          const email = document.getElementById("subEmail").value.trim();
          document.getElementById("emailModal").style.display = "none";
          if (AppState.vars.escapeListener) { document.removeEventListener("keydown", AppState.vars.escapeListener); AppState.vars.escapeListener = null; }
          Utils.toggleFollowControls(true);

          if (sessionStorage.getItem("SANTA_EMAIL_SUBSCRIBED") === "1") { showToast("üéÖ You're already signed up!"); return; }

          AppState.dom.statusBox.textContent = "üîî Saving your notification...";

          if (!AppState.vars.pendingSubscription) { showToast("‚ùå Error: No location selected."); return; }

          const url = `${AppState.vars.apiUrl}?function=subscribe&lat=${AppState.vars.pendingSubscription.lat}&lng=${AppState.vars.pendingSubscription.lng}&email=${encodeURIComponent(email)}`;

          fetch(url).then(r=>r.json()).then(d => {
            if (d.ok) {
               sessionStorage.setItem("SANTA_EMAIL_SUBSCRIBED", "1");
               const msg = email ? "üéÖ You're signed up! We'll email you when Santa is close." : "üéÖ You're signed up! Keep this page open for alerts.";
               showToast(msg);
               AppState.dom.statusBox.textContent = "";
               if (AppState.notifyMarker) { AppState.map.removeLayer(AppState.notifyMarker); AppState.notifyMarker = null; }
               AppState.vars.pendingSubscription = null;
            } else {
               showToast("‚ùå Error saving notification.");
               AppState.dom.statusBox.textContent = "‚ùå Failed to save.";
            }
          }).catch(() => {
            showToast("‚ùå Network error.");
            AppState.dom.statusBox.textContent = "‚ùå Connection failed.";
          });
        });

        if (settings.donate_url) { AppState.dom.donateLink.href = settings.donate_url; AppState.dom.donateBox.style.display = "block"; }
        else { AppState.dom.donateBox.style.display = "none"; }

        AppState.dom.loading.style.display = "none";
        SnowSystem.resize();
        window.addEventListener("resize", SnowSystem.resize);
        updateTracker();
        window.SantaDebug = { AppState, SnowSystem, animateMarkerTo, Utils, AppConfig };
      }

      document.addEventListener("visibilitychange", () => {
        AppState.flags.pageVisible = !document.hidden;
        if (AppState.flags.pageVisible) {
          if (AppState.flags.isKiosk) requestWakeLock();
          if (AppState.vars.lastVisualPos && AppState.marker) { AppState.marker.setLatLng(AppState.vars.lastVisualPos); }
          if (AppState.flags.snowActive) SnowSystem.draw();
        }
      });

      init();
    });
  </script>
</body>
</html>
