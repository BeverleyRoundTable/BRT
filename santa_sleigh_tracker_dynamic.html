<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Santa Sleigh Tracker</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/gpx.min.js"></script>

<style>
html,body{
  margin:0;padding:0;height:100%;
  background:#001;color:#fff;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
  overflow:hidden;
}
#map{width:100vw;height:100dvh;}

.status-popup{
  position:absolute;top:20px;left:50%;
  transform:translateX(-50%);
  background:rgba(24,24,24,.93);
  padding:16px 18px;
  font-size:1.2em;font-weight:800;
  border-radius:18px;
  min-width:260px;max-width:92%;
  box-shadow:0 4px 32px #0006;
  z-index:4000;text-align:center;
}
.status-popup.searching{animation:glow 1.3s ease-in-out infinite;}
@keyframes glow{
  0%{box-shadow:0 0 0 rgba(255,215,0,0);}
  50%{box-shadow:0 0 20px rgba(255,215,0,.6);}
  100%{box-shadow:0 0 0 rgba(255,215,0,0);}
}

.info-popup{
  position:fixed;left:50%;transform:translateX(-50%);
  bottom:14px;
  background:rgba(20,20,20,.92);
  padding:10px 12px;
  border-radius:12px;
  display:flex;gap:12px;
  font-size:.85em;font-weight:800;
  z-index:3000;
}
.muted{display:none}

.btn{
  background:#0b1220;color:#fff;
  border:1px solid #ffffff26;
  border-radius:10px;padding:6px 10px;
  cursor:pointer;font-weight:800;
}

#logoOverlay{
  position:fixed;
  z-index:2500;
  pointer-events:none;
  display:none;
}

</style>
</head>

<body>

<div class="status-popup searching" id="statusBox">
  üîç Searching for Santa‚Ä¶
</div>

<div class="info-popup">
  <span id="lastUpdated" class="muted">‚Äî</span>
  <span id="speed" class="muted">‚Äî</span>
  <button class="btn" id="followBtn">Follow: ON</button>
  <button class="btn" id="recenterBtn">Re-centre</button>
</div>

<div id="map"></div>
<img id="logoOverlay" />

<script>
/* ================= CONFIG ================= */
const REFRESH   = 5000;          // 5s GPS updates
const STALE_MS  = 5 * 60 * 1000; // 5 minutes
const LAPLAND   = { lat:66.5436, lng:25.8473 };

const FALLBACK_ICONS = {
  live:  "https://i.ibb.co/Qj3vDbSR/Santa-Marker-11.png",
  start: "https://i.ibb.co/PzDYmwzZ/Santa-Marker-4.png",
  end:   "https://i.ibb.co/39WF0kBd/Santa-Marker-5.png",
  logo:  "https://i.ibb.co/4Ztkn1Zf/RTGBI-Roundel.png"
};
const safe = (v,f)=>v&&String(v).trim()?v:f;

/* ================= STATE ================= */
let map, marker;
let follow=true, firstFix=true, lastFix=null;
let lastLiveTs=0;
let laplandMode=false;

/* ================= UTILS ================= */
const apiUrl = new URLSearchParams(location.search).get("api");
if(!apiUrl) alert("Missing ?api=YOUR_SCRIPT_URL");

async function loadJSON(url){
  const r = await fetch(url,{cache:"no-store"});
  if(!r.ok) throw new Error(r.status);
  return r.json();
}
const valid=(lat,lng)=>typeof lat==="number"&&typeof lng==="number"&&!isNaN(lat)&&!isNaN(lng);

/* ================= INIT ================= */
async function init(){
  const data = await loadJSON(apiUrl);
  const s = data.settings || {};
  const tracker = data.tracker || {};
  const routes = data.routes || [];

  document.documentElement.style.setProperty("--primaryColor",s.primary_color||"#d31c1c");

  map = L.map("map",{zoomControl:false}).setView([LAPLAND.lat,LAPLAND.lng], s.default_map_zoom||13);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

  /* ---------- LOGO ---------- */
  if(s.logo_overlay_enabled===true||s.logo_overlay_enabled==="true"){
    const logo=document.getElementById("logoOverlay");
    logo.src=safe(s.logo_overlay_url,FALLBACK_ICONS.logo);
    logo.style.width=(s.logo_overlay_size||64)+"px";
    logo.style.display="block";
    logo.style.bottom="18px";
    logo.style.right="18px";
  }

  /* ---------- GPX ---------- */
  if(tracker.enable_gpx_overlay===true||tracker.enable_gpx_overlay==="true"){
    const today=new Date().toISOString().slice(0,10);
    const route=routes.find(r=>new Date(r.date).toISOString().slice(0,10)>=today && r.gpxUrl);
    if(route){
      new L.GPX(route.gpxUrl,{
        async:true,
        polyline_options:{color:s.primary_color||"#d31c1c",weight:5,opacity:.9},
        marker_options:{
          startIcon:L.icon({iconUrl:safe(s.sleigh_icon_start,FALLBACK_ICONS.start),iconSize:[42,42],iconAnchor:[21,38]}),
          endIcon:L.icon({iconUrl:safe(s.sleigh_icon_end,FALLBACK_ICONS.end),iconSize:[42,42],iconAnchor:[21,38]}),
          wptIconUrls:{ "":"" }
        }
      }).addTo(map);
    }
  }

  marker = L.marker([LAPLAND.lat,LAPLAND.lng],{
    icon:L.icon({iconUrl:safe(s.sleigh_icon_live,FALLBACK_ICONS.live),iconSize:[64,64],iconAnchor:[32,32]})
  }).addTo(map);

  followBtn.onclick=()=>{follow=!follow;followBtn.textContent="Follow: "+(follow?"ON":"OFF")};
  recenterBtn.onclick=()=>{follow=true;map.panTo(marker.getLatLng())};

  tick();
}

/* ================= SMOOTH LAPLAND ================= */
function smoothReturnToLapland(){
  if(laplandMode) return;
  laplandMode=true;
  follow=false;
  firstFix=true;

  statusBox.textContent="üéÑ Santa is heading back to Lapland‚Ä¶";

  const z1=Math.max(map.getZoom()-3,8);
  map.flyTo([LAPLAND.lat,LAPLAND.lng],z1,{duration:2.6});
  marker.setLatLng([LAPLAND.lat,LAPLAND.lng]);

  setTimeout(()=>{
    map.flyTo([LAPLAND.lat,LAPLAND.lng],13,{duration:1.6});
    statusBox.textContent="üéÑ Santa is in Lapland preparing for Christmas!";
  },2600);
}

/* ================= POLLING ================= */
async function tick(){
  try{
    const p=await loadJSON(apiUrl+"?function=proxyFirebase");
    if(!p||!valid(p.lat,p.lng)) throw 0;

    const ts=new Date(p.ts).getTime();
    if(Date.now()-ts>STALE_MS) throw 0;

    laplandMode=false;
    lastLiveTs=ts;

    const ll=L.latLng(p.lat,p.lng);
    marker.setLatLng(ll);

    if(firstFix){
      map.setView(ll,15);
      firstFix=false;
    }else if(follow){
      map.panTo(ll);
    }

    let sp="‚Äî";
    if(lastFix){
      const d=lastFix.latLng.distanceTo(ll),dt=(ts-lastFix.ts)/1000;
      if(dt>0){const mph=(d/dt)*2.23694;if(mph<150) sp=`${mph.toFixed(1)} mph`;}
    }
    lastFix={latLng:ll,ts};

    lastUpdated.textContent="Updated "+new Date(ts).toLocaleTimeString("en-GB");
    speed.textContent=sp;
    lastUpdated.style.display=speed.style.display="inline";

    statusBox.textContent="üéÖ Santa is out spreading joy!";
  }catch{
    smoothReturnToLapland();
  }
  setTimeout(tick,REFRESH);
}

init();
</script>
</body>
</html>
