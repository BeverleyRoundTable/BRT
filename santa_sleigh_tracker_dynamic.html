<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Santa Sleigh Tracker</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/gpx.min.js"></script>

<style>
html,body{
  margin:0;padding:0;height:100%;
  background:#001;color:#fff;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
  overflow:hidden;
}
#map{width:100vw;height:100dvh;min-height:100vh;}
</style>
</head>

<body>

<div id="map"></div>
<div class="status-popup searching" id="statusBox">üîç Searching for Santa‚Ä¶</div>

<script>
/* ------------------------------------------------------------
   GLOBALS
------------------------------------------------------------ */
let firebaseURL = null;
let map, marker;
let lastFix = null;
let follow = true;
let firstLiveFix = true;

/* ------------------------------------------------------------
   API
------------------------------------------------------------ */
const urlParams = new URLSearchParams(window.location.search);
const apiUrl = urlParams.get("api") || urlParams.get("sleigh_api");
if (!apiUrl) alert("‚ùå No API provided. Use ?api=YOUR_SCRIPT_URL");

async function loadJSON(url){
  const r = await fetch(url,{cache:"no-store"});
  if (!r.ok) throw new Error("HTTP "+r.status);
  return r.json();
}

function isValidLatLng(lat,lng){
  return typeof lat==="number" && typeof lng==="number" &&
         !isNaN(lat)&&!isNaN(lng) &&
         lat>=-90&&lat<=90 && lng>=-180&&lng<=180;
}

/* ------------------------------------------------------------
   INIT
------------------------------------------------------------ */
async function init(){
  const data = await loadJSON(apiUrl);

  const tracker  = data.tracker  || {};
  const settings = data.settings || {};

  /* ‚úÖ BUILD FIREBASE URL HERE (CORRECT SCOPE) */
  firebaseURL =
    tracker.firebase_url.replace(/\/$/, "") +
    "/" +
    tracker.firebase_path.replace(/^\/?/, "") +
    ".json?cb=" + Date.now();

  /* MAP */
  const fallback = { lat:66.5436, lng:25.8473 };
  map = L.map("map").setView([fallback.lat,fallback.lng], settings.default_map_zoom || 13);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

  marker = L.marker([fallback.lat,fallback.lng]).addTo(map);
}

/* ------------------------------------------------------------
   FIREBASE POLLING
------------------------------------------------------------ */
const REFRESH = 8000;
const STALE_MS = 5 * 60000;

async function tick(){
  try{
    if (!firebaseURL) throw new Error("Firebase URL not ready");

    const p = await loadJSON(firebaseURL);

    if (!p || !isValidLatLng(p.lat,p.lng)) throw new Error("Bad GPS");

    const ts = new Date(p.ts).getTime();
    if (isNaN(ts)) throw new Error("Bad timestamp");

    const age = Date.now() - ts;
    if (age > STALE_MS) throw new Error("Stale GPS");

    document.getElementById("statusBox").textContent =
      "üéÖ Santa is out spreading joy!";

    const newLatLng = L.latLng(p.lat,p.lng);

    marker.setLatLng(newLatLng);

    if (firstLiveFix){
      firstLiveFix = false;
      map.setView(newLatLng, 16);
    } else if (follow){
      map.panTo(newLatLng);
    }

    lastFix = { lat:p.lat, lng:p.lng, ts };

  } catch (e){
    document.getElementById("statusBox").textContent =
      "üéÑ Santa is currently in Lapland preparing for Christmas!";
  }

  setTimeout(tick, REFRESH);
}

/* ------------------------------------------------------------
   BOOTSTRAP
------------------------------------------------------------ */
(async ()=>{
  try{
    await init();
  } finally {
    tick();
  }
})();
</script>

</body>
</html>
