<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Santa Sleigh Tracker</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
  html, body {
    margin:0; padding:0;
    height:100%;
    background:#001;
    color:white;
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
    overflow:hidden;
  }

  #map { width:100vw; height:100vh; }

  .status-popup {
    position:absolute;
    top:24px; left:50%; transform:translateX(-50%);
    background:rgba(24,24,24,0.93);
    padding:16px 18px 12px;
    font-size:1.25em; font-weight:700;
    border-radius:18px; min-width:250px;
    box-shadow:0 4px 32px #0006;
    z-index:2000;
    text-align:center;
  }

  .sponsor-popup {
    position:absolute;
    top:90px;
    left:50%; transform:translateX(-50%);
    background:rgba(24,24,24,0.93);
    padding:10px 14px;
    font-size:1em; font-weight:700;
    border-radius:14px;
    box-shadow:0 4px 24px #0006;
    z-index:2000;
    display:none;
    align-items:center;
    gap:10px;
  }

  .sponsor-popup img {
    height:36px; width:36px;
    border-radius:50%;
    object-fit:cover;
  }

  .donate-box {
      position:fixed;
      bottom:110px;
      left:50%;
      transform:translateX(-50%);
      width:70%;
      max-width:420px;
      z-index:2000;
  }

  .donate-btn {
      background:var(--primaryColor,#d31c1c);
      color:#fff;
      padding:14px 0;
      width:100%;
      display:block;
      text-align:center;
      border-radius:14px;
      font-weight:800;
      text-decoration:none;
      font-size:1.05em;
      box-shadow:0 4px 16px rgba(0,0,0,0.4);
  }

  .info-popup {
    position:fixed;
    left:50%; transform:translateX(-50%);
    bottom:16px;
    background:rgba(20,20,20,0.92);
    padding:10px 12px;
    border-radius:12px;
    display:flex; gap:12px;
    font-size:.85em; font-weight:700;
    z-index:2000;
  }

  .muted { display:none; opacity:.9; }

  .btn {
    background:#0b1220; color:#fff;
    border:1px solid #ffffff26;
    border-radius:10px; padding:6px 10px;
    cursor:pointer; font-weight:800;
  }
</style>
</head>

<body>

<div class="status-popup" id="statusBox">
  üéÑ Santa is currently in Lapland preparing for Christmas!
</div>

<div class="sponsor-popup" id="sponsorBox">
  <span id="sponsorText">Tonight‚Äôs sponsor</span>
  <img id="sponsorLogo" src="" alt="">
</div>

<div class="donate-box">
  <a id="donateLink" class="donate-btn" target="_blank">üéÅ DONATE & SUPPORT US</a>
</div>

<div class="info-popup">
  <span id="lastUpdated" class="muted">Last update: ‚Äî</span>
  <span id="age" class="muted">Age: ‚Äî</span>
  <button class="btn" id="followBtn">Follow Santa: ON</button>
  <button class="btn" id="recenterBtn">Re-centre</button>
</div>

<canvas id="snow"></canvas>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ------------------------------------------------------------
   READ API PARAMETER
------------------------------------------------------------ */
const urlParams = new URLSearchParams(window.location.search);
const apiUrl =
    urlParams.get("api") ||
    urlParams.get("sleigh_api");

if (!apiUrl) {
  alert("No API provided. Use ?api=YOUR_GOOGLE_SCRIPT_URL");
}

/* Helper */
async function loadJSON(url){
  const r = await fetch(url, {cache:"no-store"});
  return r.json();
}

async function init(){

  const data = await loadJSON(apiUrl);

  const settings = data.settings || {};
  const routes = data.routes || [];
  const tracker = data.tracker || {};

  /* ------------------------------------------------------------
     UK LOCAL DATE (fix sponsor not showing)
  ------------------------------------------------------------ */
  const today = new Date().toLocaleDateString("en-GB", {
    year: "numeric",
    month: "2-digit",
    day: "2-digit"
  }).split("/").reverse().join("-");

  /* Theme */
  document.documentElement.style.setProperty(
    "--primaryColor", settings.primary_color || "#d31c1c"
  );

  document.getElementById("donateLink").href =
    tracker.donate_url || "#";

  /* ------------------------------------------------------------
     SPONSOR ‚Äî ONLY SHOW IF TODAY MATCHES
------------------------------------------------------------ */
  function getSponsor(r) {
    return r.sponsorurl || r.sponsorUrl || null;
  }

  // Normalise dates (handles Google Sheets timestamps)
const todaysRoute = routes.find(r => {
  if (!r.date) return false;
  const d = String(r.date).slice(0,10);  // e.g. "2025-12-04"
  return d === today;
});

const sponsor = todaysRoute ? getSponsor(todaysRoute) : null;

  if (sponsor && sponsor.trim() !== "") {
    document.getElementById("sponsorLogo").src = sponsor;
    document.getElementById("sponsorBox").style.display = "flex";
  } else {
    document.getElementById("sponsorBox").style.display = "none";
  }

  /* ------------------------------------------------------------
     MAP + TRACKING
------------------------------------------------------------ */
  const fallback = { lat:66.5436, lng:25.8473 };

  const map = L.map("map").setView(
    [fallback.lat, fallback.lng],
    settings.default_map_zoom || 13
  );

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png")
    .addTo(map);

  const markerIcon = L.icon({
    iconUrl: tracker.map_icon || "https://i.ibb.co/4ZMk1PD9/Santa-Marker-8.png",
    iconSize:[64,64], iconAnchor:[32,32]
  });

  const marker = L.marker([fallback.lat,fallback.lng],{icon:markerIcon})
                  .addTo(map);

  let follow = true;
  const followBtn = document.getElementById("followBtn");

  followBtn.addEventListener("click",()=>{
    follow = !follow;
    followBtn.textContent = `Follow Santa: ${follow?"ON":"OFF"}`;
  });

  map.on("dragstart zoomstart", ()=>{
    if(follow){
      follow = false;
      followBtn.textContent="Follow Santa: OFF";
    }
  });

  document.getElementById("recenterBtn").addEventListener("click",()=>{
    follow = true;
    followBtn.textContent="Follow Santa: ON";
    map.panTo(marker.getLatLng());
  });

  /* Firebase */
  const firebaseURL =
    tracker.firebase_url.replace(/\/$/,"") +
    tracker.firebase_path +
    ".json";

  const REFRESH = 8000;
  const STALE_MS = 5 * 60000;

  const statusBox = document.getElementById("statusBox");
  const lastUpdated = document.getElementById("lastUpdated");
  const ageEl = document.getElementById("age");

  async function tick(){
    try {
      const raw = await loadJSON(firebaseURL);

      const key = Object.keys(raw)[0];
      const p = raw[key];

      if(!p || !p.lat){ throw "Bad GPS"; }

      const ts = new Date(p.ts).getTime();
      const age = Date.now() - ts;

      if(age < STALE_MS){
        statusBox.textContent = "üéÖ Santa is out on his sleigh delivering joy!";
        marker.setLatLng([p.lat,p.lng]);
        if(follow) map.panTo([p.lat,p.lng]);

        lastUpdated.style.display="inline";
        ageEl.style.display="inline";

        lastUpdated.textContent =
          "Last update: " + new Date(p.ts).toLocaleTimeString("en-GB");

        ageEl.textContent = "Age: " + Math.floor(age/1000)+"s";
      } 
      else {
        statusBox.textContent =
          "üéÑ Santa is currently in Lapland preparing for Christmas!";
      }
    } catch {
      statusBox.textContent =
        "üéÑ Santa is currently in Lapland preparing for Christmas!";
    }

    setTimeout(tick, REFRESH);
  }

  tick();
}

init();
</script>

</body>
</html>
