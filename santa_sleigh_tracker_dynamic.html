<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Santa Sleigh Tracker</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- GPX library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/gpx.min.js"></script>

<style>
  html, body {
    margin:0; padding:0;
    height:100%;
    background:#001;
    color:white;
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
    overflow:hidden;
  }

  #map { width:100vw; height:100vh; }

  .status-popup {
    position:absolute;
    top:24px;
    left:50%;
    transform:translateX(-50%);
    background:rgba(24,24,24,0.93);
    padding:16px 18px 14px;
    font-size:1.2em;
    font-weight:700;
    border-radius:18px;
    min-width:250px;
    max-width:90%;
    box-shadow:0 4px 32px #0006;
    z-index:4000;
    text-align:center;
    line-height:1.25em;
  }

  .donate-box {
    position:fixed;
    bottom:110px;
    left:50%;
    transform:translateX(-50%);
    width:70%;
    max-width:420px;
    z-index:2000;
  }

  .donate-btn {
    background:var(--primaryColor,#d31c1c);
    color:white;
    padding:14px 0;
    width:100%;
    display:block;
    text-align:center;
    border-radius:14px;
    font-weight:800;
    text-decoration:none;
    font-size:1.05em;
    box-shadow:0 4px 16px rgba(0,0,0,0.4);
  }

  .info-popup {
    position:fixed;
    left:50%; transform:translateX(-50%);
    bottom:16px;
    background:rgba(20,20,20,0.92);
    padding:10px 12px;
    border-radius:12px;
    display:flex; gap:12px;
    font-size:.85em; font-weight:700;
    z-index:2000;
  }

  .muted { display:none; opacity:.9; }

  .btn {
    background:#0b1220; color:#fff;
    border:1px solid #ffffff26;
    border-radius:10px; padding:6px 10px;
    cursor:pointer; font-weight:800;
  }

  #logoOverlay {
    position:absolute;
    z-index:5000;
    pointer-events:none;
  }
</style>
</head>

<body>

<div class="status-popup" id="statusBox">
  üéÑ Santa is currently in Lapland preparing for Christmas!
</div>

<div class="donate-box">
  <a id="donateLink" class="donate-btn" target="_blank">üéÅ DONATE & SUPPORT US</a>
</div>

<div class="info-popup">
  <span id="lastUpdated" class="muted">Last update: ‚Äî</span>
  <span id="age" class="muted">Age: ‚Äî</span>
  <button class="btn" id="followBtn">Follow Santa: ON</button>
  <button class="btn" id="recenterBtn">Re-centre</button>
</div>

<div id="map"></div>
<img id="logoOverlay" style="display:none;" />

<script>
/* ------------------------------------------------------------
   UTILS
------------------------------------------------------------ */
const urlParams = new URLSearchParams(window.location.search);
const apiUrl = urlParams.get("api") || urlParams.get("sleigh_api");

if (!apiUrl) alert("‚ùå No API provided. Use ?api=YOUR_SCRIPT_URL");

async function loadJSON(url){
  const r = await fetch(url, { cache:"no-store" });
  return r.json();
}

function normaliseDate(d) {
  const dt = new Date(d);
  return isNaN(dt) ? null : dt.toISOString().slice(0,10);
}

function normaliseGpxUrl(url){
  if (!url) return url;
  if (url.includes("github.com") && url.includes("/blob/")) {
    return url
      .replace("github.com","raw.githubusercontent.com")
      .replace("/blob/","/");
  }
  return url;
}

/* ------------------------------------------------------------
   ‚≠ê Detect active route for analytics & status
------------------------------------------------------------ */
function detectActiveRoute(routes) {
  const today = new Date().toISOString().slice(0,10);

  let todayMatch = routes.find(r => normaliseDate(r.date) === today);
  if (todayMatch) return todayMatch.routeName || todayMatch.route || "";

  let futureRoutes = routes
    .map(r => ({ r, d: normaliseDate(r.date) }))
    .filter(x => x.d >= today)
    .sort((a,b) => a.d.localeCompare(b.d));

  return futureRoutes.length ? futureRoutes[0].r.routeName : "";
}

/* ------------------------------------------------------------
   MAIN INIT
------------------------------------------------------------ */
async function init(){
  const data = await loadJSON(apiUrl);

  const settings = data.settings || {};
  const routes   = data.routes   || [];
  const tracker  = data.tracker  || {};

  // ‚≠ê Store active route for analytics
  window.ACTIVE_ROUTE = detectActiveRoute(routes);

  const today = new Date().toISOString().slice(0,10);

  document.documentElement.style.setProperty(
    "--primaryColor", settings.primary_color || "#d31c1c"
  );

  document.getElementById("donateLink").href =
    tracker.donate_url || settings.donate_url || "#";

  /* ------------------------------------------------------------
     SPONSOR LOGIC
  ------------------------------------------------------------ */
  function getSponsor(r) {
    return r.sponsorurl || r.sponsorUrl || "";
  }

  const todaysRoute = routes.find(r => normaliseDate(r.date) === today);
  const sponsor = todaysRoute ? getSponsor(todaysRoute) : null;

  const statusBox = document.getElementById("statusBox");

  function setActiveStatus(){
    if (sponsor) {
      statusBox.innerHTML = `
        üéÖ Santa is out on his sleigh spreading joy!<br>
        <span style="font-size:0.75em;opacity:0.9;">Sponsored by:</span><br>
        <img src="${sponsor}" style="height:32px;margin-top:4px;border-radius:6px;">
      `;
    } else {
      statusBox.textContent =
        "üéÖ Santa is out on his sleigh spreading joy!";
    }
  }

  function setLaplandStatus(){
    statusBox.textContent =
      "üéÑ Santa is currently in Lapland preparing for Christmas!";
  }

  /* ------------------------------------------------------------
     MAP
  ------------------------------------------------------------ */
  const fallback = { lat:66.5436, lng:25.8473 };

  const map = L.map("map").setView(
    [fallback.lat, fallback.lng],
    settings.default_map_zoom || 13
  );

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png")
    .addTo(map);

  /* ------------------------------------------------------------
     LOGO OVERLAY
  ------------------------------------------------------------ */
  if (settings.logo_overlay_enabled === "true" || settings.logo_overlay_enabled === true) {
    const logo = document.getElementById("logoOverlay");
    if (settings.logo_overlay_url){
      logo.src = settings.logo_overlay_url;
      logo.style.display = "block";
      const size = Number(settings.logo_overlay_size || 64);
      logo.style.width = size + "px";

      switch ((settings.logo_overlay_position || "").trim()){
        case "bottom-right": logo.style.bottom="20px"; logo.style.right="20px"; break;
        case "top-right": logo.style.top="20px"; logo.style.right="20px"; break;
        case "bottom-left": logo.style.bottom="20px"; logo.style.left="20px"; break;
        case "top-left": logo.style.top="20px"; logo.style.left="20px"; break;
        case "center":
          logo.style.top="50%"; logo.style.left="50%";
          logo.style.transform="translate(-50%, -50%)";
          break;
      }
    }
  }

  /* ------------------------------------------------------------
     GPX OVERLAY
  ------------------------------------------------------------ */
  if (tracker.enable_gpx_overlay === "true" || tracker.enable_gpx_overlay === true) {

    const gpxMode = tracker.gpx_mode || settings.gpx_mode || "next";
    let routeToShow = null;

    if (gpxMode === "today") {
      routeToShow = todaysRoute || null;

    } else {
      routeToShow = todaysRoute;
      if (!routeToShow) {
        const futureRoutes = routes
          .map(r => ({ r, d: normaliseDate(r.date) }))
          .filter(x => x.d >= today)
          .sort((a,b) => a.d.localeCompare(b.d));

        if (futureRoutes.length) routeToShow = futureRoutes[0].r;
      }
    }

    if (routeToShow && routeToShow.gpxUrl) {

      const gpxUrl = normaliseGpxUrl(routeToShow.gpxUrl);

      const startIcon = L.icon({
        iconUrl: settings.sleigh_icon_start ||
                 "https://i.ibb.co/PzDYmwzZ/Santa-Marker-4.png",
        iconSize:[42,42], iconAnchor:[21,38]
      });

      const endIcon = L.icon({
        iconUrl: settings.sleigh_icon_end ||
                 "https://i.ibb.co/39WF0kBd/Santa-Marker-5.png",
        iconSize:[42,42], iconAnchor:[21,38]
      });

      new L.GPX(gpxUrl, {
        async: true,
        marker_options: {
          startIcon: startIcon,
          endIcon: endIcon,
          wptIconUrls: { "": "" }
        },
        polyline_options: {
          color: settings.primary_color || "#d31c1c",
          weight: 5,
          opacity: 0.9
        }
      })
      .on("loaded", e => {
        map.fitBounds(e.target.getBounds(), { padding:[50,50] });
      })
      .addTo(map);
    }
  }

  /* ------------------------------------------------------------
     LIVE TRACKING MARKER
  ------------------------------------------------------------ */
  const liveIconUrl =
    settings.sleigh_icon_live ||
    settings.map_icon || 
    "https://i.ibb.co/4ZMk1PD9/Santa-Marker-8.png";

  const markerIcon = L.icon({
    iconUrl: liveIconUrl,
    iconSize:[64,64], iconAnchor:[32,32]
  });

  const marker = L.marker([fallback.lat,fallback.lng],{icon:markerIcon}).addTo(map);

  let follow = true;

  document.getElementById("followBtn").onclick = () => {
    follow = !follow;
    event.target.textContent = `Follow Santa: ${follow?"ON":"OFF"}`;
  };

  map.on("dragstart zoomstart", ()=>{
    follow = false;
    document.getElementById("followBtn").textContent="Follow Santa: OFF";
  });

  document.getElementById("recenterBtn").onclick = () => {
    follow = true;
    document.getElementById("followBtn").textContent="Follow Santa: ON";
    map.panTo(marker.getLatLng());
  };

  /* ------------------------------------------------------------
     FIREBASE POLLING
  ------------------------------------------------------------ */
  const firebaseURL =
    tracker.firebase_url.replace(/\/$/,"") +
    tracker.firebase_path +
    ".json";

  const REFRESH = 8000;
  const STALE_MS = 5 * 60000;

  async function tick(){
    try {
      const raw = await loadJSON(firebaseURL);
      const key = Object.keys(raw)[0];
      const p = raw[key];

      if (!p || !p.lat) throw "No GPS";

      const ts = new Date(p.ts).getTime();
      const age = Date.now() - ts;

      if (age < STALE_MS) {
        setActiveStatus();

        marker.setLatLng([p.lat,p.lng]);
        if(follow) map.panTo([p.lat,p.lng]);

        document.getElementById("lastUpdated").style.display="inline";
        document.getElementById("age").style.display="inline";

        document.getElementById("lastUpdated").textContent =
          "Last update: " + new Date(p.ts).toLocaleTimeString("en-GB");

        document.getElementById("age").textContent =
          "Age: " + Math.floor(age/1000)+"s";
      } else {
        setLaplandStatus();
      }

    } catch (e) {
      setLaplandStatus();
    }

    setTimeout(tick, REFRESH);
  }

  tick();
}

/* ------------------------------------------------------------
   ‚≠ê ANALYTICS ‚Äî Send UA + route AFTER init completes
------------------------------------------------------------ */
async function sendAnalytics() {
  const api = apiUrl;
  if (!api) return;

  await new Promise(res => setTimeout(res, 500)); // ensure ACTIVE_ROUTE populated

  const ua = /Mobi|Android/i.test(navigator.userAgent)
    ? "mobile"
    : "desktop";

  const route = encodeURIComponent(window.ACTIVE_ROUTE || "");

  fetch(
    api +
    "?function=logView" +
    "&source=tracker" +
    "&ua=" + ua +
    "&route=" + route
  ).catch(err => console.warn("Analytics error:", err));
}

// ‚≠ê Only call init ONCE
init().then(sendAnalytics);
</script>

</body>
</html>
