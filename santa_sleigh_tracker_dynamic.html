<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Santa Sleigh Tracker</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html,body{
  margin:0;padding:0;height:100%;
  background:#001;color:#fff;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
  overflow:hidden;
}
#map{width:100vw;height:100dvh;min-height:100vh;}

/* ================= STATUS BOX ================= */
.status-popup{
  position:absolute;
  top:24px;
  left:50%;
  transform:translateX(-50%);
  background:rgba(24,24,24,.93);
  padding:14px 20px;
  font-size:1.15em;
  font-weight:800;
  border-radius:18px;
  min-width:260px;
  max-width:90%;
  box-shadow:0 4px 32px #0006;
  z-index:4000;
  text-align:center;
  transition:opacity .6s ease;
}

/* ================= DONATE ================= */
.donate-box{
  position:fixed;
  bottom:110px;
  left:50%;
  transform:translateX(-50%);
  width:70%;
  max-width:420px;
  z-index:2000;
}
.donate-btn{
  background:#d31c1c;
  color:#fff;
  padding:16px 0;
  display:block;
  text-align:center;
  border-radius:16px;
  font-weight:900;
  text-decoration:none;
  box-shadow:0 4px 16px rgba(0,0,0,.4);
}

/* ================= INFO BAR ================= */
.info-popup{
  position:fixed;
  bottom:16px;
  left:50%;
  transform:translateX(-50%);
  background:rgba(20,20,20,.92);
  padding:10px 12px;
  border-radius:14px;
  display:flex;
  align-items:center;
  gap:10px;
  z-index:2000;
  transition:all .4s ease;
}

/* LEFT telemetry ‚Äî expands LEFT only */
.info-left{
  display:flex;
  gap:8px;
  white-space:nowrap;
  opacity:0;
  max-width:0;
  overflow:hidden;
  transition:all .4s ease;
}

.info-popup.active .info-left{
  opacity:1;
  max-width:220px;
}

.info-right{
  display:flex;
  gap:8px;
}

/* Buttons */
.btn{
  background:#0b1220;
  color:#fff;
  border:1px solid #ffffff26;
  border-radius:10px;
  padding:8px 12px;
  cursor:pointer;
  font-weight:800;
}

/* ================= LOGO ================= */
#logoOverlay{
  position:fixed;
  bottom:16px;
  right:16px;
  width:64px;
  z-index:5000;
  pointer-events:none;
}
</style>
</head>

<body>

<div class="status-popup" id="statusBox">
  üîç Searching for Santa‚Ä¶
</div>

<div class="donate-box" id="donateBox">
  <a id="donateLink" class="donate-btn" target="_blank">
    üéÅ DONATE & SUPPORT US
  </a>
</div>

<div class="info-popup" id="infoBar">
  <div class="info-left" id="telemetry">
    <span id="lastUpdated">‚Äî</span>
    <span id="speed">‚Äî</span>
  </div>
  <div class="info-right">
    <button class="btn" id="followBtn">Follow: ON</button>
    <button class="btn" id="recenterBtn">Re-centre</button>
  </div>
</div>

<div id="map"></div>
<img id="logoOverlay" />

<script>
const apiUrl = new URLSearchParams(location.search).get("api");
if(!apiUrl) alert("Missing ?api=");

const REFRESH = 5000;
const STALE_MS = 5 * 60000;

let map, marker;
let follow = true;
let lastFix = null;
let santaActive = false;

async function loadJSON(url){
  const r = await fetch(url,{cache:"no-store"});
  if(!r.ok) throw new Error();
  return r.json();
}

function setLapland(){
  if(!santaActive) return;
  santaActive = false;

  statusBox.textContent =
    "üéÑ Santa is in Lapland preparing for Christmas!";
  infoBar.classList.remove("active");

  marker.setOpacity(0.4);
  map.flyTo([66.5436,25.8473], 5, {duration:2});
}

function setActive(){
  if(santaActive) return;
  santaActive = true;

  statusBox.textContent =
    "üéÖ Santa is out spreading joy!";
  infoBar.classList.add("active");
  marker.setOpacity(1);
}

async function init(){
  const data = await loadJSON(apiUrl);
  const s = data.settings || {};

  if(s.donate_url){
    donateLink.href = s.donate_url;
  }else{
    donateBox.style.display = "none";
  }

  if(s.logo_overlay_enabled){
    logoOverlay.src = s.logo_overlay_url;
  }else{
    logoOverlay.style.display="none";
  }

  map = L.map("map").setView([66.5436,25.8473], s.default_map_zoom||13);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

  marker = L.marker([66.5436,25.8473]).addTo(map);

  followBtn.onclick = ()=>{
    follow = !follow;
    followBtn.textContent = "Follow: " + (follow?"ON":"OFF");
  };
  recenterBtn.onclick = ()=>{
    follow = true;
    map.panTo(marker.getLatLng());
  };

  tick();
}

async function tick(){
  try{
    const p = await loadJSON(apiUrl+"?function=proxyFirebase");
    if(!p || !p.lat || !p.lng) throw 0;

    const ts = new Date(p.ts).getTime();
    if(Date.now() - ts > STALE_MS) throw 0;

    setActive();

    const ll = L.latLng(p.lat,p.lng);
    marker.setLatLng(ll);
    if(follow) map.panTo(ll);

    let mph = "‚Äî";
    if(lastFix){
      const d = lastFix.latLng.distanceTo(ll);
      const dt = (ts - lastFix.ts)/1000;
      if(dt>0){
        const v = (d/dt)*2.23694;
        if(v < 150) mph = v.toFixed(1)+" mph";
      }
    }
    lastFix = {latLng:ll, ts};

    lastUpdated.textContent =
      "Updated " + new Date(p.ts).toLocaleTimeString("en-GB");
    speed.textContent = mph;

  }catch{
    setLapland();
  }
  setTimeout(tick, REFRESH);
}

init();
</script>
</body>
</html>
