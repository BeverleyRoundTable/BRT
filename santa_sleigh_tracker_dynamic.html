<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Santa Sleigh Tracker</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
  html, body {
    margin:0; padding:0;
    height:100%;
    background:#001;
    color:white;
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
  }
  #map { width:100vw; height:100vh; }

  .status-popup {
    position:absolute;
    top:24px; left:50%; transform:translateX(-50%);
    background:rgba(24,24,24,0.93);
    padding:16px 18px 12px 18px;
    font-size:1.25em; font-weight:700;
    border-radius:18px;
    box-shadow:0 4px 32px #0006;
    z-index:2000;
    text-align:center;
    min-width:250px;
  }

  .donate-box {
    position:fixed;
    bottom:70px;
    left:50%; transform:translateX(-50%);
    z-index:2000;
  }

  .donate-btn {
    background:var(--primaryColor,#d31c1c);
    color:#fff;
    padding:12px 20px;
    border-radius:14px;
    font-weight:800;
    text-decoration:none;
    box-shadow:0 4px 16px rgba(0,0,0,0.4);
  }

  .info-popup {
    position:fixed;
    left:50%; transform:translateX(-50%);
    bottom:16px;
    background:rgba(20,20,20,0.92);
    padding:10px 12px;
    border-radius:12px;
    font-size:.85em;
    font-weight:700;
    display:flex; gap:12px;
    z-index:2000;
  }

  .btn {
    background:#0b1220; color:#fff;
    border:1px solid #ffffff26;
    border-radius:10px;
    padding:6px 10px;
    cursor:pointer;
  }
</style>
</head>

<body>

<div class="status-popup" id="statusBox">Loading Santa‚Ä¶</div>

<div class="donate-box">
  <a id="donateLink" class="donate-btn" target="_blank">üéÅ DONATE & SUPPORT US</a>
</div>

<div class="info-popup">
  <span id="lastUpdated">Last update: ‚Äî</span>
  <span id="age">Age: ‚Äî</span>
  <button class="btn" id="followBtn">Follow Santa: ON</button>
  <button class="btn" id="recenterBtn">Re-centre</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ============================================================
   LOAD MASTER ‚Üí GET api_url ‚Üí LOAD USER DATA
============================================================ */
const MASTER_SHEET_URL =
  "YOUR_OWN_MASTER_SHEET_EXEC_URL_HERE";   // <-- CHANGE THIS

async function loadSheet(url){
  const res = await fetch(url,{cache:"no-store"});
  return res.json();
}

async function initTracker() {

  // 1) Load Settings (from your master sheet)
  const bootstrap = await loadSheet(MASTER_SHEET_URL);
  const userApiURL = bootstrap.settings.api_url;

  if(!userApiURL){
    alert("Error: api_url missing in Settings sheet");
    return;
  }

  // 2) Load user‚Äôs actual sheet data
  const data = await loadSheet(userApiURL);

  const settings = data.settings || {};
  const tracker  = data.tracker  || {};

  // Theme
  document.documentElement.style.setProperty(
    "--primaryColor",
    settings.primary_color || "#d31c1c"
  );

  // Donate button
  const donateLink = document.getElementById("donateLink");
  donateLink.href = tracker.donate_url || "#";

  // Map fallback
  const FALLBACK = {
    lat: tracker.fallback_lat || 66.5436,
    lng: tracker.fallback_lng || 25.8473   // Lapland fallback
  };

  // Map setup
  const map = L.map("map").setView([FALLBACK.lat, FALLBACK.lng],
    settings.default_map_zoom || 13
  );

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png")
    .addTo(map);

  // Marker
  const marker = L.marker([FALLBACK.lat,FALLBACK.lng], {
    icon: L.icon({
      iconUrl: tracker.map_icon ||
        "https://i.ibb.co/4ZMk1PD9/Santa-Marker-8.png",
      iconSize:[64,64],
      iconAnchor:[32,32]
    })
  }).addTo(map);

  /* -------------------------------------------------------
     FOLLOW SANTA FEATURE
  ------------------------------------------------------- */
  let follow = true;
  const followBtn = document.getElementById("followBtn");

  followBtn.addEventListener("click", () => {
    follow = !follow;
    followBtn.textContent = follow ? "Follow Santa: ON" : "Follow Santa: OFF";
  });

  document.getElementById("recenterBtn").addEventListener("click", () => {
    map.setView(marker.getLatLng(), map.getZoom());
  });

  /* -------------------------------------------------------
     Build Firebase URL
  ------------------------------------------------------- */
  const firebaseURL =
    tracker.firebase_url.replace(/\/$/,"") +
    tracker.firebase_path.replace(/\/$/,"") +
    ".json";

  const statusBox = document.getElementById("statusBox");
  const lastUpdatedSpan = document.getElementById("lastUpdated");
  const ageSpan = document.getElementById("age");

  async function updateLocation(){

    try {
      const raw = await (await fetch(firebaseURL,{cache:"no-store"})).json();
      const key = Object.keys(raw)[0];
      const p = raw[key];

      if(!p){ setTimeout(updateLocation, 10000); return; }

      const latlng = L.latLng(p.lat, p.lng);
      marker.setLatLng(latlng);

      if(follow){
        map.setView(latlng);
      }

      // --- Status update ---
      const ts = new Date(p.ts);
      const now = new Date();
      const ageMs = now - ts;
      const ageMin = Math.round(ageMs / 60000);

      lastUpdatedSpan.textContent = "Last update: " + ts.toLocaleTimeString();
      ageSpan.textContent = "Age: " + ageMin + " mins";

      if(ageMs < 5*60000){
        statusBox.textContent = "üéÖ Santa is out on his sleigh delivering joy!";
      }
      else{
        statusBox.textContent = "üéÑ Santa is currently in Lapland preparing for Christmas!";
      }

    } catch(e){
      console.log("GPS fetch error:", e);
    }

    setTimeout(updateLocation, 10000);
  }

  updateLocation();
}

window.addEventListener("load", initTracker);
</script>
</body>
</html>
