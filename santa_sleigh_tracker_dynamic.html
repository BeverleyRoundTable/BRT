<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Santa Sleigh Tracker</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html,body{
  margin:0;padding:0;height:100%;
  background:#001;color:#fff;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
  overflow:hidden;
}
#map{width:100vw;height:100dvh;min-height:100vh;}

/* ================= STATUS BOX ================= */

.status-popup{
  position:absolute;
  top:24px;
  left:50%;
  transform:translateX(-50%);
  background:rgba(24,24,24,.93);
  padding:16px 22px;
  border-radius:18px;
  box-shadow:0 4px 32px #0006;
  z-index:4000;
  text-align:center;
  white-space:nowrap;
}

.status-core{
  font-size:1.2em;
  font-weight:800;
}

.status-telemetry{
  position:absolute;
  right:100%;
  top:50%;
  transform:translateY(-50%);
  margin-right:14px;
  display:flex;
  gap:10px;
  align-items:center;
  background:rgba(20,20,20,.92);
  padding:8px 12px;
  border-radius:12px;
  font-size:.75em;
  font-weight:700;
  opacity:0;
  pointer-events:none;
  transition:opacity .25s ease;
}

.status-popup.active .status-telemetry{
  opacity:1;
}

.status-popup.searching{
  animation:glow 1.3s ease-in-out infinite;
}

@keyframes glow{
  0%{box-shadow:0 0 0 rgba(255,215,0,0);}
  50%{box-shadow:0 0 20px rgba(255,215,0,.6);}
  100%{box-shadow:0 0 0 rgba(255,215,0,0);}
}

/* ================= DONATE ================= */

.donate-box{
  position:fixed;
  bottom:110px;
  left:50%;
  transform:translateX(-50%);
  width:70%;
  max-width:420px;
  z-index:3000;
}
.donate-btn{
  background:#d31c1c;
  color:#fff;
  padding:14px 0;
  display:block;
  text-align:center;
  border-radius:14px;
  font-weight:900;
  text-decoration:none;
  box-shadow:0 4px 16px rgba(0,0,0,.4);
}

/* ================= CONTROLS ================= */

.info-popup{
  position:fixed;
  bottom:16px;
  left:50%;
  transform:translateX(-50%);
  background:rgba(20,20,20,.92);
  padding:10px 12px;
  border-radius:12px;
  display:flex;
  gap:12px;
  font-size:.85em;
  font-weight:700;
  z-index:3000;
}
.btn{
  background:#0b1220;
  color:#fff;
  border:1px solid #ffffff26;
  border-radius:10px;
  padding:6px 10px;
  font-weight:800;
  cursor:pointer;
}

/* ================= LOGO ================= */

#logoOverlay{
  position:fixed;
  bottom:16px;
  right:16px;
  width:64px;
  z-index:3500;
  pointer-events:none;
}
</style>
</head>

<body>

<div class="status-popup searching" id="statusBox">
  <div class="status-telemetry">
    <span id="telemetryTime">‚Äî</span>
    <span id="telemetrySpeed">‚Äî</span>
  </div>
  <div class="status-core" id="statusCore">
    üîç Searching for Santa‚Ä¶
  </div>
</div>

<div class="donate-box" id="donateBox">
  <a id="donateLink" class="donate-btn" target="_blank">
    üéÅ DONATE & SUPPORT US
  </a>
</div>

<div class="info-popup">
  <button class="btn" id="followBtn">Follow: ON</button>
  <button class="btn" id="recenterBtn">Re-centre</button>
</div>

<div id="map"></div>
<img id="logoOverlay" />

<script>
const apiUrl=new URLSearchParams(location.search).get("api");
if(!apiUrl) alert("Missing ?api=");

const REFRESH=5000;
const STALE_MS=5*60000;
const LAPLAND={lat:66.5436,lng:25.8473};

let map,marker,follow=true,lastFix=null,isLapland=true;

const loadJSON=u=>fetch(u,{cache:"no-store"}).then(r=>r.json());

function mph(a,b,dt){
  return ((a.distanceTo(b)/dt)*2.23694).toFixed(1);
}

async function init(){
  const data=await loadJSON(apiUrl);
  const s=data.settings||{};

  if(s.donate_url){
    donateLink.href=s.donate_url;
  }else{
    donateBox.style.display="none";
  }

  if(s.logo_overlay_enabled){
    logoOverlay.src=s.logo_overlay_url;
    logoOverlay.style.width=(s.logo_overlay_size||64)+"px";
  }else{
    logoOverlay.style.display="none";
  }

  map=L.map("map").setView([LAPLAND.lat,LAPLAND.lng],6);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

  marker=L.marker([LAPLAND.lat,LAPLAND.lng],{
    icon:L.icon({
      iconUrl:s.sleigh_icon_live,
      iconSize:[64,64],
      iconAnchor:[32,32]
    })
  }).addTo(map);

  followBtn.onclick=()=>follow=!follow;
  recenterBtn.onclick=()=>{follow=true;map.panTo(marker.getLatLng());};

  tick();
}

async function tick(){
  try{
    const p=await loadJSON(apiUrl+"?function=proxyFirebase");
    const ts=new Date(p.ts).getTime();
    if(Date.now()-ts>STALE_MS) throw "stale";

    const ll=L.latLng(p.lat,p.lng);
    marker.setLatLng(ll);

    if(isLapland){
      map.flyTo(ll,16,{duration:2});
      isLapland=false;
    }else if(follow){
      map.panTo(ll);
    }

    let speed="‚Äî";
    if(lastFix){
      speed=mph(lastFix,ll,(ts-lastFix.ts)/1000);
    }
    lastFix={...ll,ts};

    statusBox.classList.remove("searching");
    statusBox.classList.add("active");
    statusCore.textContent="üéÖ Santa is out spreading joy!";
    telemetryTime.textContent=new Date(p.ts).toLocaleTimeString("en-GB");
    telemetrySpeed.textContent=speed+" mph";

  }catch{
    if(!isLapland){
      isLapland=true;
      map.flyTo([LAPLAND.lat,LAPLAND.lng],6,{duration:2.5});
      marker.setLatLng([LAPLAND.lat,LAPLAND.lng]);
    }
    statusBox.classList.remove("active","searching");
    statusCore.textContent="üéÑ Santa is in Lapland preparing for Christmas!";
  }
  setTimeout(tick,REFRESH);
}

init();
</script>
</body>
</html>
