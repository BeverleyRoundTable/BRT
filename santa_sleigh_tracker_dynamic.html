<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Santa Sleigh Tracker</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html,body{
  margin:0;
  padding:0;
  height:100%;
  background:#001;
  color:#fff;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
  overflow:hidden;
}

#map{
  width:100vw;
  height:100dvh;
  min-height:100vh;
}

/* ---------- STATUS BUBBLE ---------- */
.status-popup{
  position:absolute;
  top:20px;
  left:50%;
  transform:translateX(-50%);
  background:rgba(24,24,24,.95);
  padding:14px 20px;
  font-size:1.05em;
  font-weight:800;
  border-radius:16px;
  max-width:90%;
  box-shadow:0 4px 24px #0006;
  z-index:4000;
  text-align:center;
  color:#fff;
}

/* ---------- DONATE ---------- */
.donate-box{
  position:fixed;
  bottom:110px;
  left:50%;
  transform:translateX(-50%);
  width:70%;
  max-width:420px;
  z-index:2000;
}
.donate-btn{
  background:#d31c1c;
  color:#fff;
  padding:14px 0;
  display:block;
  text-align:center;
  border-radius:16px;
  font-weight:900;
  text-decoration:none;
  box-shadow:0 4px 16px rgba(0,0,0,.4);
}

/* ---------- INFO BAR ---------- */
.info-popup{
  position:fixed;
  bottom:16px;
  left:50%;
  transform:translateX(-50%);
  background:rgba(20,20,20,.94);
  padding:10px 14px;
  border-radius:14px;
  display:flex;
  align-items:center;
  gap:12px;
  font-size:.85em;
  font-weight:800;
  z-index:2000;
  max-width:calc(100vw - 32px);
  box-sizing:border-box;
  color:#fff;
}

/* ---------- STATUS DOT ---------- */
.status-dot{
  width:12px;
  aspect-ratio:1 / 1;
  border-radius:50%;
  flex-shrink:0;
  display:none;
}

.dot-moving{
  background:#2cff4e;
  animation:pulse 1.4s infinite;
}

.dot-stopped{
  background:#ff3b3b;
}

@keyframes pulse{
  0%{ box-shadow:0 0 0 0 rgba(44,255,78,.6); }
  70%{ box-shadow:0 0 0 10px rgba(44,255,78,0); }
  100%{ box-shadow:0 0 0 0 rgba(44,255,78,0); }
}

.btn{
  background:#0b1220;
  color:#fff;
  border:1px solid #ffffff26;
  border-radius:10px;
  padding:7px 12px;
  cursor:pointer;
  font-weight:800;
}

/* ---------- LOADING ---------- */
#loadingCover{
  position:fixed;
  inset:0;
  background:#000;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:6000;
}
#loadingSpinner{
  width:52px;
  height:52px;
  border-radius:50%;
  border:4px solid rgba(255,255,255,.25);
  border-top-color:#ffd700;
  animation:spin .9s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>

<body>

<div id="loadingCover"><div id="loadingSpinner"></div></div>

<div class="status-popup" id="statusBox">
  üîç Searching for Santa‚Ä¶
</div>

<div class="donate-box" id="donateBox">
  <a id="donateLink" class="donate-btn" target="_blank">
    üéÅ DONATE & SUPPORT US
  </a>
</div>

<div class="info-popup" id="infoBar">
  <div id="statusDot" class="status-dot"></div>
  <button class="btn" id="followBtn">Follow: ON</button>
  <button class="btn" id="recenterBtn">Re-centre</button>
</div>

<div id="map"></div>

<script>
/* ---------- CONFIG ---------- */
const apiUrl = new URLSearchParams(location.search).get("api");
if(!apiUrl) alert("Missing ?api=YOUR_SCRIPT_URL");

const REFRESH = 5000;
const STALE_MS = 5 * 60 * 1000;
const LAPLAND = [66.5436,25.8473];

const FALLBACK_ICON = "https://i.ibb.co/Qj3vDbSR/Santa-Marker-11.png";

let map, marker;
let follow = true;
let lastFix = null;
let firstFix = true;

/* ---------- HELPERS ---------- */
const valid = (lat,lng)=>typeof lat==="number"&&!isNaN(lat)&&typeof lng==="number"&&!isNaN(lng);

async function loadJSON(url){
  const r = await fetch(url,{cache:"no-store"});
  if(!r.ok) throw 0;
  return r.json();
}

/* ---------- INIT ---------- */
async function init(){
  const data = await loadJSON(apiUrl);
  const s = data.settings || {};

  if(s.donate_url){
    donateLink.href = s.donate_url;
  }else{
    donateBox.style.display="none";
  }

  map = L.map("map").setView(LAPLAND,5);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

  marker = L.marker(LAPLAND,{
    icon:L.icon({
      iconUrl:s.sleigh_icon_live || FALLBACK_ICON,
      iconSize:[64,64],
      iconAnchor:[32,32]
    })
  }).addTo(map);

  followBtn.onclick=()=>{
    follow=!follow;
    followBtn.textContent="Follow: "+(follow?"ON":"OFF");
  };
  recenterBtn.onclick=()=>{
    follow=true;
    map.panTo(marker.getLatLng());
  };

  loadingCover.style.display="none";
  tick();
}

/* ---------- POLL ---------- */
async function tick(){
  const dot = statusDot;

  try{
    const p = await loadJSON(apiUrl+"?function=proxyFirebase");
    if(!valid(p.lat,p.lng)) throw 0;

    const ts = new Date(p.ts).getTime();
    if(Date.now()-ts > STALE_MS) throw 0;

    const ll = L.latLng(p.lat,p.lng);
    marker.setLatLng(ll);

    if(firstFix){
      map.setView(ll,16);
      firstFix=false;
    }else if(follow){
      map.panTo(ll,{animate:true,duration:1.2});
    }

    let moving = false;
    if(lastFix){
      const d = lastFix.ll.distanceTo(ll);
      const dt = (ts-lastFix.ts)/1000;
      moving = dt>0 && (d/dt)*2.23694 >= 0.5;
    }
    lastFix = {ll,ts};

    dot.style.display="block";
    dot.className = "status-dot " + (moving ? "dot-moving" : "dot-stopped");

    statusBox.textContent = "üéÖ Santa is out spreading joy!";

  }catch{
    marker.setLatLng(LAPLAND);
    if(follow) map.setView(LAPLAND,5,{animate:true,duration:2});

    dot.style.display="none";
    statusBox.textContent = "üéÑ Santa is in Lapland preparing for Christmas!";
    lastFix = null;
  }

  setTimeout(tick,REFRESH);
}

init();
</script>
</body>
</html>
