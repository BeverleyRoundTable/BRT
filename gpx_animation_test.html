<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Turbo Santa GPX Animation</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<link rel="stylesheet" href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" />

<style>
html,body{margin:0;height:100%;overflow:hidden;background:#0b0d12}
#map{position:absolute;inset:0}
#anim{position:absolute;inset:0;pointer-events:none}

/* ================= LOGO OVERLAY ================= */
#logo-overlay{
  position:fixed;
  z-index:9999;
  pointer-events:none;
}
#logo-overlay img{
  display:block;
  max-width:100%;
  filter:drop-shadow(0 4px 10px rgba(0,0,0,.6));
}
</style>
</head>

<body>
<div id="map"></div>
<canvas id="anim"></canvas>

<div id="logo-overlay" hidden>
  <img id="logo-overlay-img" />
</div>

<script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

<script>
/* ================= FLAGS ================= */
const PARAMS=new URLSearchParams(location.search);
const IS_RENDER=PARAMS.has("render");
const API=PARAMS.get("api");
const ROUTE=PARAMS.get("route");
window.__GPX_DONE__=false;

if(!API) throw new Error("Missing ?api=");
if(!ROUTE) throw new Error("Missing ?route=");

/* ================= CANVAS ================= */
const canvas=document.getElementById("anim");
const ctx=canvas.getContext("2d");
let map=null, VIEW_W=0, VIEW_H=0;

function resize(){
  if(!map) return;
  const c=map.getCanvas();
  const dpr=devicePixelRatio||1;
  VIEW_W=c.clientWidth;
  VIEW_H=c.clientHeight;
  canvas.width=VIEW_W*dpr;
  canvas.height=VIEW_H*dpr;
  canvas.style.width=VIEW_W+"px";
  canvas.style.height=VIEW_H+"px";
  ctx.setTransform(dpr,0,0,dpr,0,0);
}

/* ================= MAP STYLE ================= */
const MAP_STYLE={
  version:8,
  sources:{raster:{type:"raster",tiles:["https://basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}@2x.png"],tileSize:256}},
  layers:[{id:"base",type:"raster",source:"raster"}]
};

/* ================= MATH ================= */
const dist=(a,b)=>{
  const R=6371000;
  const dLat=(b.lat-a.lat)*Math.PI/180;
  const dLng=(b.lng-a.lng)*Math.PI/180;
  const s=Math.sin(dLat/2)**2+Math.cos(a.lat*Math.PI/180)*Math.cos(b.lat*Math.PI/180)*Math.sin(dLng/2)**2;
  return 2*R*Math.asin(Math.sqrt(s));
};
const bearing=(a,b)=>{
  const dLng=(b.lng-a.lng)*Math.PI/180;
  const y=Math.sin(dLng)*Math.cos(b.lat*Math.PI/180);
  const x=Math.cos(a.lat*Math.PI/180)*Math.sin(b.lat*Math.PI/180)-Math.sin(a.lat*Math.PI/180)*Math.cos(b.lat*Math.PI/180)*Math.cos(dLng);
  return (Math.atan2(y,x)*180/Math.PI+360)%360;
};
const lerpA=(a,b,t)=>a+(((b-a+540)%360)-180)*t;

/* ================= LOAD ================= */
(async()=>{
  const master=await fetch(API,{cache:"no-store"}).then(r=>r.json());
  const s=master.settings||{};

  const r=master.routes.find(x=>x.routeName?.toLowerCase()===(ROUTE||"").toLowerCase());
  const rawPts=await fetch(r.gpxUrl).then(r=>r.text()).then(x=>
    [...new DOMParser().parseFromString(x,"text/xml").getElementsByTagName("trkpt")]
      .map(p=>({lat:+p.getAttribute("lat"),lng:+p.getAttribute("lon")}))
  );

  const sprite=await new Promise(res=>{
    const i=new Image();
    i.onload=()=>res(i);
    i.src=s.travelboast_sprite;
  });

  run(rawPts,sprite,s);
})();

/* ================= ANIMATION ================= */
function run(pts,sprite,s){
  map=new maplibregl.Map({
    container:"map",
    style:MAP_STYLE,
    center:[pts[0].lng,pts[0].lat],
    zoom:+s.default_map_zoom||16,
    bearing:0,
    pitch:IS_RENDER?48:52
  });

  const FOLLOW_ZOOM=IS_RENDER?18.9:18.4;
  const FOLLOW_PITCH=IS_RENDER?48:52;
  const FRAMES=+s.travelboast_sprite_frames||5;
  const SPRITE_FPS=+s.travelboast_sprite_fps||12;
  const BASE_SIZE=+s.travelboast_sprite_size||72;
  const YAW_DAMPING=0.12;

  const cum=[0];
  for(let i=1;i<pts.length;i++) cum[i]=cum[i-1]+dist(pts[i-1],pts[i]);
  const total=cum.at(-1);

  const DURATION_SEC=Math.max(1,+s.travelboast_speed||60);

  let simTime=0,last=null,m=0;
  let sprB=bearing(pts[0],pts[1]),targetB=sprB;
  let spriteFrame=0,spriteTimer=0;

  map.on("load",()=>{
    resize(); map.on("resize",resize);
    map.addSource("route",{type:"geojson",data:{type:"Feature",geometry:{type:"LineString",coordinates:[]}}});
    map.addLayer({id:"route",type:"line",source:"route",paint:{"line-color":s.primary_color||"#d31c1c","line-width":6}});
    requestAnimationFrame(step);
  });

  function step(ts){
    const dtSim=1/60;
    simTime+=dtSim;
    m=Math.min(total,(simTime/DURATION_SEC)*total);

    let i=cum.findIndex(v=>v>=m); i=Math.max(1,i);
    const t=(m-cum[i-1])/(cum[i]-cum[i-1]||1);
    const a=pts[i-1],b=pts[i];
    const pos={lat:a.lat+(b.lat-a.lat)*t,lng:a.lng+(b.lng-a.lng)*t};

    targetB=bearing(a,b);
    sprB=lerpA(sprB,targetB,YAW_DAMPING);
    const normB=(sprB%360+360)%360;

    // ✅ ROW SELECTION ONLY — NO ROTATION
    const ROW=(normB>=90 && normB<=270)?1:0;

    spriteTimer+=dtSim;
    if(spriteTimer>=1/SPRITE_FPS){
      spriteTimer-=1/SPRITE_FPS;
      spriteFrame=(spriteFrame+1)%FRAMES;
    }

    map.getSource("route").setData({
      type:"Feature",
      geometry:{type:"LineString",coordinates:[...pts.slice(0,i).map(p=>[p.lng,p.lat]),[pos.lng,pos.lat]]}
    });

    map.jumpTo({center:[pos.lng,pos.lat],zoom:FOLLOW_ZOOM,bearing:0,pitch:FOLLOW_PITCH});

    ctx.clearRect(0,0,VIEW_W,VIEW_H);

    const p=map.project([pos.lng,pos.lat]);
    const FRAME_W=sprite.width/FRAMES;
    const FRAME_H=sprite.height/2;
    const SIZE=BASE_SIZE;

    ctx.save();
    ctx.translate(p.x,p.y);
    ctx.drawImage(
      sprite,
      spriteFrame*FRAME_W, ROW*FRAME_H, FRAME_W, FRAME_H,
      -SIZE/2, -SIZE/2, SIZE, SIZE
    );
    ctx.restore();

    if(m<total) requestAnimationFrame(step);
    else window.__GPX_DONE__=true;
  }
}
</script>
</body>
</html>
