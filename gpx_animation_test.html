<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Turbo Santa GPX Animation</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<link rel="stylesheet" href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" />

<style>
html, body {
  margin:0; padding:0; height:100%;
  background:#0b0d12;
  overflow:hidden;
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
  color:#fff;
}
#map{position:absolute;inset:0;}
#anim{position:absolute;inset:0;pointer-events:none;}
#ui-layer{
  position:absolute;bottom:24px;left:50%;
  transform:translateX(-50%);
  z-index:50;text-align:center;pointer-events:none;
}
.pill{
  background:rgba(0,0,0,.65);
  padding:10px 18px;border-radius:999px;
  border:1px solid rgba(255,255,255,.2);
  backdrop-filter:blur(8px);
}
#route-name{margin:0;font-weight:700}
#route-date{margin:2px 0 0;font-size:.82rem;opacity:.85}
#toast{
  position:absolute;top:16px;left:16px;
  background:rgba(0,0,0,.72);
  border:1px solid rgba(255,255,255,.18);
  border-radius:12px;padding:10px 12px;
  display:none;z-index:60;
}
</style>
</head>

<body>
<div id="map"></div>
<canvas id="anim"></canvas>

<div id="ui-layer">
  <div class="pill">
    <h1 id="route-name">Loading routeâ€¦</h1>
    <p id="route-date"></p>
  </div>
</div>
<div id="toast"></div>

<script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

<script>
/* ============================================================
   PARAMS + CANVAS
============================================================ */
const P=new URLSearchParams(location.search);
const API=P.get("api"), ROUTE=P.get("route");

const routeNameEl = document.getElementById("route-name");
const routeDateEl = document.getElementById("route-date");

const toastEl=document.getElementById("toast");

function toast(m){
  toastEl.style.display="block";
  toastEl.textContent=m;
}

if(!API){
  toast("Missing api=");
  throw new Error("Missing api");
}

const canvas=document.getElementById("anim");
const ctx=canvas.getContext("2d");

function resize(){
  const dpr=devicePixelRatio||1;
  canvas.width=innerWidth*dpr;
  canvas.height=innerHeight*dpr;
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
addEventListener("resize",resize);
resize();

/* ============================================================
   GLOBAL SNOWFALL OVERLAY (CONTINUOUS, GAPLESS)
============================================================ */
function createSnowfall(enabled){
  const flakes = [];
  const DENSITY = 0.00018; // flakes per pixel
  let targetCount = 0;

  function resizeSnow(){
    targetCount = Math.floor(canvas.width * canvas.height * DENSITY);
    while (flakes.length < targetCount) addFlake(true);
    while (flakes.length > targetCount) flakes.pop();
  }

  function addFlake(randomY = false){
    flakes.push({
      x: Math.random() * canvas.width,
      y: randomY ? Math.random() * canvas.height : -20,
      r: Math.random() * 2.2 + 1,
      vy: Math.random() * 1.6 + 1.4,
      vx: Math.random() * 0.4 - 0.2,
      drift: Math.random() * Math.PI * 2
    });
  }

  function update(){
    if(!enabled) return;

    for(const f of flakes){
      f.drift += 0.01;
      f.x += f.vx + Math.sin(f.drift) * 0.15;
      f.y += f.vy;

      // recycle instead of destroy (NO GAPS)
      if(f.y > canvas.height + 30){
        f.y = -20;
        f.x = Math.random() * canvas.width;
      }

      // horizontal wrap
      if(f.x < -20) f.x = canvas.width + 20;
      if(f.x > canvas.width + 20) f.x = -20;
    }
  }

  function draw(){
    if(!enabled) return;

    ctx.save();
    ctx.fillStyle = "#ffffff";
    ctx.globalAlpha = 0.9;

    for(const f of flakes){
      ctx.beginPath();
      ctx.arc(f.x, f.y, f.r, 0, Math.PI * 2);
      ctx.fill();
    }

    ctx.restore();
  }

  // initial fill + resize safety
  resizeSnow();
  addEventListener("resize", resizeSnow);

  return { update, draw };
}

/* ============================================================
   HELPERS
============================================================ */
const MAP_STYLE="https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json";
const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));

async function fetchJSON(u){
  const r=await fetch(u,{cache:"no-store"});
  if(!r.ok)throw new Error("API fetch failed");
  return r.json();
}

async function loadGPX(u){
  const x=await (await fetch(u,{cache:"no-store"})).text();
  const d=new DOMParser().parseFromString(x,"text/xml");
  return [...d.getElementsByTagName("trkpt")].map(p=>({
    lat:+p.getAttribute("lat"),
    lng:+(p.getAttribute("lon")||p.getAttribute("lng"))
  }));
}

function smoothPath(p,it=2){
  if(it<=0||p.length<3)return p;
  const o=[p[0]];
  for(let i=0;i<p.length-1;i++){
    const a=p[i],b=p[i+1];
    o.push({lat:.75*a.lat+.25*b.lat,lng:.75*a.lng+.25*b.lng});
    o.push({lat:.25*a.lat+.75*b.lat,lng:.25*a.lng+.75*b.lng});
  }
  o.push(p.at(-1));
  return smoothPath(o,it-1);
}

function bearing(a,b){
  const dLng=(b.lng-a.lng)*Math.PI/180;
  const y=Math.sin(dLng)*Math.cos(b.lat*Math.PI/180);
  const x=Math.cos(a.lat*Math.PI/180)*Math.sin(b.lat*Math.PI/180)-
          Math.sin(a.lat*Math.PI/180)*Math.cos(b.lat*Math.PI/180)*Math.cos(dLng);
  return (Math.atan2(y,x)*180/Math.PI+360)%360;
}

function dist(a,b){
  const R=6371000;
  const dLat=(b.lat-a.lat)*Math.PI/180;
  const dLng=(b.lng-a.lng)*Math.PI/180;
  const s=Math.sin(dLat/2)**2+
          Math.cos(a.lat*Math.PI/180)*Math.cos(b.lat*Math.PI/180)*Math.sin(dLng/2)**2;
  return 2*R*Math.asin(Math.sqrt(s));
}

function angleDelta(a,b){ return ((b-a+540)%360)-180; }
function lerpAngle(a,b,t){ return (a+angleDelta(a,b)*t+360)%360; }

/* ============================================================
   MAIN
============================================================ */
(async()=>{
try{
  const master=await fetchJSON(API);
  const settings=master.settings||{};
  const routes=master.routes||[];
  const route=routes.find(r=>r.routeName?.toLowerCase()===(ROUTE||"").toLowerCase());
  if(!route||!route.gpxUrl)throw "Route invalid";

  routeNameEl.textContent = route.routeName || "";

routeDateEl.textContent = route.date
  ? new Date(route.date + "T00:00:00").toLocaleDateString("en-GB", {
      day: "numeric",
      month: "long",
      year: "numeric"
    })
  : "";

  const rawPts=await loadGPX(route.gpxUrl);
  const pts=smoothPath(rawPts,2);
  const sprite=await loadImg(settings.travelboast_sprite);

  initMapAndRun(rawPts,pts,sprite,settings);
}catch(e){
  console.error(e);
  toast(e?.message||"Failed to load GPX animation");
}
})();

function loadImg(u){
  return new Promise((res,rej)=>{
    const i=new Image();
    i.crossOrigin="anonymous";
    i.onload=()=>res(i);
    i.onerror=rej;
    i.src=u;
  });
}

/* ============================================================
   MAP + ANIMATION
============================================================ */
function initMapAndRun(rawPts,pts,sprite,settings){
const baseZoom=+settings.default_map_zoom||16;

const map=new maplibregl.Map({
  container:"map",
  style:MAP_STYLE,
  center:[pts[0].lng,pts[0].lat],
  zoom:baseZoom,
  pitch:50,
  bearing:0,
  antialias:true
});

map.dragPan.disable();
map.scrollZoom.disable();
map.doubleClickZoom.disable();

map.on("load",()=>{
  map.addSource("route-base",{type:"geojson",data:{type:"Feature",geometry:{type:"LineString",coordinates:rawPts.map(p=>[p.lng,p.lat])}}});
  map.addLayer({id:"route-base",type:"line",source:"route-base",paint:{ "line-color":"#666","line-opacity":0.35,"line-width":3 }});

  map.addSource("route-progress",{type:"geojson",data:{type:"Feature",geometry:{type:"LineString",coordinates:[]}}});
  map.addSource("route-progress-glow",{type:"geojson",data:{type:"Feature",geometry:{type:"LineString",coordinates:[]}}});

  map.addLayer({id:"route-progress-glow",type:"line",source:"route-progress-glow",paint:{
    "line-color":settings.primary_color||"#d31c1c","line-width":12,"line-opacity":0.3,"line-blur":8}});
  map.addLayer({id:"route-progress",type:"line",source:"route-progress",paint:{
    "line-color":settings.primary_color||"#d31c1c","line-width":5}});

  animate(map,pts,sprite,settings,{baseZoom});
});
}
let snowAlpha = 1;
let snowFading = false;

function animate(map,pts,sprite,settings,theme){
const frames=+settings.travelboast_sprite_frames||5;
const fps=+settings.travelboast_sprite_fps||14;
const size=+settings.travelboast_sprite_size||128;
const speed=(+settings.travelboast_speed||.1)*18;

const snowfall=createSnowfall(
  (settings.travelboast_particle_effects||"").toLowerCase()==="snow"
);

const cum=[0]; for(let i=1;i<pts.length;i++)cum[i]=cum[i-1]+dist(pts[i-1],pts[i]);
const total=cum.at(-1);

const bounds=new maplibregl.LngLatBounds(); pts.forEach(p=>bounds.extend([p.lng,p.lat]));

let m=0,last=null,camBearing=0,spriteBearing=0;
let finished=false,overviewShown=false,hideSprite=false,currentPos=null;
let snowEnabled=true;
let snowWarmup=0;

function updateProgressLine(distance){
  const coords=[]; let remaining=distance;
  for(let i=1;i<pts.length&&remaining>0;i++){
    const seg=dist(pts[i-1],pts[i]);
    if(remaining>=seg){coords.push([pts[i-1].lng,pts[i-1].lat]);remaining-=seg;}
    else{
      const t=remaining/seg;
      coords.push([pts[i-1].lng,pts[i-1].lat]);
      coords.push([pts[i-1].lng+(pts[i].lng-pts[i-1].lng)*t,pts[i-1].lat+(pts[i].lat-pts[i-1].lat)*t]);
      break;
    }
  }
  const data={type:"Feature",geometry:{type:"LineString",coordinates:coords}};
  map.getSource("route-progress")?.setData(data);
  map.getSource("route-progress-glow")?.setData(data);
}

function getPos(d){
  let i=cum.findIndex(v=>v>=d); i=Math.max(1,i);
  const t=(d-cum[i-1])/(cum[i]-cum[i-1]||1);
  const a=pts[i-1],b=pts[i];
  return {lat:a.lat+(b.lat-a.lat)*t,lng:a.lng+(b.lng-a.lng)*t};
}

function draw(ts){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if (snowEnabled) {
  ctx.save();
  ctx.globalAlpha = snowAlpha;
  snowfall.draw();
  ctx.restore();
}
  if(!currentPos||hideSprite) return;

  const frame=Math.floor(ts/1000*fps)%frames;
  const spriteW=sprite.width/frames;
  const p=map.project([currentPos.lng,currentPos.lat]);
  const FOOT_ANCHOR=size*0.32;

  let rel=((spriteBearing-camBearing+540)%360)-180;
  rel=clamp(rel,-25,25);

  ctx.save();
  ctx.translate(Math.round(p.x),Math.round(p.y-FOOT_ANCHOR));
  ctx.rotate(rel*0.4*Math.PI/180);
  ctx.drawImage(sprite,frame*spriteW,0,spriteW,sprite.height,-size/2,-size/2,size,size);
  ctx.restore();
}

function step(ts){
  const dt=last?(ts-last)/1000:0;
  last=ts;

  if(snowEnabled){
    if(snowWarmup<30) snowWarmup++;
    else snowfall.spawn();
    snowfall.update();
  }

  if(!finished){
    m+=speed*dt;
    if(m>=total){
      m=total;
      finished=true;
      hideSprite=true;
    }
  }

  currentPos=getPos(m);
  updateProgressLine(m);

  const nextPos=getPos(Math.min(m+Math.max(0.6,speed*0.03),total));
  spriteBearing=lerpAngle(spriteBearing,bearing(currentPos,nextPos),0.25);

 if (finished && !overviewShown) {
  overviewShown = true;
  snowFading = true;

  map.fitBounds(bounds,{
    padding:80,
    pitch:0,
    bearing:0,
    duration:2500
  });
}

  camBearing=lerpAngle(camBearing,spriteBearing,0.15);
  map.jumpTo({center:[currentPos.lng,currentPos.lat],zoom:theme.baseZoom,bearing:camBearing,pitch:50});

  draw(ts);
  requestAnimationFrame(step);
}

requestAnimationFrame(step);
}
</script>
</body>
</html>
