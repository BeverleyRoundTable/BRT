<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Santa TravelBoast GL</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet" />

<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  background: #0b0d12;
  overflow: hidden;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto;
}
#map {
  position: absolute;
  inset: 0;
}
#anim {
  position: absolute;
  inset: 0;
  pointer-events: none;
}
#ui {
  position: absolute;
  bottom: 24px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,.6);
  color: #fff;
  padding: 10px 20px;
  border-radius: 999px;
  backdrop-filter: blur(6px);
}
</style>
</head>

<body>
<div id="map"></div>
<canvas id="anim"></canvas>
<div id="ui"><strong id="title">Loading routeâ€¦</strong></div>

<script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

<script>
/* ------------------------------------------------------------
   PARAMS
------------------------------------------------------------ */
const P = new URLSearchParams(location.search);
const API   = P.get("api");
const ROUTE = P.get("route");

/* ------------------------------------------------------------
   CANVAS
------------------------------------------------------------ */
const canvas = document.getElementById("anim");
const ctx = canvas.getContext("2d");

function resize() {
  const dpr = window.devicePixelRatio || 1;
  canvas.width = innerWidth * dpr;
  canvas.height = innerHeight * dpr;
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
addEventListener("resize", resize);
resize();

/* ------------------------------------------------------------
   HELPERS
------------------------------------------------------------ */
async function fetchJSON(url) {
  const r = await fetch(url, { cache: "no-store" });
  if (!r.ok) throw new Error("API error");
  return r.json();
}

async function loadGPX(url) {
  const xml = await (await fetch(url)).text();
  const dom = new DOMParser().parseFromString(xml, "text/xml");
  return [...dom.getElementsByTagName("trkpt")].map(p => ({
    lat: +p.getAttribute("lat"),
    lng: +p.getAttribute("lon")
  }));
}

function bearing(a, b) {
  const y = Math.sin((b.lng-a.lng)*Math.PI/180)*Math.cos(b.lat*Math.PI/180);
  const x =
    Math.cos(a.lat*Math.PI/180)*Math.sin(b.lat*Math.PI/180) -
    Math.sin(a.lat*Math.PI/180)*Math.cos(b.lat*Math.PI/180)*Math.cos((b.lng-a.lng)*Math.PI/180);
  return (Math.atan2(y,x)*180/Math.PI+360)%360;
}

/* ------------------------------------------------------------
   MAIN
------------------------------------------------------------ */
(async()=>{
const master = await fetchJSON(API);
const settings = master.settings;
const route = master.routes.find(r => r.routeName === ROUTE) || master.routes[0];

document.getElementById("title").textContent = route.routeName;

const path = await loadGPX(route.gpxUrl);

const map = new maplibregl.Map({
  container: "map",
  style: "https://demotiles.maplibre.org/style.json",
  center: [path[0].lng, path[0].lat],
  zoom: settings.default_map_zoom || 16,
  pitch: 55,
  bearing: 0,
  antialias: true
});

map.on("load", () => {
  map.addSource("route", {
    type: "geojson",
    data: {
      type: "Feature",
      geometry: {
        type: "LineString",
        coordinates: path.map(p => [p.lng, p.lat])
      }
    }
  });

  map.addLayer({
    id: "route-glow",
    type: "line",
    source: "route",
    paint: {
      "line-color": settings.accent_color || "#ffd700",
      "line-width": 6,
      "line-opacity": 0.6,
      "line-blur": 6
    }
  });

  startAnimation(map, path, settings);
});

/* ------------------------------------------------------------
   ANIMATION
------------------------------------------------------------ */
function startAnimation(map, pts, settings) {
  let t = 0;
  const speed = (+settings.travelboost_speed || 0.1) * 0.00025;

  function frame(ts) {
    t = Math.min(t + speed, pts.length - 2);
    const i = Math.floor(t);
    const a = pts[i];
    const b = pts[i+1];

    const lat = a.lat + (b.lat - a.lat) * (t - i);
    const lng = a.lng + (b.lng - a.lng) * (t - i);

    const head = bearing(a, b);

    map.easeTo({
      center: [lng, lat],
      bearing: head,
      zoom: settings.default_map_zoom || 16,
      pitch: 55,
      duration: 0
    });

    // draw Santa sprite
    const p = map.project([lng, lat]);
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = "#fff";
    ctx.beginPath();
    ctx.arc(p.x, p.y, 10, 0, Math.PI*2);
    ctx.fill();

    if (t < pts.length - 2) requestAnimationFrame(frame);
  }
  requestAnimationFrame(frame);
}
})();
</script>
</body>
</html>
