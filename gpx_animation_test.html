<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Turbo Santa GPX Animation</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<link rel="stylesheet" href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" />

<style>
html, body {
  margin:0; padding:0; height:100%;
  background:#0b0d12;
  overflow:hidden;
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
  color:#fff;
}
#map{position:absolute;inset:0;}
#anim{position:absolute;inset:0;pointer-events:none;}
#ui-layer{
  position:absolute;bottom:24px;left:50%;
  transform:translateX(-50%);
  z-index:50;text-align:center;pointer-events:none;
}
.pill{
  background:rgba(0,0,0,.65);
  padding:10px 18px;border-radius:999px;
  border:1px solid rgba(255,255,255,.2);
  backdrop-filter:blur(8px);
}
#route-name{margin:0;font-weight:700}
#route-date{margin:2px 0 0;font-size:.82rem;opacity:.85}
#toast{
  position:absolute;top:16px;left:16px;
  background:rgba(0,0,0,.72);
  border:1px solid rgba(255,255,255,.18);
  border-radius:12px;padding:10px 12px;
  display:none;z-index:60;
}
</style>
</head>

<body>
<div id="map"></div>
<canvas id="anim"></canvas>

<div id="ui-layer">
  <div class="pill">
    <h1 id="route-name">Loading routeâ€¦</h1>
    <p id="route-date"></p>
  </div>
</div>
<div id="toast"></div>

<script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

<script>
/* ============================================================
   PARAMS + CANVAS
============================================================ */
const P=new URLSearchParams(location.search);
const API=P.get("api"), ROUTE=P.get("route");
const routeNameEl=document.getElementById("route-name");
const routeDateEl=document.getElementById("route-date");
const toastEl=document.getElementById("toast");

if(!API){toast("Missing api=");throw new Error("Missing api");}

const canvas=document.getElementById("anim");
const ctx=canvas.getContext("2d");

function resize(){
  const dpr=devicePixelRatio||1;
  canvas.width=innerWidth*dpr;
  canvas.height=innerHeight*dpr;
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
addEventListener("resize",resize);resize();

function toast(m){toastEl.style.display="block";toastEl.textContent=m;}

/* ============================================================
   HELPERS
============================================================ */
const MAP_STYLE="https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json";
const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));

async function fetchJSON(u){
  const r=await fetch(u,{cache:"no-store"});
  if(!r.ok)throw new Error("API fetch failed");
  return r.json();
}

async function loadGPX(u){
  const x=await (await fetch(u,{cache:"no-store"})).text();
  const d=new DOMParser().parseFromString(x,"text/xml");
  return [...d.getElementsByTagName("trkpt")].map(p=>({
    lat:+p.getAttribute("lat"),
    lng:+(p.getAttribute("lon")||p.getAttribute("lng"))
  })).filter(p=>Number.isFinite(p.lat)&&Number.isFinite(p.lng));
}

function smoothPath(p,it=2){
  if(it<=0||p.length<3)return p;
  const o=[p[0]];
  for(let i=0;i<p.length-1;i++){
    const a=p[i],b=p[i+1];
    o.push({lat:.75*a.lat+.25*b.lat,lng:.75*a.lng+.25*b.lng});
    o.push({lat:.25*a.lat+.75*b.lat,lng:.25*a.lng+.75*b.lng});
  }
  o.push(p.at(-1));
  return smoothPath(o,it-1);
}

function bearing(a,b){
  const dLng=(b.lng-a.lng)*Math.PI/180;
  const y=Math.sin(dLng)*Math.cos(b.lat*Math.PI/180);
  const x=Math.cos(a.lat*Math.PI/180)*Math.sin(b.lat*Math.PI/180)-
          Math.sin(a.lat*Math.PI/180)*Math.cos(b.lat*Math.PI/180)*Math.cos(dLng);
  return (Math.atan2(y,x)*180/Math.PI+360)%360;
}

function dist(a,b){
  const R=6371000;
  const dLat=(b.lat-a.lat)*Math.PI/180;
  const dLng=(b.lng-a.lng)*Math.PI/180;
  const s=Math.sin(dLat/2)**2+
          Math.cos(a.lat*Math.PI/180)*Math.cos(b.lat*Math.PI/180)*Math.sin(dLng/2)**2;
  return 2*R*Math.asin(Math.sqrt(s));
}

/* ============================================================
   MAIN
============================================================ */
(async()=>{
try{
  const master=await fetchJSON(API);
  const settings=master.settings||{};
  const routes=master.routes||[];
  const route=routes.find(r=>r.routeName?.toLowerCase()===(ROUTE||"").toLowerCase());
  if(!route||!route.gpxUrl)throw "Route invalid";

  routeNameEl.textContent=route.routeName||"";
  routeDateEl.textContent=route.date||"";

  const pts=smoothPath(await loadGPX(route.gpxUrl),3);
  const sprite=await loadImg(settings.travelboost_sprite);

  initMapAndRun(pts,sprite,settings);
}catch(e){toast(e.message||e);}
})();

function loadImg(u){
  return new Promise((res,rej)=>{
    const i=new Image();i.crossOrigin="anonymous";
    i.onload=()=>res(i);i.onerror=rej;i.src=u;
  });
}

/* ============================================================
   MAP + ANIMATION
============================================================ */
function initMapAndRun(pts,sprite,settings){
const baseZoom=+settings.default_map_zoom||16;
const map=new maplibregl.Map({
  container:"map",
  style:MAP_STYLE,
  center:[pts[0].lng,pts[0].lat],
  zoom:baseZoom,
  pitch:55,
  bearing:0,
  antialias:true
});

map.dragPan.disable();
map.scrollZoom.disable();
map.doubleClickZoom.disable();

map.on("load",()=>{
  map.addSource("route",{type:"geojson",data:{
    type:"Feature",
    geometry:{type:"LineString",coordinates:pts.map(p=>[p.lng,p.lat])}
  }});
  map.addLayer({
    id:"route",
    type:"line",
    source:"route",
    paint:{
      "line-color":settings.primary_color||"#d31c1c",
      "line-width":4
    }
  });

  animate(map,pts,sprite,settings,{baseZoom});
});
}

function animate(map,pts,sprite,settings,theme){
const frames=+settings.travelboost_sprite_frames||5;
const fps=+settings.travelboost_sprite_fps||14;
const size=+settings.travelboost_sprite_size||128;
const speed=(+settings.travelboost_speed||.1)*18;

const cum=[0];
for(let i=1;i<pts.length;i++)cum[i]=cum[i-1]+dist(pts[i-1],pts[i]);
const total=cum.at(-1);

let m=0,last=0,camBearing=0;
let finished=false,finishStart=0,boundsShown=false;

function getPos(d){
  let i=cum.findIndex(v=>v>=d);i=Math.max(1,i);
  const t=(d-cum[i-1])/(cum[i]-cum[i-1]||1);
  const a=pts[i-1],b=pts[i];
  return {lat:a.lat+(b.lat-a.lat)*t,lng:a.lng+(b.lng-a.lng)*t,i:i-1};
}

function fitBounds(){
  const lats=pts.map(p=>p.lat),lngs=pts.map(p=>p.lng);
  map.fitBounds([[Math.min(...lngs),Math.min(...lats)],
                 [Math.max(...lngs),Math.max(...lats)]],
    {padding:60,pitch:0,bearing:0});
}

function draw(ts){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  const spriteW = sprite.width / frames;
  const frame = Math.floor(ts / 1000 * fps) % frames;

const SANTA_X = window.innerWidth / 2;
const SANTA_Y = window.innerHeight * 0.58;

  ctx.save();
  ctx.translate(
    Math.round(SANTA_X),
    Math.round(SANTA_Y)
  );

  ctx.drawImage(
    sprite,
    frame * spriteW, 0,
    spriteW, sprite.height,
    -size / 2,
    -size / 2,
    size, size
  );

  ctx.restore();
}

 function step(ts){
  if(!last)last=ts;
  const dt=(ts-last)/1000;last=ts;

  if(!finished){
    m+=speed*dt;
    if(m>=total){m=total;finished=true;finishStart=ts;}
  }

  const pos=getPos(m);
  const tgt=bearing(pts[pos.i],pts[pos.i+1]||pts[pos.i]);
  camBearing+=(((tgt-camBearing+540)%360)-180)*.14;

  map.jumpTo({
    center:[pos.lng,pos.lat],
    zoom:theme.baseZoom,
    bearing:camBearing,
    pitch:55
  });

  if(finished&&!boundsShown&&ts-finishStart>4000){
    boundsShown=true;
    fitBounds();
  }

  draw(ts);
  requestAnimationFrame(step);
}
requestAnimationFrame(step);
}
</script>
</body>
</html>
